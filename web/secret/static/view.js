document.addEventListener('DOMContentLoaded',function(){if(document.getElementById('edit-form')){console.log('âš ï¸ edit.html í˜ì´ì§€ì—ì„œ view.js ì‹¤í–‰ ê°ì§€ - ë¬´ì‹œí•©ë‹ˆë‹¤');return;}
console.log('ğŸš€ View page loaded - DOMContentLoaded');const urlParams=new URLSearchParams(window.location.search);const ticketId=urlParams.get('id');console.log('ğŸ” í˜„ì¬ URL:',window.location.href);console.log('ğŸ” URL params:',window.location.search);console.log('ğŸ« Ticket ID from URL:',ticketId);console.log('ğŸ« Ticket ID type:',typeof ticketId);if(!ticketId||ticketId==='null'||ticketId==='undefined'){console.error('âŒ í‹°ì¼“ IDê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ:',ticketId);alert('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ì ‘ê·¼ì…ë‹ˆë‹¤. í‹°ì¼“ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.');window.location.href='/';return;}
console.log('âœ… í‹°ì¼“ ID í™•ì¸ë¨:',ticketId);console.log('ğŸ“ loadContent í˜¸ì¶œ ì‹œì‘');loadContent(ticketId);});async function loadContent(ticketId){console.log('ğŸš€ loadContent í•¨ìˆ˜ ì‹œì‘. Ticket ID:',ticketId);const loadingElement=document.getElementById('loading');const contentElement=document.getElementById('ticket-content');const errorElement=document.getElementById('error');console.log('ğŸ“ DOM ìš”ì†Œ í™•ì¸:',{loading:loadingElement?'ì°¾ìŒ':'ì—†ìŒ',content:contentElement?'ì°¾ìŒ':'ì—†ìŒ',error:errorElement?'ì°¾ìŒ':'ì—†ìŒ',});try{console.log('ğŸ”„ try ë¸”ë¡ ì‹œì‘');if(loadingElement){loadingElement.style.display='block';console.log('âœ… ë¡œë”© í™”ë©´ í‘œì‹œë¨');}
if(contentElement){contentElement.style.display='none';console.log('âœ… ì»¨í…ì¸  ìˆ¨ê¹€');}
if(errorElement){errorElement.style.display='none';console.log('âœ… ì—ëŸ¬ ìˆ¨ê¹€');}
const apiUrl=`/secret/api/v1/tickets/${ticketId}`;console.log('ğŸ“¡ API URL ìƒì„±:',apiUrl);console.log('ğŸŒ fetch ì‹œì‘...');const response=await fetch(apiUrl,{method:'GET',headers:{'Content-Type':'application/json',},credentials:'same-origin',});console.log('ğŸ“¨ fetch ì™„ë£Œ! ì‘ë‹µ ìƒíƒœ:',response.status);console.log('ğŸ“¨ ì‘ë‹µ í—¤ë”ë“¤:',[...response.headers.entries()]);if(!response.ok){if(response.status===401){const errorData=await response.json().catch(()=>({}));console.log('ğŸ” 401 ì—ëŸ¬ - ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ìš”');console.log('   ì—ëŸ¬ ìƒì„¸:',errorData);const fromList=sessionStorage.getItem('password_verified_'+ticketId);if(fromList){console.log('âš ï¸ list.htmlì—ì„œ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í›„ ì˜¨ ê²½ìš° - ì ì‹œ ëŒ€ê¸° í›„ ì¬ì‹œë„');sessionStorage.removeItem('password_verified_'+ticketId);await new Promise(resolve=>setTimeout(resolve,500));return loadContent(ticketId);}
showPasswordForm(ticketId);return;}
const errorText=await response.text();console.error('âŒ API ì—ëŸ¬ ì‘ë‹µ:',response.status,errorText);throw new Error(`HTTP ${response.status}: ${errorText}`);}
console.log('ğŸ“¦ JSON íŒŒì‹± ì‹œì‘...');const data=await response.json();console.log('ğŸ“¦ JSON íŒŒì‹± ì™„ë£Œ:',JSON.stringify(data,null,2));if(data.ticket){console.log('âœ… í‹°ì¼“ ë°ì´í„° ë°œê²¬, displayContent í˜¸ì¶œ');console.log('ğŸ“§ ë©”ì‹œì§€ ë°ì´í„°:',data.messages||[]);displayContent(data.ticket,data.messages||[]);}else{console.error('âŒ data.ticketì´ ì—†ìŒ. ì‘ë‹µ êµ¬ì¡°:',Object.keys(data));throw new Error('í‹°ì¼“ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');}}catch(error){console.error('ğŸ’¥ Error in loadContent:',error);console.error('ğŸ’¥ Error stack:',error.stack);if(error.message.includes('401')){return;}
showError('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: '+error.message);}finally{console.log('ğŸ finally ë¸”ë¡ ì‹¤í–‰');if(loadingElement){loadingElement.style.display='none';console.log('âœ… ë¡œë”© í™”ë©´ ìˆ¨ê¹€ ì™„ë£Œ');}}}
function displayContent(ticket,messages=[]){console.log('ğŸ¨ displayContent í•¨ìˆ˜ ì‹œì‘',JSON.stringify(ticket,null,2));console.log('ğŸ“§ ë°›ì€ ë©”ì‹œì§€ ê°œìˆ˜:',messages.length);if(document.readyState==='loading'){console.warn('âš ï¸ DOMì´ ì•„ì§ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.');setTimeout(()=>displayContent(ticket,messages),100);return;}
const contentElement=document.getElementById('ticket-content');if(!contentElement){console.error('âŒ Content element (ticket-content) not found');console.error('   í˜„ì¬ DOM ìƒíƒœ:',{readyState:document.readyState,body:document.body?'ìˆìŒ':'ì—†ìŒ',container:document.querySelector('.container')?'ìˆìŒ':'ì—†ìŒ',allIds:Array.from(document.querySelectorAll('[id]')).map(el=>el.id)});showError('í˜ì´ì§€ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');return;}
try{console.log('ğŸ« Received ticket data:',ticket);console.log('ğŸ“ author_contact value:',ticket.author_contact);const titleElement=document.getElementById('ticket-title');const authorElement=document.getElementById('ticket-author');const contactElement=document.getElementById('ticket-contact');const contentTextElement=document.getElementById('ticket-body');const createdAtElement=document.getElementById('ticket-date');console.log('ğŸ“ ê°œë³„ ìš”ì†Œ í™•ì¸:',{title:titleElement?'ì°¾ìŒ':'ì—†ìŒ',author:authorElement?'ì°¾ìŒ':'ì—†ìŒ',contact:contactElement?'ì°¾ìŒ':'ì—†ìŒ',content:contentTextElement?'ì°¾ìŒ':'ì—†ìŒ',createdAt:createdAtElement?'ì°¾ìŒ':'ì—†ìŒ',});if(titleElement){titleElement.textContent=ticket.title||'ì œëª© ì—†ìŒ';console.log('âœ… ì œëª© ì„¤ì •:',ticket.title);}
if(authorElement){authorElement.textContent=ticket.author_name||'ì‘ì„±ì ì—†ìŒ';console.log('âœ… ì‘ì„±ì ì„¤ì •:',ticket.author_name);}
if(contactElement){contactElement.textContent=ticket.author_contact||'ì—°ë½ì²˜ ì—†ìŒ';console.log('âœ… ì—°ë½ì²˜ ì„¤ì •:',ticket.author_contact);console.log('ğŸ“ Contact element:',contactElement);console.log('ğŸ“ Contact element content:',contactElement.textContent);}else{console.log('âŒ Contact element not found!');}
if(contentTextElement){contentTextElement.textContent=ticket.content||'ë‚´ìš© ì—†ìŒ';console.log('âœ… ë‚´ìš© ì„¤ì •:',ticket.content);}
if(createdAtElement){const formattedDate=formatDate(ticket.created_at);createdAtElement.textContent=formattedDate;console.log('âœ… ì‘ì„±ì¼ ì„¤ì •:',formattedDate);}
displayMessages(messages);const editDisabledMsg=document.getElementById('edit-disabled-message');const editButton=document.getElementById('edit-button');if(messages&&messages.length>0){if(editDisabledMsg){editDisabledMsg.style.display='block';}
if(editButton){editButton.style.display='none';}}else{if(editDisabledMsg){editDisabledMsg.style.display='none';}
if(editButton){editButton.style.display='block';}}
contentElement.style.display='block';console.log('âœ… ì»¨í…ì¸  ì˜ì—­ í‘œì‹œ');console.log('ğŸ‰ ì»¨í…ì¸  í‘œì‹œ ì™„ë£Œ');}catch(error){console.error('ğŸ’¥ Error displaying content:',error);showError('ì»¨í…ì¸ ë¥¼ í‘œì‹œí•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: '+error.message);}}
function displayMessages(messages){console.log('ğŸ“§ displayMessages í•¨ìˆ˜ ì‹œì‘, ë©”ì‹œì§€ ê°œìˆ˜:',messages.length);const messagesListElement=document.getElementById('messages-list');if(!messagesListElement){console.error('âŒ messages-list ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');return;}
messagesListElement.innerHTML='';if(!messages||messages.length===0){console.log('ğŸ“§ ë©”ì‹œì§€ê°€ ì—†ìŒ - "ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤" í‘œì‹œ');messagesListElement.innerHTML='<div class="no-messages">ì•„ì§ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';return;}
console.log('ğŸ“§ ë©”ì‹œì§€ í‘œì‹œ ì‹œì‘:',messages);messages.forEach((message,index)=>{console.log(`ğŸ“§ ë©”ì‹œì§€ [${index}] ì²˜ë¦¬:`,message);const messageDiv=document.createElement('div');messageDiv.className='admin-message';const messageContent=message.content||message.message_content||message.reply_content||'ë‚´ìš© ì—†ìŒ';const messageDate=message.created_at||message.reply_date||message.created_date||'';const adminName=message.admin_name||message.author_name||'ê´€ë¦¬ì';messageDiv.innerHTML=`
      <div class="admin-message-header">
        <span>ğŸ‘¤ ${adminName}</span>
      </div>
      <div class="admin-message-content">
        ${escapeHtml(messageContent).replace(/\n/g, '<br>')}
      </div>
      ${messageDate ? `<div class="admin-message-date">${formatDate(messageDate)}</div>` : ''}
    `;messagesListElement.appendChild(messageDiv);console.log(`âœ… ë©”ì‹œì§€ [${index}] ì¶”ê°€ ì™„ë£Œ`);});console.log('âœ… ëª¨ë“  ë©”ì‹œì§€ í‘œì‹œ ì™„ë£Œ');}
function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML;}
function showPasswordForm(ticketId){console.log('ğŸ” ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í¼ í‘œì‹œ:',ticketId);const loadingElement=document.getElementById('loading');const passwordFormElement=document.getElementById('password-form');const contentElement=document.getElementById('ticket-content');const errorElement=document.getElementById('error');if(loadingElement){loadingElement.style.display='none';}
if(errorElement){errorElement.style.display='none';}
if(contentElement){contentElement.style.display='none';}
if(passwordFormElement){passwordFormElement.style.display='block';const passwordForm=document.getElementById('passwordForm');if(passwordForm){const newForm=passwordForm.cloneNode(true);passwordForm.parentNode.replaceChild(newForm,passwordForm);newForm.addEventListener('submit',async function(e){e.preventDefault();await verifyPassword(ticketId);});}}else{console.error('âŒ password-form ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');}}
async function verifyPassword(ticketId){console.log('ğŸ” ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì‹œì‘:',ticketId);const passwordInput=document.getElementById('post-password');const password=passwordInput?passwordInput.value:'';if(!password){alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return;}
const passwordFormElement=document.getElementById('password-form');const loadingElement=document.getElementById('loading');if(passwordFormElement){passwordFormElement.style.display='none';}
if(loadingElement){loadingElement.style.display='block';}
try{const response=await fetch(`/secret/api/v1/tickets/${ticketId}/verify`,{method:'POST',headers:{'Content-Type':'application/json',},credentials:'same-origin',body:JSON.stringify({post_password:password})});const data=await response.json();if(response.ok&&data.ok){console.log('âœ… ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì„±ê³µ, í† í° ìƒì„±ë¨');if(passwordInput){passwordInput.value='';}
await loadContent(ticketId);}else{console.error('âŒ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì‹¤íŒ¨:',data.error);alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');if(passwordFormElement){passwordFormElement.style.display='block';}
if(loadingElement){loadingElement.style.display='none';}
if(passwordInput){passwordInput.focus();}}}catch(error){console.error('ğŸ’¥ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì¤‘ ì˜¤ë¥˜:',error);alert('ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);if(passwordFormElement){passwordFormElement.style.display='block';}
if(loadingElement){loadingElement.style.display='none';}}}
function showError(message){console.error('Error:',message);const errorElement=document.getElementById('error');const errorMessageElement=document.getElementById('error-message');const contentElement=document.getElementById('ticket-content');const loadingElement=document.getElementById('loading');if(errorElement){errorElement.style.display='block';}
if(errorMessageElement){errorMessageElement.textContent=message;}
if(contentElement){contentElement.style.display='none';}
if(loadingElement){loadingElement.style.display='none';}}
function formatDate(dateString){if(!dateString)return'';try{let date;if(dateString instanceof Date){date=dateString;}else{let dateStr=String(dateString).trim();if(dateStr.includes(' ')&&!dateStr.includes('T')){dateStr=dateStr.replace(' ','T');}
date=new Date(dateStr);}
if(isNaN(date.getTime())){console.warn('âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ:',dateString);return dateString;}
const formatted=date.toLocaleString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:'Asia/Seoul'});return formatted;}catch(error){console.error('âŒ Date formatting error:',error,'ì›ë³¸:',dateString);return dateString;}}
function goBack(){window.history.back();}
function goToList(){window.location.href='/';}
function editTicket(){const urlParams=new URLSearchParams(window.location.search);const ticketId=urlParams.get('id');if(!ticketId){alert('í‹°ì¼“ IDê°€ ì—†ìŠµë‹ˆë‹¤.');return;}
window.location.href=`/secret/edit?id=${ticketId}`;}