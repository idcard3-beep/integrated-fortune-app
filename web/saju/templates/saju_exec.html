<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>전문가급 사주보기 실전 상담 시스템으로 사주풀이 무료보기 | 정확한 사주분석 - 나라톡톡(naratt.kr) 운세보기</title>
    <meta name="description" content="정확한 생년월일시를 바탕으로 한 만세력 조회와 심층 사주풀이 무료보기로 연애운, 재물운, 직업운을 확인하세요. 나라톡톡에서 정확한 사주분석 서비스를 제공합니다.">
    <meta name="keywords" content="사주풀이, 무료사주, 사주보기, 명리학">
    <link rel="stylesheet" href="{{ url_for('static', filename='saju_style_exec.css') }}" />
    <link
      rel="stylesheet"
      href="{{ url_for('common_static', filename='security.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>전문가급 사주보기 실전 상담 시스템</h1>
        <p class="subtitle">
          격국 · 용신 · 희기신 · 육친 · 사주강약 · 십이운성 · 지장간 · 형충파해
          · 신살 · 납음 분석
        </p>
      </header>

      <div class="input-section">
        <h2>사주 정보 입력</h2>

        
        <div class="input-row-inline">
          <label for="name">성명 (姓名)</label>
          <input
            type="text"
            id="name"
            placeholder="이름을 입력하세요"
            style="flex: 1; font-size: 0.9em"
          />
        </div>

        
        <div class="input-row-inline">
          <label>성별 (性別)</label>
          <div class="radio-group" style="flex: 1; display: flex; gap: 20px">
            <label class="radio-label">
              <input type="radio" name="gender" value="male" checked />
              <span>남자 (乾命)</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="gender" value="female" />
              <span>여자 (坤命)</span>
            </label>
          </div>
        </div>

        
        <div class="input-row-inline">
          <label>역법 (曆法)</label>
          <div class="radio-group" style="flex: 1; display: flex; gap: 20px; align-items: center;">
            <label class="radio-label">
              <input type="radio" name="calendar" value="solar" checked />
              <span>양력 (陽曆)</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="calendar" value="lunar" />
              <span>음력 (陰曆)</span>
            </label>
            
            <label class="checkbox-label" id="yundal-section" style="display: none; margin-left: 10px;">
              <input type="checkbox" id="yundal" name="yundal" />
              <span>윤달 (閏月)</span>
            </label>
          </div>
        </div>

        
        <div
          class="input-row-inline"
          style="gap: 0; display: flex; align-items: center"
        >
          <label style="margin: 0; padding-right: 33px"
            >생년월일 (年月日)</label
          >
          <input
            type="number"
            id="year"
            placeholder="1990"
            min="1900"
            max="2100"
            style="width: 30px; margin: 0; padding: 8px 6px"
          />
          <label style="margin: 0; padding-left: 10px; padding-right: 8px"
            >년(年)</label
          >
          <input
            type="number"
            id="month"
            placeholder="1-12"
            min="1"
            max="12"
            style="width: 30px; margin: 0; padding: 8px 6px"
          />
          <label style="margin: 0; padding-left: 10px; padding-right: 8px"
            >월(月)</label
          >
          <input
            type="number"
            id="day"
            placeholder="1-31"
            min="1"
            max="31"
            style="width: 30px; margin: 0; padding: 8px 6px"
          />
          <label style="margin: 0; padding-left: 10px; padding-right: 8px"
            >일(日)</label
          >
        </div>

        
        <div class="input-row-inline">
          <label>출생시각 입력 방식</label>
          <div class="radio-group" style="flex: 1; display: flex; gap: 20px">
            <label class="radio-label">
              <input type="radio" name="timeInputType" value="time" checked />
              <span>시각 입력</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="timeInputType" value="ganji" />
              <span>간지 입력</span>
            </label>
          </div>
        </div>

        
        <div id="time-input-section" class="time-input-section">
          <div class="input-row-inline">
            <label>출생시각 (時刻)</label>
            <input
              type="number"
              id="hour"
              placeholder="시 (0-23)"
              min="0"
              max="23"
              style="width: 50px"
            />
            <span style="margin: 0 3px; font-size: 1.2em; font-weight: 700"
              >:</span
            >
            <input
              type="number"
              id="minute"
              placeholder="분 (0-59)"
              min="0"
              max="59"
              style="width: 50px"
            />
            <span style="margin-left: 10px; font-size: 0.9em; color: #666"
              >24시간 형식 (예: 오후 3시 30분 = 15:30)</span
            >
          </div>
        </div>

        
        <div
          id="ganji-input-section"
          class="ganji-input-section"
          style="display: none"
        >
          <label>출생 시주 (時柱)</label>
          <select id="hour-ji-select" class="ganji-select">
            <option value="">시주를 선택하세요</option>
            <option value="子-夜">
              夜子時 (23:30~00:29) - 밤 11시 30분 ~ 자정 29분
            </option>
            <option value="子-朝">
              朝子時 (00:30~01:29) - 자정 30분 ~ 새벽 1시 29분
            </option>
            <option value="子">
              子時 (23:30~01:29) - 밤 11시 30분 ~ 새벽 1시 29분
            </option>
            <option value="丑">
              丑時 (01:30~03:29) - 새벽 1시 30분 ~ 3시 29분
            </option>
            <option value="寅">
              寅時 (03:30~05:29) - 새벽 3시 30분 ~ 5시 29분
            </option>
            <option value="卯">
              卯時 (05:30~07:29) - 새벽 5시 30분 ~ 7시 29분
            </option>
            <option value="辰">
              辰時 (07:30~09:29) - 아침 7시 30분 ~ 9시 29분
            </option>
            <option value="巳">
              巳時 (09:30~11:29) - 오전 9시 30분 ~ 11시 29분
            </option>
            <option value="午">
              午時 (11:30~13:29) - 낮 11시 30분 ~ 오후 1시 29분
            </option>
            <option value="未">
              未時 (13:30~15:29) - 오후 1시 30분 ~ 3시 29분
            </option>
            <option value="申">
              申時 (15:30~17:29) - 오후 3시 30분 ~ 5시 29분
            </option>
            <option value="酉">
              酉時 (17:30~19:29) - 오후 5시 30분 ~ 7시 29분
            </option>
            <option value="戌">
              戌時 (19:30~21:29) - 저녁 7시 30분 ~ 9시 29분
            </option>
            <option value="亥">
              亥時 (21:30~23:29) - 밤 9시 30분 ~ 11시 29분
            </option>
            <option value="미상">時未詳 (시각을 모름)</option>
          </select>
          <div class="input-help">
            출생 시간을 정확히 모르시면 '時未詳'을 선택하세요
          </div>
        </div>

        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <button class="analyze-btn" id="analyze-btn">🔮 사주보기</button>
          <button class="analyze-btn" id="db-save-btn" style="background-color: #ffc107; border-color: #ffc107; color: #000;">💾 DB저장</button>
          <button class="analyze-btn" id="send-btn" style="background-color: #17a2b8; border-color: #17a2b8;">📤 보내기</button>
          <button class="analyze-btn" id="db-view-btn" style="background-color: #28a745; border-color: #28a745;">📊 DB보기</button>
        </div>

        
        
        
        
        
        
        
        
        
        
      </div>

      <div id="result-section" class="result-section hidden">
        
        <section class="analysis-section">
          
          
          
          <div class="pillars-container">
            <div class="pillar-card">
              <div class="pillar-title">時柱 (시주)</div>
              <div class="pillar-content">
                <div class="sipseong-label" id="hour-gan-sipseong"></div>
                <div class="gan-box" id="hour-gan"></div>
                <div class="ji-box" id="hour-ji"></div>
                <div class="sipseong-label" id="hour-ji-sipseong"></div>
                <div class="sibiun-box" id="hour-sibiun"></div>
              </div>
              <div class="napeum-info" id="hour-napeum"></div>
              <div class="gongmang-info" id="hour-gongmang"></div>
              <div class="pillar-desc">말년·자식·55세 이후</div>
            </div>
            <div class="pillar-card highlight-day">
              <div class="pillar-title">日柱 (일주) ⭐</div>
              <div class="pillar-content">
                <div class="sipseong-label" id="day-gan-sipseong"></div>
                <div class="gan-box" id="day-gan"></div>
                <div class="ji-box" id="day-ji"></div>
                <div class="sipseong-label" id="day-ji-sipseong"></div>
                <div class="sibiun-box" id="day-sibiun"></div>
              </div>
              <div class="napeum-info" id="day-napeum"></div>
              <div class="gongmang-info" id="day-gongmang"></div>
              <div class="pillar-desc">본인·배우자·33-55세</div>
            </div>
            <div class="pillar-card">
              <div class="pillar-title">月柱 (월주)</div>
              <div class="pillar-content">
                <div class="sipseong-label" id="month-gan-sipseong"></div>
                <div class="gan-box" id="month-gan"></div>
                <div class="ji-box" id="month-ji"></div>
                <div class="sipseong-label" id="month-ji-sipseong"></div>
                <div class="sibiun-box" id="month-sibiun"></div>
              </div>
              <div class="napeum-info" id="month-napeum"></div>
              <div class="gongmang-info" id="month-gongmang"></div>
              <div class="pillar-desc">부모·직장·17-33세</div>
            </div>
            <div class="pillar-card">
              <div class="pillar-title">年柱 (년주)</div>
              <div class="pillar-content">
                <div class="sipseong-label" id="year-gan-sipseong"></div>
                <div class="gan-box" id="year-gan"></div>
                <div class="ji-box" id="year-ji"></div>
                <div class="sipseong-label" id="year-ji-sipseong"></div>
                <div class="sibiun-box" id="year-sibiun"></div>
              </div>
              <div class="napeum-info" id="year-napeum"></div>
              <div class="gongmang-info" id="year-gongmang"></div>
              <div class="pillar-desc">조상·어린시절·1-17세</div>
            </div>
          </div>

          
          <div
            id="pillar-element-summary"
            style="
              margin-top: 8px;
              padding: 8px;
              background: #f8f9fa;
              border-radius: 6px;
              text-align: center;
              font-size: 0.9em;
              font-weight: 600;
              color: #333;
            "
          ></div>
        </section>

        
        <section class="analysis-section">
          <div class="analysis-card full-width">
            
            
            
            <div id="daeun-chart" class="daeun-chart"></div>
            <div id="daeun-summary"></div>
          </div>
        </section>

        
        <section class="analysis-section">
          <h2 class="section-title">🎯 2.日干 (일간)</h2>
          <div class="analysis-card critical-card">
            <div id="daymaster-analysis"></div>
          </div>
        </section>

        
        <section class="analysis-section">
          <h2 class="section-title">⚖️ 3.四柱强弱 (사주 강약)</h2>
          <div class="analysis-card critical-card">
            <div id="strength-analysis"></div>
          </div>
        </section>

        
        <section class="analysis-section">
          <h2 class="section-title">👑 4.格局 (격국)</h2>
          <div class="analysis-card important-card">
            <div id="gyeokguk-analysis"></div>
          </div>
        </section>

        
        <section class="analysis-section">
          <h2 class="section-title">🔑 5.用神·喜神·忌神 (용신·희신·기신)</h2>
          <div class="analysis-card critical-card">
            <div id="yongsin-analysis"></div>
          </div>
        </section>

        <div class="analysis-grid">
          
          <div class="analysis-card">
            <h3>📊 6.五行 (오행) 분포도</h3>
            <div id="element-chart" class="element-chart"></div>
            <div id="element-summary" class="element-summary"></div>
          </div>

          
          <div class="analysis-card">
            <h3>☯️ 7.陰陽 (음양) 균형</h3>
            <div id="yinyang-chart" class="yinyang-chart"></div>
            <div id="yinyang-summary" class="yinyang-summary"></div>
          </div>

          
          <div class="analysis-card full-width">
            <h3>🌿 8.地藏干 (지장간)</h3>
            <div id="jijanggan-analysis" class="jijanggan-analysis"></div>
          </div>

          
          <div class="analysis-card full-width">
            <h3>⭐ 9.十星 (십성)</h3>
            <div id="sipseong-analysis" class="sipseong-analysis"></div>
            <div id="sipseong-summary" class="sipseong-summary"></div>
          </div>

          
          <div class="analysis-card full-width">
            <h3>🔄 10.十二運星 (십이운성)</h3>
            <div id="sibiun-detail-analysis"></div>
          </div>

          
          <div class="analysis-card full-width important-card">
            <h3>👨‍👩‍👧‍👦 11.六親 (육친) - 인간관계</h3>
            <div id="yukchin-analysis"></div>
          </div>

          
          <div class="analysis-card full-width">
            <h3>🤝 12.合 (합)</h3>
            <div id="hap-analysis"></div>
          </div>

          
          <div class="analysis-card full-width warning-card">
            <h3>⚡ 13.刑沖破害 (형충파해)</h3>
            <div id="hyungchung-analysis"></div>
          </div>

          
          <div class="analysis-card full-width">
            <h3>✨ 14.신살(神殺) - 특수 길흉</h3>
            <div id="sinsal-analysis"></div>
          </div>

          
          <div class="analysis-card full-width">
            <h3>🔮 21.十二神殺 (십이신살)</h3>
            <div id="sibi-sinsal-analysis"></div>
          </div>

          
          <div class="analysis-card full-width">
            <h3>🌟 22.吉神類 (길신류)</h3>
            <div id="gilsin-analysis"></div>
          </div>

          
          <div class="analysis-card full-width">
            <h3>⭐ 23.其他神殺 (그외 신살)</h3>
            <div id="extra-sinsal-analysis"></div>
          </div>

          
          <div class="analysis-card full-width">
            <h3>🕳️ 15.공망(空亡)</h3>
            <div id="gongmang-detail-analysis"></div>
          </div>

          
          <div class="analysis-card full-width">
            <h3>🔮 16.특수 신살</h3>
            <div id="special-sinsal-analysis"></div>
          </div>

          
          <div class="analysis-card full-width">
            <h3>📅 18.歲運 (세운)/ 17.大運 (대운) 흐름(위에참조)</h3>
            <div id="sewun-analysis"></div>
          </div>

          
          <div class="analysis-card full-width final-card">
            <h3>📖 19.綜合命理 (종합 명리)</h3>
            <div id="comprehensive-analysis"></div>
          </div>

          
          <div class="analysis-card full-width action-card">
            <h3>🎁 20.개운(開運) 방법 및 실천 사항</h3>
            <div id="gaewun-guide"></div>
          </div>
        </div>


        <section id="resultWrap" class="card result-card hidden">
          <div id="sajuDisplay" class="saju-grid"></div>
          <div id="gwaeBlock" class="gwae-block"></div>
          <div id="disclaimer" class="disclaimer">
            
            <h2>사주풀이 무료보기</h2>
            <p>
            ※ 사주풀이는 태어난 연·월·일·시를 기준으로 오행과 십성을 분석하여
            인생의 흐름과 운세를 해석하는 동양 명리학입니다.
            </p>
            <p>
            ※ 나라톡톡 사주풀이는 초보자도 이해하기 쉽게 풀이를 제공합니다.
            </p>
            ※ 사주풀이는 참고자료입니다. 실제 선택과 노력이 더 중요합니다.
            盡人事待天命
          </div>
        </section>    


      </div>
    </div>
        
    

    <script></script>
    <script></script>
    <script></script>

    
    <script></script>
    
    <script></script>
    
    <script>
      
      console.log('🔧 서버 세션 초기화 시작');
      {% if member_session %}
      console.log('✅ member_session 존재:', {{ member_session | tojson }});
      if (typeof setMemberSession === 'function') {
        setMemberSession({{ member_session | tojson }});
        console.log('✅ setMemberSession 호출 완료');
      } else {
        console.error('❌ setMemberSession 함수를 찾을 수 없습니다.');
      }
      {% else %}
      console.log('⚠️ member_session이 서버에서 전달되지 않았습니다.');
      console.log('   - 회원 로그인을 하셨다면, 다른 탭에서 로그인하신 것일 수 있습니다.');
      console.log('   - 이 페이지를 새로고침(F5) 해보세요.');
      {% endif %}
      {% if admin_session %}
      if (typeof setAdminSession === 'function') {
        setAdminSession({{ admin_session | tojson }});
      }
      {% endif %}
    </script>
    
    <script></script>
    <script>
      
      let currentTicketId = null;
      
      
      function getTicketIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        let ticketId = urlParams.get('ticket_id');
        
        
        if (!ticketId) {
          const pendingTicketId = sessionStorage.getItem('pendingTicketId');
          if (pendingTicketId) {
            console.log('   📋 pendingTicketId 발견:', pendingTicketId);
            ticketId = pendingTicketId;
            sessionStorage.removeItem('pendingTicketId');
          }
        }
        
        return ticketId;
      }
      
      
      window.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 DOMContentLoaded - 페이지 초기화 시작');
        
        const ticketId = getTicketIdFromUrl();
        console.log('   - ticket_id:', ticketId);
        
        const returnAfterLogin = sessionStorage.getItem('returnAfterLogin');
        const hasSajuFormData = sessionStorage.getItem('sajuFormData');
        console.log('   - returnAfterLogin:', returnAfterLogin);
        console.log('   - hasSajuFormData:', hasSajuFormData ? 'YES' : 'NO');
        
        if (ticketId) {
          currentTicketId = ticketId;
          console.log('✅ ticket_id 존재 - 티켓 데이터 로드:', currentTicketId);
          
          
          window['loadTicketData'](ticketId);
        } else if (returnAfterLogin === 'true' && hasSajuFormData) {
          
          console.log('🔄 로그인 후 돌아옴 - 데이터 복원만 수행');
          
          
          setTimeout(() => {
            console.log('⏰ 데이터 복원 실행');
            
            
            const restored = restoreFormData();
            
            if (restored) {
              console.log('✅ 데이터 복원 완료');
              console.log('ℹ️  이제 로그인된 상태이므로 원하는 버튼을 클릭하세요.');
              
              
              sessionStorage.removeItem('returnAfterLogin');
              
              
              alert('✅ 로그인 성공!\n\n입력하신 데이터가 복원되었습니다.\n"사주보기" 버튼을 클릭하여 다시 분석하신 후\n원하는 작업(DB저장, 보내기, DB보기)을 수행하세요.');
            } else {
              console.error('❌ 데이터 복원 실패');
              sessionStorage.removeItem('returnAfterLogin');
              sessionStorage.removeItem('sajuFormData');
            }
          }, 500);
        } else if (hasSajuFormData && !ticketId) {
          
          console.log('🔄 로그인 취소 후 돌아옴 - 데이터 복원 수행');
          
          setTimeout(() => {
            console.log('⏰ 데이터 복원 실행 (취소 후 복귀)');
            
            const restored = restoreFormData();
            
            if (restored) {
              console.log('✅ 데이터 복원 완료 (취소 후 복귀)');
              
            } else {
              console.error('❌ 데이터 복원 실패');
              sessionStorage.removeItem('sajuFormData');
            }
          }, 300);
        } else {
          console.log('ℹ️ 일반 페이지 로드 (복원 없음)');
        }
      });
      
      
      async function loadTicketData(ticketId) {
        try {
          console.log('🔄 티켓 데이터 로드 시작:', ticketId);
          const response = await fetch(`/secret/api/v1/tickets/${ticketId}`);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
            const result = await response.json();
            console.log('📦 API 응답:', result);
            console.log('📦 API 응답 (JSON):', JSON.stringify(result, null, 2));
            
            if (result.ok && result.ticket) {
              const ticket = result.ticket;
              console.log('📋 티켓 데이터:', ticket);
              console.log('📋 티켓 데이터 (상세):', {
                author_name: ticket.author_name,
                birth_datetime: ticket.birth_datetime,
                birth_hour: ticket.birth_hour,
                birth_minute: ticket.birth_minute,
                calendar_type: ticket.calendar_type,
                yundal: ticket.yundal,
                author_gender: ticket.author_gender,
                hour_ji: ticket.hour_ji
              });
            
            
            console.log('1️⃣ 성명 설정:', ticket.author_name);
            const nameInput = document.getElementById('name');
            if (nameInput) {
              nameInput.value = ticket.author_name || '';
              console.log('   ✅ 성명 입력 완료:', nameInput.value);
            } else {
              console.error('   ❌ name 입력 필드를 찾을 수 없습니다.');
            }
            
            
            console.log('2️⃣ 생년월일 설정:', ticket.birth_datetime, '(타입:', typeof ticket.birth_datetime, ')');
            if (ticket.birth_datetime) {
              
              const birthDate = new Date(ticket.birth_datetime);
              
              
              if (isNaN(birthDate.getTime())) {
                console.error('   ❌ birth_datetime 파싱 실패:', ticket.birth_datetime);
              } else {
                const yearInput = document.getElementById('year');
                const monthInput = document.getElementById('month');
                const dayInput = document.getElementById('day');
                
                if (yearInput) {
                  yearInput.value = birthDate.getFullYear();
                  console.log('   ✅ 년도:', yearInput.value);
                } else {
                  console.error('   ❌ year 입력 필드를 찾을 수 없습니다.');
                }
                
                if (monthInput) {
                  monthInput.value = birthDate.getMonth() + 1;
                  console.log('   ✅ 월:', monthInput.value);
                } else {
                  console.error('   ❌ month 입력 필드를 찾을 수 없습니다.');
                }
                
                if (dayInput) {
                  dayInput.value = birthDate.getDate();
                  console.log('   ✅ 일:', dayInput.value);
                } else {
                  console.error('   ❌ day 입력 필드를 찾을 수 없습니다.');
                }
              }
            } else {
              console.warn('   ⚠️ birth_datetime 없음');
            }
            
            
            console.log('3️⃣ 시간 설정:', ticket.birth_hour);
            if (ticket.birth_hour !== null && ticket.birth_hour !== undefined) {
              const hourInput = document.getElementById('hour');
              if (hourInput) {
                hourInput.value = ticket.birth_hour;
                console.log('   ✅ 시간:', hourInput.value);
              } else {
                console.error('   ❌ hour 입력 필드를 찾을 수 없습니다.');
              }
            } else {
              console.warn('   ⚠️ birth_hour 없음');
            }
            
            
            console.log('4️⃣ 분 설정:', ticket.birth_minute);
            if (ticket.birth_minute !== null && ticket.birth_minute !== undefined) {
              const minuteInput = document.getElementById('minute');
              if (minuteInput) {
                minuteInput.value = ticket.birth_minute;
                console.log('   ✅ 분:', minuteInput.value);
              } else {
                console.error('   ❌ minute 입력 필드를 찾을 수 없습니다.');
              }
            } else {
              console.warn('   ⚠️ birth_minute 없음');
            }
            
            
            console.log('5️⃣ 역법 설정:', ticket.calendar_type);
            if (ticket.calendar_type) {
              
              const isLunar = ticket.calendar_type === '음력' || ticket.calendar_type === 'LUNAR' || ticket.calendar_type === 'lunar';
              const calendarValue = isLunar ? 'lunar' : 'solar';
              
              const calendarRadio = document.querySelector(`input[name="calendar"][value="${calendarValue}"]`);
              if (calendarRadio) {
                calendarRadio.checked = true;
                console.log('   ✅ 역법:', calendarValue);
                
                
                if (isLunar) {
                  const yundalSection = document.getElementById('yundal-section');
                  if (yundalSection) {
                    yundalSection.style.display = 'block';
                    console.log('   ✅ 윤달 섹션 표시');
                  }
                  
                  
                  console.log('6️⃣ 윤달 설정:', ticket.yundal, '(타입:', typeof ticket.yundal, ')');
                  
                  if (ticket.yundal === true || ticket.yundal === 'Y' || ticket.yundal === 1) {
                    const yundalCheck = document.getElementById('yundal');
                    if (yundalCheck) {
                      yundalCheck.checked = true;
                      console.log('   ✅ 윤달 체크됨');
                    } else {
                      console.error('   ❌ yundal 체크박스를 찾을 수 없습니다.');
                    }
                  }
                }
              } else {
                console.error('   ❌ calendar 라디오 버튼을 찾을 수 없습니다.');
              }
            } else {
              console.warn('   ⚠️ calendar_type 없음');
            }
            
            
            console.log('7️⃣ 성별 설정:', ticket.author_gender);
            if (ticket.author_gender) {
              const genderValue = ticket.author_gender === 'M' ? 'male' : 'female';
              const genderRadio = document.querySelector(`input[name="gender"][value="${genderValue}"]`);
              if (genderRadio) {
                genderRadio.checked = true;
                console.log('   ✅ 성별:', genderValue);
              } else {
                console.error('   ❌ gender 라디오 버튼을 찾을 수 없습니다.');
              }
            } else {
              console.warn('   ⚠️ author_gender 없음');
            }
            
            
            console.log('8️⃣ 시주 설정:', ticket.hour_ji);
            if (ticket.hour_ji && ticket.hour_ji.trim() !== '') {
              
              console.log('   📍 hour_ji 값 있음 → 간지입력 모드로 전환');
              
              
              const ganjiRadio = document.querySelector('input[name="timeInputType"][value="ganji"]');
              if (ganjiRadio) {
                ganjiRadio.checked = true;
                console.log('   ✅ 시각 입력 방식: 간지 입력 체크');
                
                
                const timeInputSection = document.getElementById('time-input-section');
                const ganjiInputSection = document.getElementById('ganji-input-section');
                if (timeInputSection) {
                  timeInputSection.style.display = 'none';
                  console.log('   ✅ 시각 입력 필드 숨김');
                }
                if (ganjiInputSection) {
                  ganjiInputSection.style.display = 'block';
                  console.log('   ✅ 간지 입력 필드 표시');
                }
              } else {
                console.error('   ❌ 간지 입력 라디오 버튼을 찾을 수 없습니다.');
              }
              
              
              const hourJiSelect = document.getElementById('hour-ji-select');
              if (hourJiSelect) {
                hourJiSelect.value = ticket.hour_ji;
                console.log('   ✅ 시주 선택:', hourJiSelect.value);
              } else {
                console.error('   ❌ hour-ji-select를 찾을 수 없습니다.');
              }
            } else {
              
              console.log('   📍 hour_ji 값 없음 → 시각입력 모드 유지');
              
              
              const timeRadio = document.querySelector('input[name="timeInputType"][value="time"]');
              if (timeRadio) {
                timeRadio.checked = true;
                console.log('   ✅ 시각 입력 방식: 시각 입력 체크');
                
                
                const timeInputSection = document.getElementById('time-input-section');
                const ganjiInputSection = document.getElementById('ganji-input-section');
                if (timeInputSection) {
                  timeInputSection.style.display = 'block';
                  console.log('   ✅ 시각 입력 필드 표시');
                }
                if (ganjiInputSection) {
                  ganjiInputSection.style.display = 'none';
                  console.log('   ✅ 간지 입력 필드 숨김');
                }
              } else {
                console.error('   ❌ 시각 입력 라디오 버튼을 찾을 수 없습니다.');
              }
            }
            
            console.log('✅ 티켓 데이터 로드 완료');
            console.log('📊 로드된 데이터 요약:', {
              성명: ticket.author_name,
              생년월일: ticket.birth_datetime,
              시간: ticket.birth_hour,
              분: ticket.birth_minute,
              역법: ticket.calendar_type,
              윤달: ticket.yundal,
              성별: ticket.author_gender,
              시주: ticket.hour_ji
            });
            
            
            console.log('9️⃣ 자동 사주 분석 준비');
            setTimeout(() => {
              console.log('🔮 자동으로 사주 분석 실행');
              const analyzeBtn = document.getElementById('analyze-btn');
              if (analyzeBtn) {
                analyzeBtn.click();
                console.log('✅ 사주보기 버튼 클릭 완료');
              } else {
                console.error('❌ 사주보기 버튼을 찾을 수 없습니다.');
              }
            }, 800); 
          } else {
            console.error('❌ 티켓 데이터를 찾을 수 없습니다:', result);
            alert('티켓 데이터를 찾을 수 없습니다.\n\n응답: ' + JSON.stringify(result, null, 2));
          }
        } catch (error) {
          console.error('❌ 티켓 데이터 로드 오류:', error);
          console.error('   스택:', error.stack);
          alert('데이터를 불러오는데 실패했습니다.\n\n오류: ' + error.message);
        }
      }
      
      window['loadTicketData'] = loadTicketData;
      
      
      
      
      function checkMemberLogin() {
        let memberId = null;
        
        console.log('🔍 회원 로그인 체크 시작 ============');
        console.log('   🌐 현재 환경:', window.location.hostname);
        console.log('   📍 URL:', window.location.href);
        
        
        console.log('   1️⃣ window.MEMBER_SESSION 확인:', window.MEMBER_SESSION);
        if (window.MEMBER_SESSION) {
          console.log('      - typeof:', typeof window.MEMBER_SESSION);
          console.log('      - keys:', Object.keys(window.MEMBER_SESSION));
          console.log('      - sMem_id:', window.MEMBER_SESSION.sMem_id);
          console.log('      - isLoggedIn:', window.MEMBER_SESSION.isLoggedIn);
          
          if (window.MEMBER_SESSION.sMem_id) {
            memberId = window.MEMBER_SESSION.sMem_id;
            console.log('   ✅ MEMBER_SESSION에서 회원 ID 확인:', memberId);
            console.log('🔄 checkMemberLogin 함수 종료 - 반환값:', memberId);
            console.log('=====================================');
            return memberId;
          } else {
            console.log('   ⚠️ MEMBER_SESSION은 있지만 sMem_id가 없음');
          }
        } else {
          console.log('   ⚠️ window.MEMBER_SESSION이 없음 (undefined 또는 null)');
        }
        
        
        console.log('   2️⃣ sessionStorage 확인...');
        try {
          const storedSession = sessionStorage.getItem('memberSession');
          console.log('      - sessionStorage.memberSession:', storedSession);
          if (storedSession) {
            const sessionData = JSON.parse(storedSession);
            console.log('      - 파싱된 데이터:', sessionData);
            if (sessionData && sessionData.sMem_id) {
              memberId = sessionData.sMem_id;
              console.log('   ✅ sessionStorage에서 회원 ID 확인:', memberId);
              console.log('🔄 checkMemberLogin 함수 종료 - 반환값:', memberId);
              console.log('=====================================');
              return memberId;
            }
          }
        } catch (e) {
          console.error('   ❌ sessionStorage 파싱 오류:', e);
        }
        
        
        console.log('   3️⃣ 전역변수 확인...');
        console.log('      - window.sMem_id:', typeof window.sMem_id, window.sMem_id);
        console.log('      - sMem_id:', typeof sMem_id !== 'undefined' ? sMem_id : 'undefined');
        
        if (typeof window.sMem_id !== 'undefined' && window.sMem_id) {
          memberId = window.sMem_id;
          console.log('   ✅ window.sMem_id에서 회원 ID 확인:', memberId);
        } else if (typeof sMem_id !== 'undefined' && sMem_id) {
          memberId = sMem_id;
          console.log('   ✅ 전역 sMem_id에서 회원 ID 확인:', memberId);
        } else {
          console.log('   ⚠️ 전역변수에서도 회원 ID를 찾을 수 없음');
        }
        
        console.log('🔄 checkMemberLogin 함수 종료 - 최종 반환값:', memberId);
        console.log('=====================================');
        return memberId;
      }
      
      window['checkMemberLogin'] = checkMemberLogin;
      (function(fn) { window['checkMemberLogin'] = fn; })(checkMemberLogin);
      
      
      
      
      function saveFormData() {
        const formData = {
          
          name: document.getElementById('name')?.value || '',
          year: document.getElementById('year')?.value || '',
          month: document.getElementById('month')?.value || '',
          day: document.getElementById('day')?.value || '',
          hour: document.getElementById('hour')?.value || '',
          minute: document.getElementById('minute')?.value || '',
          calendar: document.querySelector('input[name="calendar"]:checked')?.value || 'solar',
          yundal: document.getElementById('yundal')?.checked || false,
          gender: document.querySelector('input[name="gender"]:checked')?.value || 'male',
          hourJi: document.getElementById('hour-ji-select')?.value || ''
        };
        
        sessionStorage.setItem('sajuFormData', JSON.stringify(formData));
        console.log('💾 입력 데이터 저장 완료 (사주 결과는 제외):', formData);
      }
      
      window['saveFormData'] = saveFormData;
      
      
      function restoreFormData() {
        const savedData = sessionStorage.getItem('sajuFormData');
        if (!savedData) {
          console.log('⚠️ 저장된 데이터 없음');
          return false;
        }
        
        try {
          const formData = JSON.parse(savedData);
          console.log('📥 입력 데이터 복원 시작:', formData);
          
          
          if (formData.name) document.getElementById('name').value = formData.name;
          if (formData.year) document.getElementById('year').value = formData.year;
          if (formData.month) document.getElementById('month').value = formData.month;
          if (formData.day) document.getElementById('day').value = formData.day;
          if (formData.hour) document.getElementById('hour').value = formData.hour;
          if (formData.minute) document.getElementById('minute').value = formData.minute;
          
          
          const calendarRadio = document.querySelector(`input[name="calendar"][value="${formData.calendar}"]`);
          if (calendarRadio) calendarRadio.checked = true;
          
          const genderRadio = document.querySelector(`input[name="gender"][value="${formData.gender}"]`);
          if (genderRadio) genderRadio.checked = true;
          
          
          if (formData.yundal) document.getElementById('yundal').checked = true;
          
          
          if (formData.hourJi) document.getElementById('hour-ji-select').value = formData.hourJi;
          
          console.log('✅ 입력 데이터 복원 완료 (사주 결과는 제외 - 사주보기 버튼을 클릭하세요)');
          
          return true;
        } catch (error) {
          console.error('❌ 데이터 복원 오류:', error);
          return false;
        }
      }
      
      window['restoreFormData'] = restoreFormData;
      
      
      function checkSajuResult() {
        
        const resultWrap = document.getElementById('resultWrap');
        if (!resultWrap || resultWrap.classList.contains('hidden')) {
          console.log('❌ resultWrap이 숨겨져 있음');
          return false;
        }
        
        
        const dayGan = document.getElementById('day-gan');
        if (!dayGan || !dayGan.textContent.trim()) {
          console.log('❌ 일주(day-gan)가 비어있음');
          return false;
        }
        
        
        const dayJi = document.getElementById('day-ji');
        if (!dayJi || !dayJi.textContent.trim()) {
          console.log('❌ 일지(day-ji)가 비어있음');
          return false;
        }
        
        console.log('✅ 사주 분석 결과 확인: day-gan =', dayGan.textContent, ', day-ji =', dayJi.textContent);
        return true;
      }
      
      window['checkSajuResult'] = checkSajuResult;
      (function(fn) { window['checkSajuResult'] = fn; })(checkSajuResult);
      
      window['_checkSajuResult'] = (function() { return checkSajuResult; })();
      
      
      
      
      function redirectToLogin(message) {
        
        saveFormData();
        console.log('💾 현재 화면 데이터 저장 완료');
        
        if (confirm(message + '\n\n로그인 페이지로 이동하시겠습니까?')) {
          
          sessionStorage.setItem('returnUrl', window.location.href);
          sessionStorage.setItem('returnAfterLogin', 'true');
          
          console.log('🔄 로그인 페이지로 이동');
          window.location.href = '/secret/member_login.html';
        } else {
          console.log('❌ 사용자가 로그인 이동을 취소함 (데이터는 저장됨)');
        }
      }
      
      window['redirectToLogin'] = redirectToLogin;
      
      
      
      
      
      
      setTimeout(function() {
        console.log('🚨 강제 함수 등록 시작 (3초 후)...');
        
        
        console.log('   - checkSajuResult 정의됨:', typeof checkSajuResult);
        console.log('   - checkMemberLogin 정의됨:', typeof checkMemberLogin);
        
        
        if (typeof checkSajuResult !== 'undefined') {
          window['checkSajuResult'] = checkSajuResult;
          console.log('   ✅ checkSajuResult 강제 등록 완료');
        }
        if (typeof checkMemberLogin !== 'undefined') {
          window['checkMemberLogin'] = checkMemberLogin;
          console.log('   ✅ checkMemberLogin 강제 등록 완료');
        }
        if (typeof redirectToLogin !== 'undefined') {
          window['redirectToLogin'] = redirectToLogin;
          console.log('   ✅ redirectToLogin 강제 등록 완료');
        }
        if (typeof saveFormData !== 'undefined') {
          window['saveFormData'] = saveFormData;
          console.log('   ✅ saveFormData 강제 등록 완료');
        }
        if (typeof restoreFormData !== 'undefined') {
          window['restoreFormData'] = restoreFormData;
          console.log('   ✅ restoreFormData 강제 등록 완료');
        }
        if (typeof loadTicketData !== 'undefined') {
          window['loadTicketData'] = loadTicketData;
          console.log('   ✅ loadTicketData 강제 등록 완료');
        }
        if (typeof generateSajuShareText !== 'undefined') {
          window['generateSajuShareText'] = generateSajuShareText;
          console.log('   ✅ generateSajuShareText 강제 등록 완료');
        }
        if (typeof showShareOptions !== 'undefined') {
          window['showShareOptions'] = showShareOptions;
          console.log('   ✅ showShareOptions 강제 등록 완료');
        }
        if (typeof copyToClipboard !== 'undefined') {
          window['copyToClipboard'] = copyToClipboard;
          console.log('   ✅ copyToClipboard 강제 등록 완료');
        }
        if (typeof fallbackCopyToClipboard !== 'undefined') {
          window['fallbackCopyToClipboard'] = fallbackCopyToClipboard;
          console.log('   ✅ fallbackCopyToClipboard 강제 등록 완료');
        }
        if (typeof shareToKakao !== 'undefined') {
          window['shareToKakao'] = shareToKakao;
          console.log('   ✅ shareToKakao 강제 등록 완료');
        }
        if (typeof shareViaWeb !== 'undefined') {
          window['shareViaWeb'] = shareViaWeb;
          console.log('   ✅ shareViaWeb 강제 등록 완료');
        }
        
        console.log('🚨 강제 함수 등록 완료!');
        
        
        console.log('🔍 강제 등록 후 상태 확인:');
        console.log('   - checkSajuResult:', typeof window['checkSajuResult']);
        console.log('   - checkMemberLogin:', typeof window['checkMemberLogin']);
        console.log('   - generateSajuShareText:', typeof window['generateSajuShareText']);
        console.log('   - showShareOptions:', typeof window['showShareOptions']);
      }, 3000);

      
      function diagnoseDOMState() {
        console.log('=== 🔍 DOM 상태 진단 ===');
        console.log('1. 문서 상태:', document.readyState);
        console.log('2. 현재 시간:', new Date().toLocaleTimeString());
        console.log('3. 버튼 존재 여부:');
        console.log('   - DB저장:', !!document.getElementById('db-save-btn'));
        console.log('   - 보내기:', !!document.getElementById('send-btn'));
        console.log('   - DB보기:', !!document.getElementById('db-view-btn'));
        console.log('4. 함수 등록 상태:');
        console.log('   - checkSajuResult:', typeof window['checkSajuResult']);
        console.log('   - checkMemberLogin:', typeof window['checkMemberLogin']);
        console.log('   - generateSajuShareText:', typeof window['generateSajuShareText']);
        
        
        const dbBtn = document.getElementById('db-save-btn');
        if (dbBtn) {
          
          const hasClickListener = dbBtn.onclick !== null || 
                                  (dbBtn.getAttribute && dbBtn.getAttribute('onclick')) ||
                                  (window.getEventListeners && Object.keys(window.getEventListeners(dbBtn)).length > 0);
          console.log('5. DB저장 버튼 이벤트 리스너:', hasClickListener ? '등록됨' : '없음');
        }
        console.log('========================');
      }
      
      
      diagnoseDOMState();
      
      
      if (document.readyState === 'loading') {
        console.log('📋 문서 로딩 중 - DOMContentLoaded 대기');
      } else if (document.readyState === 'interactive') {
        console.log('📋 문서 인터랙티브 상태 - DOM 준비됨');
      } else if (document.readyState === 'complete') {
        console.log('📋 문서 완전 로드됨 - 모든 리소스 준비');
      }

      
      document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 DOMContentLoaded 이벤트 실행 - 버튼 이벤트 리스너 등록 시작');
        
        
        setTimeout(() => {
          console.log('🔄 DOMContentLoaded 후 상태 재진단:');
          diagnoseDOMState();
        }, 100);
        
        
        const dbViewBtn = document.getElementById('db-view-btn');
        if (dbViewBtn) {
          console.log('🔧 DB보기 버튼 이벤트 리스너 등록 시작...');
          
          dbViewBtn.addEventListener('click', function(event) {
            console.log('=====================================');
            console.log('🔍 DB보기 버튼 클릭됨');
            console.log('   - 이벤트 타입:', event.type);
            console.log('   - 타겟:', event.target);
            console.log('=====================================');
            
            
            console.log('1️⃣ 회원 로그인 체크 시작...');
            const memberId = window['checkMemberLogin']();
            console.log('   - checkMemberLogin() 반환값:', memberId);
            
            if (!memberId) {
              console.log('❌ 로그인되지 않음 - redirectToLogin 호출');
              window['redirectToLogin']('회원 로그인이 필요합니다.\n로그인 페이지로 이동합니다.');
              return;
            }
            console.log('✅ 로그인 확인 완료 - memberId:', memberId);
            
            
            window['saveFormData']();
            console.log('💾 현재 화면 데이터 저장 완료 (DB보기 이동 전)');
            
            
            
            
            
            
            console.log('🔒 필터 조건:', {snsgu: 'B0001', smember_id: memberId});
            window.location.href = `/secret/tickboard?snsgu=B0001&smember_id=${memberId}`;
          });
          console.log('✅ DB보기 버튼 이벤트 리스너 등록 완료');
        } else {
          console.error('❌ DB보기 버튼을 찾을 수 없습니다.');
        }
        
        
        const dbSaveBtn = document.getElementById('db-save-btn');
        if (dbSaveBtn) {
          console.log('🔧 DB저장 버튼 이벤트 리스너 등록 시작...');
          
          dbSaveBtn.addEventListener('click', async function(event) {
            console.log('=====================================');
            console.log('💾 DB저장 버튼 클릭됨');
            console.log('   - 이벤트 타입:', event.type);
            console.log('   - 타겟:', event.target);
            console.log('=====================================');
            
            
            console.log('1️⃣ 사주 분석 결과 체크...');
            const sajuResultExists = window['checkSajuResult']();
            console.log('   - checkSajuResult() 반환값:', sajuResultExists);
            
            if (!sajuResultExists) {
              console.log('❌ 사주 분석 결과 없음 - alert 표시');
              alert('먼저 "사주보기" 버튼을 클릭하여 사주를 분석해주세요.');
              return;
            }
            console.log('✅ 사주 분석 결과 확인 완료');
            
            
            console.log('2️⃣ 회원 로그인 체크 시작...');
            const memberId = window['checkMemberLogin']();
            console.log('   - checkMemberLogin() 반환값:', memberId);
            console.log('   - 타입:', typeof memberId);
            console.log('   - Boolean:', !!memberId);
            
            if (!memberId) {
              console.log('❌ 로그인되지 않음 - redirectToLogin 호출');
              window['redirectToLogin']('회원 로그인이 필요합니다.\n로그인 페이지로 이동합니다.');
              return;
            }
            
            console.log('✅ 로그인 확인 완료 - memberId:', memberId);
            console.log('3️⃣ DB저장 프로세스 시작...');
            
            try {
              
              const nameInput = document.getElementById('name');
              const yearInput = document.getElementById('year');
              const monthInput = document.getElementById('month');
              const dayInput = document.getElementById('day');
              const hourInput = document.getElementById('hour');
              const minuteInput = document.getElementById('minute');
              const calendarRadio = document.querySelector('input[name="calendar"]:checked');
              const yundalCheckbox = document.getElementById('yundal');
              const genderRadio = document.querySelector('input[name="gender"]:checked');
              const hourJiInput = document.getElementById('hour-ji-select');
              
              
              if (!nameInput || !nameInput.value.trim()) {
                alert('성명을 입력해주세요.');
                return;
              }
              
              if (!yearInput || !yearInput.value || !monthInput || !monthInput.value || !dayInput || !dayInput.value) {
                alert('생년월일을 선택해주세요.');
                return;
              }
              
              
              const year = yearInput.value;
              const month = String(monthInput.value).padStart(2, '0');
              const day = String(dayInput.value).padStart(2, '0');
              const hour = hourInput && hourInput.value ? String(hourInput.value).padStart(2, '0') : '00';
              const minute = minuteInput && minuteInput.value ? String(minuteInput.value).padStart(2, '0') : '00';
              const birthDatetime = `${year}-${month}-${day}T${hour}:${minute}:00`;
              
              console.log('📅 birth_datetime 생성:', birthDatetime, `(${year}년 ${month}월 ${day}일 ${hour}시 ${minute}분)`);
              
              
              console.log('📝 content_enc 생성 시작');
              let contentText = '';
              
              contentText += `━━━━━━━━━━━━━━━━━━━━\n`;
              contentText += `📊 사주팔자 분석 결과\n`;
              contentText += `━━━━━━━━━━━━━━━━━━━━\n\n`;
              
              
              const userInfoDisplay = document.getElementById('user-info-display');
              console.log('   - user-info-display 요소:', userInfoDisplay ? '찾음' : '없음');
              
              if (userInfoDisplay) {
                const nameAgeElement = userInfoDisplay.querySelector('h3');
                if (nameAgeElement) {
                  const nameAgeText = nameAgeElement.textContent.trim();
                  contentText += `👤 ${nameAgeText}\n\n`;
                  console.log('   - 이름/나이:', nameAgeText);
                }
                
                
                const infoBoxes = userInfoDisplay.querySelectorAll('div[style*="background:white"]');
                console.log('   - 정보 박스 개수:', infoBoxes.length);
                
                infoBoxes.forEach((box, idx) => {
                  const label = box.querySelector('div[style*="color:#6c757d"]');
                  const value = box.querySelector('div[style*="font-weight:700"]');
                  if (label && value) {
                    const labelText = label.textContent.trim();
                    const valueText = value.textContent.trim();
                    contentText += `${labelText}: ${valueText}\n`;
                    console.log(`   - 정보[${idx}] ${labelText}: ${valueText}`);
                  }
                });
                contentText += `\n`;
              } else {
                console.warn('⚠️ user-info-display를 찾을 수 없습니다. 사주 분석을 먼저 실행하세요.');
              }
              
              contentText += `━━━━━━━━━━━━━━━━━━━━\n`;
              contentText += `🔮 四柱八字 (사주팔자)\n`;
              contentText += `━━━━━━━━━━━━━━━━━━━━\n\n`;
              
              console.log('   - 사주기둥 정보 추출 시작');
              
              
              const pillars = ['hour', 'day', 'month', 'year'];
              const pillarNames = ['時柱(시주)', '日柱(일주)⭐', '月柱(월주)', '年柱(년주)'];
              const pillarDescs = ['말년·자식·55세 이후', '본인·배우자·33-55세', '부모·직장·17-33세', '조상·어린시절·1-17세'];
              
              
              const sajuGanList = [];
              const sajuJiList = [];
              
              pillars.forEach((pillar, idx) => {
                const ganEl = document.getElementById(`${pillar}-gan`);
                const jiEl = document.getElementById(`${pillar}-ji`);
                
                if (ganEl && jiEl) {
                  const ganDivs = ganEl.querySelectorAll('div');
                  const jiDivs = jiEl.querySelectorAll('div');
                  
                  let ganText = '';
                  let jiText = '';
                  
                  if (ganDivs.length >= 2) {
                    ganText = ganDivs[1].textContent.trim();
                  } else {
                    ganText = ganEl.textContent.trim().split('\n').filter(t => t.trim())[0] || '';
                  }
                  
                  if (jiDivs.length >= 2) {
                    jiText = jiDivs[0].textContent.trim();
                  } else {
                    jiText = jiEl.textContent.trim().split('\n').filter(t => t.trim())[0] || '';
                  }
                  
                  sajuGanList.push(ganText);
                  sajuJiList.push(jiText);
                }
              });
              
              
              if (sajuGanList.length === 4 && sajuJiList.length === 4) {
                contentText += `【時柱(시주)】: "${sajuGanList[0]}${sajuJiList[0]}" / 【日柱(일주)⭐】: "${sajuGanList[1]}${sajuJiList[1]}" / 【月柱(월주)】: "${sajuGanList[2]}${sajuJiList[2]}" / 【年柱(년주)】: "${sajuGanList[3]}${sajuJiList[3]}"\n\n`;
                
                console.log('   - 사주팔자 요약 (간결 형태):');
                console.log(`     時: ${sajuGanList[0]}${sajuJiList[0]}, 日: ${sajuGanList[1]}${sajuJiList[1]}, 月: ${sajuGanList[2]}${sajuJiList[2]}, 年: ${sajuGanList[3]}${sajuJiList[3]}`);
              }
              
              
              pillars.forEach((pillar, idx) => {
                const ganEl = document.getElementById(`${pillar}-gan`);
                const jiEl = document.getElementById(`${pillar}-ji`);
                const sibiunEl = document.getElementById(`${pillar}-sibiun`);
                const napeumEl = document.getElementById(`${pillar}-napeum`);
                const gongmangEl = document.getElementById(`${pillar}-gongmang`);
                
                console.log(`   - ${pillarNames[idx]}: gan=${ganEl?'O':'X'}, ji=${jiEl?'O':'X'}`);
                
                if (ganEl && jiEl) {
                  
                  const ganDivs = ganEl.querySelectorAll('div');
                  let ganText = '';
                  let ganSipseong = '';
                  if (ganDivs.length >= 2) {
                    ganSipseong = ganDivs[0].textContent.trim();
                    ganText = ganDivs[1].textContent.trim();
                  } else {
                    ganText = ganEl.textContent.trim().split('\n').filter(t => t.trim())[0] || '';
                  }
                  
                  
                  const jiDivs = jiEl.querySelectorAll('div');
                  let jiText = '';
                  let jiSipseong = '';
                  if (jiDivs.length >= 2) {
                    jiText = jiDivs[0].textContent.trim();
                    jiSipseong = jiDivs[1].textContent.trim();
                  } else {
                    jiText = jiEl.textContent.trim().split('\n').filter(t => t.trim())[0] || '';
                  }
                  
                  const sibiun = sibiunEl ? sibiunEl.textContent.trim() : '';
                  const napeum = napeumEl ? napeumEl.textContent.trim() : '';
                  const gongmang = gongmangEl && gongmangEl.classList.contains('empty') ? '공망' : '';
                  
                  contentText += `【${pillarNames[idx]}】 ${pillarDescs[idx]}\n`;
                  contentText += `  天干: ${ganText} ${ganSipseong}\n`;
                  contentText += `  地支: ${jiText} ${jiSipseong}\n`;
                  if (sibiun) contentText += `  十二運: ${sibiun}\n`;
                  if (napeum) contentText += `  納音: ${napeum}\n`;
                  if (gongmang) contentText += `  空亡: ${gongmang}\n`;
                  contentText += `\n`;
                }
              });
              
              
              console.log('   - 오행 분석 정보 추출 시작');
              const elementSummary = document.getElementById('element-summary-header');
              console.log('   - element-summary-header:', elementSummary ? '찾음' : '없음');
              
              if (elementSummary) {
                contentText += `━━━━━━━━━━━━━━━━━━━━\n`;
                contentText += `🌟 오행 분석\n`;
                contentText += `━━━━━━━━━━━━━━━━━━━━\n`;
                const summaryText = elementSummary.textContent.trim().replace(/\(클릭:神殺보기\)/g, '').trim();
                contentText += summaryText + `\n\n`;
                console.log('   - 오행 요약:', summaryText.substring(0, 50));
                
                
                const detailsDiv = document.getElementById('element-summary-details');
                if (detailsDiv) {
                  const detailItems = detailsDiv.querySelectorAll('div[style*="margin-bottom"]');
                  console.log('   - 상세 항목 개수:', detailItems.length);
                  
                  detailItems.forEach(item => {
                    const itemText = item.textContent.trim()
                      .replace(/\s+/g, ' ')
                      .replace(/\
                    if (itemText && !itemText.includes('없음') && itemText.length > 5) {
                      contentText += itemText + `\n`;
                    }
                  });
                }
                contentText += `\n`;
              }
              
              const saveDateTime = new Date().toLocaleString('ko-KR');
              contentText += `━━━━━━━━━━━━━━━━━━━━\n`;
              contentText += `저장일시: ${saveDateTime}\n`;
              contentText += `━━━━━━━━━━━━━━━━━━━━\n`;
              
              console.log('   - 저장일시:', saveDateTime);
              console.log('✅ content_enc 생성 완료 (총', contentText.length, '자)');
              
              
              let memberId = null;
              
              
              if (window.MEMBER_SESSION && window.MEMBER_SESSION.sMem_id) {
                memberId = window.MEMBER_SESSION.sMem_id;
                console.log('✅ MEMBER_SESSION에서 회원 ID:', memberId);
              } else if (typeof window.sMem_id !== 'undefined' && window.sMem_id) {
                memberId = window.sMem_id;
                console.log('✅ window.sMem_id에서 회원 ID:', memberId);
              } else if (typeof sMem_id !== 'undefined' && sMem_id) {
                memberId = sMem_id;
                console.log('✅ 전역 sMem_id에서 회원 ID:', memberId);
              }
              
              if (!memberId) {
                console.log('⚠️ 회원 ID를 찾을 수 없습니다.');
              }
              
              
              console.log('━━━━━━━━━━━━━━━━━━━━');
              console.log('📋 DB저장 데이터 수집 시작');
              console.log('━━━━━━━━━━━━━━━━━━━━');
              
              
              const title = '일반사주보기';
              const title_masked = '일반사주보기';
              console.log('1. title:', title);
              console.log('2. title_masked:', title_masked);
              
              
              const author_name = nameInput.value.trim();
              console.log('3. author_name:', author_name);
              
              
              console.log('4. birth_datetime:', birthDatetime);
              
              
              const timeInputTypeRadio = document.querySelector('input[name="timeInputType"]:checked');
              const isTimeInput = timeInputTypeRadio && timeInputTypeRadio.value === 'time';
              const isGanjiInput = timeInputTypeRadio && timeInputTypeRadio.value === 'ganji';
              
              console.log('5. 시각 입력 방식:', isTimeInput ? '시각 입력' : (isGanjiInput ? '간지 입력' : '알 수 없음'));
              
              
              let birth_hour = null;
              let birth_minute = null;
              let hour_ji = '';
              
              if (isTimeInput) {
                
                birth_hour = hourInput && hourInput.value ? parseInt(hourInput.value) : 0;
                birth_minute = minuteInput && minuteInput.value ? parseInt(minuteInput.value) : 0;
                hour_ji = '';  
                console.log('   ✅ 시각 입력 모드 - birth_hour:', birth_hour, ', birth_minute:', birth_minute);
                console.log('   ✅ hour_ji 초기화: ""');
              } else if (isGanjiInput) {
                
                birth_hour = null;  
                birth_minute = null;  
                hour_ji = hourJiInput && hourJiInput.value ? hourJiInput.value : '';
                console.log('   ✅ 간지 입력 모드 - hour_ji:', hour_ji);
                console.log('   ✅ birth_hour 초기화: null');
                console.log('   ✅ birth_minute 초기화: null');
              }
              
              
              const birth_year = yearInput && yearInput.value ? parseInt(yearInput.value) : 0;
              console.log('7. birth_year:', birth_year, '(입력값:', yearInput?.value, ')');
              
              
              const calendar_type = calendarRadio && calendarRadio.value === 'solar' ? '양력' : '음력';
              console.log('8. calendar_type:', calendar_type, '(라디오값:', calendarRadio?.value, ')');
              
              
              const yundal = yundalCheckbox && yundalCheckbox.checked ? 'Y' : 'N';
              console.log('9. yundal:', yundal, '(체크됨:', yundalCheckbox?.checked, ')');
              
              
              const author_gender = genderRadio && genderRadio.value === 'male' ? 'M' : 'F';
              console.log('10. author_gender:', author_gender, '(라디오값:', genderRadio?.value, ')');
              
              
              console.log('11. content_enc 길이:', contentText.length, '자');
              console.log('    content_enc 미리보기:', contentText.substring(0, 100) + '...');
              
              
              console.log('12. created_at: 서버에서 자동 생성');
              
              console.log('━━━━━━━━━━━━━━━━━━━━');
              
              const data = {
                title: title,
                title_masked: title_masked,
                content: `성명: ${author_name}, 생년월일: ${birthDatetime}`,
                content_enc: contentText,
                post_password: 'saju2024',
                author_name: author_name,
                birth_datetime: birthDatetime,
                birth_hour: birth_hour,
                birth_minute: birth_minute,
                birth_year: birth_year,
                calendar_type: calendar_type,
                yundal: yundal,
                author_gender: author_gender,
                hour_ji: hour_ji,
                
                snsgu: 'B0001',           
                smember_id: memberId,     
                agreement: 1
              };
              
              console.log('📦 최종 저장 데이터:', JSON.stringify(data, null, 2));
              
              
              let url = '/secret/api/v1/tickets';
              let method = 'POST';
              let shouldResetTicketId = false;
              
              
              if (currentTicketId) {
                console.log('📍 기존 ticket_id 존재:', currentTicketId);
                
                
                const userChoice = confirm(
                  '기존 데이터가 있습니다.\n\n' +
                  '[확인] = 수정하기 (기존 데이터 업데이트)\n' +
                  '[취소] = 추가하기 (새로운 데이터 생성)\n\n' +
                  '어떻게 하시겠습니까?'
                );
                
                if (userChoice) {
                  
                  url = `/secret/api/v1/tickets/${currentTicketId}`;
                  method = 'PUT';
                  shouldResetTicketId = true;  
                  console.log('🔄 사용자 선택: 기존 티켓 수정');
                } else {
                  
                  method = 'POST';
                  console.log('➕ 사용자 선택: 새 티켓 생성');
                }
              } else {
                console.log('➕ ticket_id 없음 - 새 티켓 생성');
              }
              
              console.log('🌐 API 호출 시작:', method, url);
              
              const response = await fetch(url, {
                method: method,
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
              });
              
              console.log('📡 API 응답 상태:', response.status, response.statusText);
              
              const result = await response.json();
              console.log('📦 API 응답 데이터:', result);
              
              if (result.ok) {
                if (method === 'POST' && result.ticket_id) {
                  currentTicketId = result.ticket_id;
                  console.log('✅ 저장 완료. ticket_id:', currentTicketId);
                } else if (method === 'PUT' && shouldResetTicketId) {
                  
                  console.log('🔄 수정 완료 - ticket_id 초기화:', currentTicketId, '→ null');
                  currentTicketId = null;
                  
                  
                  const url = new URL(window.location.href);
                  url.searchParams.delete('ticket_id');
                  window.history.replaceState({}, '', url.toString());
                  console.log('✅ URL에서 ticket_id 파라미터 제거 완료');
                }
                
                
                sessionStorage.removeItem('sajuFormData');
                sessionStorage.removeItem('returnAfterLogin');
                
                alert(method === 'POST' ? 'DB에 저장되었습니다.' : 'DB가 수정되었습니다.');
              } else {
                console.error('❌ 저장 실패:', result.error);
                alert('저장 실패: ' + (result.error || '알 수 없는 오류'));
              }
              
            } catch (error) {
              console.error('❌ DB 저장 오류:', error);
              console.error('   오류 상세:', error.message);
              console.error('   스택:', error.stack);
              alert('DB 저장 중 오류가 발생했습니다.\n' + error.message);
            }
          });
          console.log('✅ DB저장 버튼 이벤트 리스너 등록 완료');
        } else {
          console.error('❌ DB저장 버튼을 찾을 수 없습니다.');
        }
        
        
        const sendBtn = document.getElementById('send-btn');
        if (sendBtn) {
          console.log('🔧 보내기 버튼 이벤트 리스너 등록 시작...');
          
          sendBtn.addEventListener('click', function(event) {
            console.log('=====================================');
            console.log('📤 보내기 버튼 클릭됨');
            console.log('   - 이벤트 타입:', event.type);
            console.log('   - 타겟:', event.target);
            console.log('=====================================');
            
            
            console.log('1️⃣ 사주 분석 결과 체크...');
            const sajuResultExists = window['checkSajuResult']();
            console.log('   - checkSajuResult() 반환값:', sajuResultExists);
            
            if (!sajuResultExists) {
              console.log('❌ 사주 분석 결과 없음 - alert 표시');
              alert('먼저 "사주보기" 버튼을 클릭하여 사주를 분석해주세요.');
              return;
            }
            console.log('✅ 사주 분석 결과 확인 완료');
            
            
            console.log('2️⃣ 회원 로그인 체크 시작...');
            const memberId = window['checkMemberLogin']();
            console.log('   - checkMemberLogin() 반환값:', memberId);
            
            if (!memberId) {
              console.log('❌ 로그인되지 않음 - redirectToLogin 호출');
              window['redirectToLogin']('회원 로그인이 필요합니다.\n로그인 페이지로 이동합니다.');
              return;
            }
            console.log('✅ 로그인 확인 완료 - memberId:', memberId);
            
            
            const shareText = window['generateSajuShareText']();
            
            if (!shareText) {
              alert('공유할 데이터를 생성하는데 실패했습니다.');
              return;
            }
            
            
            window['showShareOptions'](shareText);
          });
          console.log('✅ 보내기 버튼 이벤트 리스너 등록 완료');
        } else {
          console.error('❌ 보내기 버튼을 찾을 수 없습니다.');
        }
        
        
        function generateSajuShareText() {
          try {
            let text = '━━━━━━━━━━━━━━━━━━━━\n';
            text += '📊 사주팔자 분석 결과\n';
            text += '━━━━━━━━━━━━━━━━━━━━\n\n';
            
            
            const userInfoDisplay = document.getElementById('user-info-display');
            if (userInfoDisplay) {
              const nameAgeElement = userInfoDisplay.querySelector('h3');
              if (nameAgeElement) {
                text += '👤 ' + nameAgeElement.textContent.trim() + '\n\n';
              }
              
              
              const infoBoxes = userInfoDisplay.querySelectorAll('div[style*="background:white"]');
              infoBoxes.forEach(box => {
                const label = box.querySelector('div[style*="color:#6c757d"]');
                const value = box.querySelector('div[style*="font-weight:700"]');
                if (label && value) {
                  text += label.textContent.trim() + ': ' + value.textContent.trim() + '\n';
                }
              });
              text += '\n';
            }
            
            text += '━━━━━━━━━━━━━━━━━━━━\n';
            text += '🔮 四柱八字 (사주팔자)\n';
            text += '━━━━━━━━━━━━━━━━━━━━\n\n';
            
            
            const pillars = ['hour', 'day', 'month', 'year'];
            const pillarNames = ['時柱(시주)', '日柱(일주)⭐', '月柱(월주)', '年柱(년주)'];
            
            
            const sajuGanList = [];
            const sajuJiList = [];
            
            pillars.forEach((pillar, idx) => {
              const ganEl = document.getElementById(`${pillar}-gan`);
              const jiEl = document.getElementById(`${pillar}-ji`);
              
              if (ganEl && jiEl) {
                const ganDivs = ganEl.querySelectorAll('div');
                const jiDivs = jiEl.querySelectorAll('div');
                
                let ganText = '';
                let jiText = '';
                
                if (ganDivs.length >= 2) {
                  ganText = ganDivs[1].textContent.trim();
                } else {
                  ganText = ganEl.textContent.trim().split('\n').filter(t => t.trim())[0] || '';
                }
                
                if (jiDivs.length >= 2) {
                  jiText = jiDivs[0].textContent.trim();
                } else {
                  jiText = jiEl.textContent.trim().split('\n').filter(t => t.trim())[0] || '';
                }
                
                sajuGanList.push(ganText);
                sajuJiList.push(jiText);
              }
            });
            
            
            if (sajuGanList.length === 4 && sajuJiList.length === 4) {
              
              text += `【時柱(시주)】: "${sajuGanList[0]}${sajuJiList[0]}" / 【日柱(일주)⭐】: "${sajuGanList[1]}${sajuJiList[1]}" / 【月柱(월주)】: "${sajuGanList[2]}${sajuJiList[2]}" / 【年柱(년주)】: "${sajuGanList[3]}${sajuJiList[3]}"\n\n`;
              
              
              text += `【時柱(시주)】【日柱(일주)⭐】【月柱(월주)】【年柱(년주)】\n`;
              text += `------"${sajuGanList[0]}"----------"${sajuGanList[1]}"------------"${sajuGanList[2]}"----------"${sajuGanList[3]}"-----\n`;
              text += `------"${sajuJiList[0]}"----------"${sajuJiList[1]}"------------"${sajuJiList[2]}"----------"${sajuJiList[3]}"-----\n\n`;
            }
            
            
            pillars.forEach((pillar, idx) => {
              const ganEl = document.getElementById(`${pillar}-gan`);
              const jiEl = document.getElementById(`${pillar}-ji`);
              const sibiunEl = document.getElementById(`${pillar}-sibiun`);
              const napeumEl = document.getElementById(`${pillar}-napeum`);
              const pillarDescElements = document.querySelectorAll('.pillar-desc');
              
              if (ganEl && jiEl) {
                const ganText = ganEl.textContent.trim().split('\n').filter(t => t.trim()).join(' ');
                const jiText = jiEl.textContent.trim().split('\n').filter(t => t.trim()).join(' ');
                const sibiun = sibiunEl ? sibiunEl.textContent.trim() : '';
                const napeum = napeumEl ? napeumEl.textContent.trim() : '';
                const pillarDesc = pillarDescElements[idx] ? pillarDescElements[idx].textContent.trim() : '';
                
                text += `【${pillarNames[idx]}】 ${pillarDesc}\n`;
                text += `  天干: ${ganText}\n`;
                text += `  地支: ${jiText}\n`;
                if (sibiun) text += `  十二運: ${sibiun}\n`;
                if (napeum) text += `  納音: ${napeum}\n`;
                text += '\n';
              }
            });
            
            
            const elementSummary = document.getElementById('element-summary-header');
            if (elementSummary) {
              text += '━━━━━━━━━━━━━━━━━━━━\n';
              text += '🌟 오행 분석\n';
              text += '━━━━━━━━━━━━━━━━━━━━\n';
              const summaryText = elementSummary.textContent.trim().replace(/\(클릭:神殺보기\)/g, '').trim();
              text += summaryText + '\n\n';
              
              
              const detailsDiv = document.getElementById('element-summary-details');
              if (detailsDiv) {
                const detailItems = detailsDiv.querySelectorAll('div[style*="margin-bottom"]');
                detailItems.forEach(item => {
                  const itemText = item.textContent.trim()
                    .replace(/\s+/g, ' ')
                    .replace(/\
                  if (itemText && !itemText.includes('없음')) {
                    text += itemText + '\n';
                  }
                });
              }
            }
            
            
            text += '\n━━━━━━━━━━━━━━━━━━━━\n';
            text += '🌊 大運 (대운) 간지 - 10년 단위 (왼쪽→오른쪽)\n';
            text += '━━━━━━━━━━━━━━━━━━━━\n';
            
            
            const daeunChart = document.getElementById('daeun-chart');
            const daeunSummary = document.getElementById('daeun-summary');
            
            let daeunFound = false;
            
            
            if (daeunChart && daeunChart.textContent.trim()) {
              console.log('🔍 대운 차트 발견, 전체 텍스트 파싱 시작...');
              
              
              const chartText = daeunChart.textContent.trim();
              console.log('📄 대운 차트 원본:', chartText.substring(0, 200));
              
              
              const allDivs = daeunChart.querySelectorAll('div');
              const daeunData = [];
              
              
              if (allDivs.length > 0) {
                console.log('📦 총 div 개수:', allDivs.length);
                
                let currentAge = null;
                let currentGan = null;
                let currentJi = null;
                
                allDivs.forEach((div, idx) => {
                  const text = div.textContent.trim();
                  
                  
                  if (text.match(/^\d+-\d+세$/)) {
                    
                    if (currentAge && currentGan && currentJi) {
                      daeunData.push({ 
                        ageRange: currentAge, 
                        gan: currentGan, 
                        ji: currentJi 
                      });
                    }
                    
                    currentAge = text;
                    currentGan = null;
                    currentJi = null;
                  }
                  
                  else if (currentAge && !currentGan && text.length === 1 && 
                           text.match(/[甲乙丙丁戊己庚辛壬癸]/)) {
                    currentGan = text;
                  }
                  
                  else if (currentAge && currentGan && !currentJi && text.length === 1 && 
                           text.match(/[子丑寅卯辰巳午未申酉戌亥]/)) {
                    currentJi = text;
                  }
                });
                
                
                if (currentAge && currentGan && currentJi) {
                  daeunData.push({ 
                    ageRange: currentAge, 
                    gan: currentGan, 
                    ji: currentJi 
                  });
                }
                
                console.log('✅ 추출된 대운 개수:', daeunData.length);
              }
              
              
              if (daeunData.length === 0 && chartText) {
                console.log('⚠️ div 파싱 실패, 텍스트 라인 파싱 시도...');
                
                const lines = chartText.split('\n')
                  .map(line => line.trim())
                  .filter(line => line.length > 0);
                
                console.log('📝 총 라인 수:', lines.length);
                console.log('📝 첫 10줄:', lines.slice(0, 10));
                
                
                for (let i = 0; i < lines.length; i += 3) {
                  if (i + 2 < lines.length) {
                    const line1 = lines[i];
                    const line2 = lines[i + 1];
                    const line3 = lines[i + 2];
                    
                    
                    if (line1.match(/\d+-\d+세/)) {
                      daeunData.push({ 
                        ageRange: line1, 
                        gan: line2, 
                        ji: line3 
                      });
                    }
                  }
                }
                
                console.log('✅ 라인 파싱 결과:', daeunData.length, '개');
              }
              
              
              if (daeunData.length > 0) {
                console.log('🎉 최종 대운 데이터:', daeunData.length, '개');
                
                
                daeunData.reverse();
                
                
                const ageRangeLine = daeunData.map(d => d.ageRange.padEnd(13, ' ')).join('');
                const ganLine = daeunData.map(d => d.gan.padEnd(13, ' ')).join('');
                const jiLine = daeunData.map(d => d.ji.padEnd(13, ' ')).join('');
                
                text += ageRangeLine + '\n';
                text += ganLine + '\n';
                text += jiLine + '\n';
                daeunFound = true;
                
                console.log('✅ 대운 텍스트 생성 완료!');
              } else {
                console.warn('⚠️ 대운 데이터 추출 실패, 원본 표시');
                
                const lines = chartText.split('\n')
                  .map(line => line.trim())
                  .filter(line => line.length > 0);
                
                lines.forEach(line => {
                  text += line + '\n';
                });
                daeunFound = true;
              }
            }
            
            
            if (daeunSummary && daeunSummary.textContent.trim()) {
              const summaryText = daeunSummary.textContent.trim()
                .replace(/\s+/g, ' ')
                .replace(/현재 대운:/g, '\n📍 현재 대운:')
                .replace(/다음 대운:/g, '\n➡️ 다음 대운:')
                .replace(/대운 전환:/g, '\n🔄 대운 전환:')
                .trim();
              if (summaryText) {
                text += '\n' + summaryText + '\n';
                daeunFound = true;
              }
            }
            
            
            if (!daeunFound) {
              text += '대운 정보를 표시하려면 "사주보기"를 먼저 실행해주세요.\n';
            }
            
            
            text += '\n━━━━━━━━━━━━━━━━━━━━\n';
            text += '📅 年運 (년운) 간지 - 해당년도\n';
            text += '━━━━━━━━━━━━━━━━━━━━\n';
            
            
            let yeonunData = [];
            
            
            const currentYear = new Date().getFullYear();
            const currentYearStr = currentYear + '년';
            
            
            if (window.lastYeonunResult && Array.isArray(window.lastYeonunResult) && window.lastYeonunResult.length > 0) {
              console.log('✅ 전역 변수에서 년운 데이터 발견:', window.lastYeonunResult.length, '개');
              console.log('🎯 현재 년도 필터링:', currentYearStr, '(숫자:', currentYear, ')');
              console.log('📊 첫 번째 API 데이터 샘플:', window.lastYeonunResult[0]);
              
              
              
              const currentYearData = window.lastYeonunResult.find(item => item.year === currentYear);
              
              if (currentYearData) {
                console.log('🔍 찾은 원본 데이터:', currentYearData);
                console.log('  - year:', currentYearData.year);
                console.log('  - gan:', currentYearData.gan);
                console.log('  - ji:', currentYearData.ji);
                
                yeonunData = [{
                  year: currentYearData.year + '년',
                  gan: currentYearData.gan,
                  ji: currentYearData.ji  
                }];
                console.log('✅ 현재 년도 년운 발견:', yeonunData[0]);
              } else {
                console.warn('⚠️ 현재 년도 년운을 찾을 수 없습니다:', currentYear);
              }
              
              console.log('🎉 전역 변수에서 최종 년운 데이터:', yeonunData.length, '개');
            }
            
            
            const sewunAnalysis = document.getElementById('sewun-analysis');
            if (yeonunData.length === 0 && sewunAnalysis && sewunAnalysis.textContent.trim()) {
              console.log('🔍 DOM에서 현재 년도 년운 파싱 시작...');
              console.log('🎯 찾을 년도:', currentYearStr);
              
              const sewunFullText = sewunAnalysis.textContent.trim();
              console.log('📄 년운 원본:', sewunFullText.substring(0, 200));
              
              
              const allElements = sewunAnalysis.querySelectorAll('*');
              
              console.log('📦 총 요소 개수:', allElements.length);
              
              
              if (allElements.length > 0) {
                let foundYear = null;
                let foundGan = null;
                let foundJi = null;
                let debugCount = 0;
                let isCurrentYear = false;
                
                allElements.forEach((elem, idx) => {
                  const text = elem.textContent.trim();
                  
                  
                  if (elem.children.length === 0 && text.length > 0) {
                    if (debugCount < 20) {
                      console.log(`  [${idx}] 텍스트: "${text}"`);
                      debugCount++;
                    }
                    
                    
                    if (text.match(/^\d{4}년$/)) {
                      
                      if (text === currentYearStr) {
                        console.log(`  🎯 현재 년도 발견: ${text}`);
                        isCurrentYear = true;
                        foundYear = text;
                        foundGan = null;
                        foundJi = null;
                      } else {
                        console.log(`  ⏭️ 다른 년도 건너뜀: ${text}`);
                        isCurrentYear = false;
                      }
                    }
                    
                    else if (isCurrentYear) {
                      
                      if (!foundGan && text.length === 1 && 
                          text.match(/[甲乙丙丁戊己庚辛壬癸]/)) {
                        console.log(`  ✓ 천간 발견: ${text}`);
                        foundGan = text;
                      }
                      
                      else if (foundGan && !foundJi && text.length === 1 && 
                               text.match(/[子丑寅卯辰巳午未申酉戌亥]/)) {
                        console.log(`  ✓ 지지 발견: ${text}`);
                        foundJi = text;
                        
                        
                        if (foundYear && foundGan && foundJi) {
                          console.log(`  ✅ 현재 년도 년운 완성: ${foundYear} ${foundGan}${foundJi}`);
                          yeonunData.push({ 
                            year: foundYear, 
                            gan: foundGan, 
                            ji: foundJi 
                          });
                          return; 
                        }
                      }
                    }
                  }
                });
                
                console.log('✅ 추출된 년운 개수:', yeonunData.length);
              }
              
              
              if (yeonunData.length === 0 && sewunFullText) {
                console.log('⚠️ div 파싱 실패, 텍스트 라인 파싱 시도...');
                console.log('🎯 찾을 년도:', currentYearStr);
                
                const lines = sewunFullText.split('\n')
                  .map(line => line.trim())
                  .filter(line => line.length > 0);
                
                console.log('📝 총 라인 수:', lines.length);
                console.log('📝 첫 10줄:', lines.slice(0, 10));
                
                
                for (let i = 0; i < lines.length; i++) {
                  const line = lines[i];
                  
                  
                  if (line === currentYearStr) {
                    console.log(`  🎯 현재 년도 발견: ${line}`);
                    
                    
                    if (i + 2 < lines.length) {
                      const gan = lines[i + 1];
                      const ji = lines[i + 2];
                      
                      console.log(`  ✓ 천간: ${gan}, 지지: ${ji}`);
                      
                      yeonunData.push({ 
                        year: line, 
                        gan: gan, 
                        ji: ji 
                      });
                      
                      break; 
                    }
                  }
                }
                
                console.log('✅ 라인 파싱 결과:', yeonunData.length, '개');
              }
            }
            
            
            if (yeonunData.length > 0) {
              console.log('🎉 최종 년운 데이터:', yeonunData.length, '개');
              console.log('📊 년운 데이터 구조:', yeonunData[0]);
              
              
              const data = yeonunData[0];
              const year = data.year || '';
              const gan = data.gan || '';
              const ji = data.ji || '';
              
              console.log('🔍 년운 상세:');
              console.log('  - year:', year);
              console.log('  - gan:', gan);
              console.log('  - ji:', ji);
              console.log('  - 합친 결과:', `${gan}${ji}`);
              
              
              text += `📍 ${year}: ${gan}${ji}\n`;
              
              console.log('✅ 년운 텍스트 생성 완료!');
            } else {
              console.warn('⚠️ 현재 년도 년운 데이터를 찾을 수 없습니다');
              text += '현재 년도 년운 정보를 표시하려면 "사주보기"를 먼저 실행해주세요.\n';
            }
            
            text += '\n━━━━━━━━━━━━━━━━━━━━\n';
            text += '🌐 나라톡톡 사주풀이\n';
            text += window.location.origin + '/saju/\n';
            text += '━━━━━━━━━━━━━━━━━━━━\n';
            
            return text;
          } catch (error) {
            console.error('❌ 텍스트 생성 오류:', error);
            return null;
          }
        }
        
        
        
        function showShareOptions(text) {
          
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
          `;
          
          const modalContent = document.createElement('div');
          modalContent.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
          `;
          
          
          const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
          
          modalContent.innerHTML = `
            <h3 style="margin-top:0;color:#333;text-align:center;">📤 공유 방법 선택</h3>
            <div style="display:flex;flex-direction:column;gap:10px;margin-top:20px;">
              ${isMobile ? `
                <button id="shareSMSBtn" style="padding:15px;font-size:16px;border:2px solid #FF9800;background:#FF9800;color:white;border-radius:8px;cursor:pointer;font-weight:600;">
                  💬 문자(SMS)로 공유
                </button>
                <button id="shareWebBtn" style="padding:15px;font-size:16px;border:2px solid #2196F3;background:#2196F3;color:white;border-radius:8px;cursor:pointer;font-weight:600;">
                  🌐 카톡등 기타 앱으로 공유
                </button>
              ` : ''}
              <button id="copyTextBtn" style="padding:15px;font-size:16px;border:2px solid #4CAF50;background:#4CAF50;color:white;border-radius:8px;cursor:pointer;font-weight:600;">
                📋 텍스트 복사하기
              </button>
              <button id="closeModalBtn" style="padding:15px;font-size:16px;border:2px solid #ccc;background:white;color:#666;border-radius:8px;cursor:pointer;margin-top:10px;">
                취소
              </button>
            </div>
          `;
          
          modal.appendChild(modalContent);
          document.body.appendChild(modal);
          
          
          document.getElementById('copyTextBtn').addEventListener('click', () => {
            window['copyToClipboard'](text);
            document.body.removeChild(modal);
          });
          
          
          if (isMobile) {
            document.getElementById('shareSMSBtn').addEventListener('click', () => {
              window['shareToSMS'](text);
              document.body.removeChild(modal);
            });
            
            document.getElementById('shareWebBtn').addEventListener('click', () => {
              window['shareViaWeb'](text);
              document.body.removeChild(modal);
            });
          }
          
          document.getElementById('closeModalBtn').addEventListener('click', () => {
            document.body.removeChild(modal);
          });
          
          
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              document.body.removeChild(modal);
            }
          });
        }
        
        
        function copyToClipboard(text) {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
              alert('✅ 텍스트가 클립보드에 복사되었습니다!\n\n원하는 곳에 붙여넣기(Ctrl+V)하세요.');
            }).catch(err => {
              console.error('클립보드 복사 실패:', err);
              window['fallbackCopyToClipboard'](text);
            });
          } else {
            window['fallbackCopyToClipboard'](text);
          }
        }
        
        
        function fallbackCopyToClipboard(text) {
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            alert('✅ 텍스트가 복사되었습니다!');
          } catch (err) {
            alert('❌ 복사에 실패했습니다. 수동으로 복사해주세요.');
            prompt('아래 텍스트를 복사하세요:', text);
          }
          document.body.removeChild(textArea);
        }
        
        
        function shareToKakao(text) {
          console.log('📱 카카오톡 공유 시도...');
          console.log('📝 전송할 텍스트 길이:', text.length);
          console.log('📝 텍스트 내용 (처음 100자):', text.substring(0, 100));
          
          
          
          const kakaoUrl = `kakaotalk:
          
          console.log('🔗 카카오톡 URL 생성 완료');
          
          
          try {
            window.location.href = kakaoUrl;
            console.log('✅ 카카오톡 실행 시도 완료');
            
            
            
            
            
          } catch (error) {
            console.error('❌ 카카오톡 실행 오류:', error);
            
            alert('카카오톡을 실행할 수 없습니다.\n\n카카오톡이 설치되어 있는지 확인해주세요.');
          }
        }
        
        
        function shareToSMS(text) {
          console.log('📱 SMS 공유 시도...');
          
          
          
          
          const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
          const smsUrl = isIOS 
            ? `sms:&body=${encodeURIComponent(text)}`
            : `sms:?body=${encodeURIComponent(text)}`;
          
          window.location.href = smsUrl;
        }
        
        
        function shareViaWeb(text) {
          console.log('📱 웹 공유 API 시도...');
          
          if (navigator.share) {
            navigator.share({
              title: '📊 사주팔자 분석 결과',
              text: text
            }).then(() => {
              console.log('✅ 웹 공유 완료');
            }).catch((error) => {
              
              if (error.name === 'AbortError') {
                console.log('ℹ️ 사용자가 공유를 취소했습니다.');
              } else {
                console.error('❌ 웹 공유 실패:', error);
                if (confirm('공유에 실패했습니다.\n\n텍스트를 복사하시겠습니까?')) {
                  window['copyToClipboard'](text);
                }
              }
            });
          } else {
            alert('이 브라우저는 웹 공유를 지원하지 않습니다.\n텍스트 복사 기능을 사용해주세요.');
            window['copyToClipboard'](text);
          }
        }
        
        
        console.log('🔧 함수 등록 시작...');
        window['loadTicketData'] = loadTicketData;
        window['checkMemberLogin'] = checkMemberLogin;
        window['checkSajuResult'] = checkSajuResult;
        window['redirectToLogin'] = redirectToLogin;
        window['saveFormData'] = saveFormData;
        window['restoreFormData'] = restoreFormData;
        window['generateSajuShareText'] = generateSajuShareText;
        window['showShareOptions'] = showShareOptions;
        window['copyToClipboard'] = copyToClipboard;
        window['fallbackCopyToClipboard'] = fallbackCopyToClipboard;
        window['shareToKakao'] = shareToKakao;
        window['shareToSMS'] = shareToSMS;  
        window['shareViaWeb'] = shareViaWeb;
        console.log('✅ 모든 함수 등록 완료!');
        
        
        console.log('🔍 함수 등록 상태 확인:');
        console.log('   - checkSajuResult:', typeof window['checkSajuResult']);
        console.log('   - checkMemberLogin:', typeof window['checkMemberLogin']);
        console.log('   - generateSajuShareText:', typeof window['generateSajuShareText']);
        console.log('   - showShareOptions:', typeof window['showShareOptions']);
        
        
        console.log('🎯 DOMContentLoaded 완료 - 최종 상태 진단:');
        setTimeout(() => {
          diagnoseDOMState();
          
          
          console.log('🧪 이벤트 리스너 테스트:');
          const testButtons = [
            { id: 'db-save-btn', name: 'DB저장' },
            { id: 'send-btn', name: '보내기' },
            { id: 'db-view-btn', name: 'DB보기' }
          ];
          
          testButtons.forEach(btn => {
            const element = document.getElementById(btn.id);
            if (element) {
              
              const hasListener = element.onclick !== null || 
                                 (element.getAttribute && element.getAttribute('onclick'));
              console.log(`   - ${btn.name} 버튼: ${hasListener ? '이벤트 있음' : '이벤트 없음'}`);
            } else {
              console.log(`   - ${btn.name} 버튼: 요소 없음`);
            }
          });
          
          console.log('🏁 모든 진단 완료!');
        }, 200);
      });
    </script>
  </body>
</html>
