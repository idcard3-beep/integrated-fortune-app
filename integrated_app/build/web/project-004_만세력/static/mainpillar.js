console.log('mainpillar.js loaded');let solarTermsData={};const solarTermsUrl=function getSolarTermsApiUrl(year){return`/mans/get_solar_terms?year=${year}`;};async function loadSolarTerms(year){if(solarTermsData[year]){return solarTermsData[year];}
try{const apiUrl=solarTermsUrl(year);const res=await fetch(apiUrl);if(!res.ok)
throw new Error(`/mans/get_solar_terms API fetch 실패! status: ${res.status}`);const json=await res.json();solarTermsData[year]=json[year];return solarTermsData[year];}catch(e){alert(`/mans/get_solar_terms API에서 절기 데이터를 불러올 수 없습니다.\n에러: ${e.message}`);return[];}}
const tenGan=['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];const twelveZhi=['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥',];(function fillTZ(){const select=document.getElementById('tzselect');try{const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;const opts=[tz,'UTC','Asia/Seoul','Asia/Tokyo','Europe/London','America/Los_Angeles','Asia/Shanghai',];opts.forEach((z)=>{const o=document.createElement('option');o.value=z;o.textContent=z;select.appendChild(o);});select.value=tz;}catch(e){}})();document.getElementById('calc').addEventListener('click',async()=>{const birthInput=document.getElementById('birth').value;const year=parseInt(document.getElementById('year').value,10);console.log('입력된 year 값:',year);const birthLocal=new Date(birthInput);console.log('birthLocal.getFullYear():',birthLocal.getFullYear());const tz=document.getElementById('tzselect').value;const dayMode=document.getElementById('dayMode').value;const precision=parseInt(document.getElementById('precision').value,10);const termsDiv=document.getElementById('terms');const resDiv=document.getElementById('result');if(!termsDiv||!resDiv){alert('결과 영역(div#terms, div#result)이 HTML에 없습니다. mainpillar.html 구조를 확인하세요.');return;}
if(!birthInput){alert('생년월일 시각을 입력하세요.');termsDiv.innerHTML='';resDiv.innerHTML='';return;}
const termsPrev=await loadSolarTerms(birthLocal.getFullYear()-1);const termsThis=await loadSolarTerms(birthLocal.getFullYear());const termsNext=await loadSolarTerms(birthLocal.getFullYear()+1);const allTerms=[].concat(termsPrev,termsThis,termsNext);const lichuns=allTerms.filter((t)=>t.term==='입춘');let selectedLichun=null;for(let i=0;i<lichuns.length;i++){const lichunDate=new Date(lichuns[i].datetime_KST.replace(/-/g,'/'));if(lichunDate<=birthLocal){selectedLichun=lichuns[i];}}
let yearGanZhi='';let yearP='';if(selectedLichun){const lichunDate=new Date(selectedLichun.datetime_KST.replace(/-/g,'/'));const baseYear=1864;const lichunYear=lichunDate.getFullYear();let yearIdx=(lichunYear-baseYear)%60;if(yearIdx<0)yearIdx+=60;yearGanZhi=tenGan[yearIdx%10]+twelveZhi[yearIdx%12];yearP=`입춘 기준 연도: ${lichunYear} / 입춘 시각: ${selectedLichun.datetime_KST} / 간지: <b>${yearGanZhi}</b>`;}else{yearP='입춘 데이터 없음';}
const midTerms=['입춘','경칩','청명','입하','망종','소서','입추','백로','한로','입동','대설','소한',];let lastMidTerm=null;for(let i=0;i<allTerms.length;i++){const t=allTerms[i];const termDate=new Date(t.datetime_KST.replace(/-/g,'/'));if(termDate<=birthLocal&&midTerms.includes(t.term)){lastMidTerm=t;}}
let monthGanZhi='';if(lastMidTerm){const evenTerms=['입춘','경칩','청명','입하','망종','소서','입추','백로','한로','입동','대설','소한',];const filteredTerms=allTerms.filter((t)=>evenTerms.includes(t.term));let selectedTerm=null;for(let i=0;i<filteredTerms.length;i++){const termDate=new Date(filteredTerms[i].datetime_KST.replace(/-/g,'/'));if(termDate<=birthLocal){selectedTerm=filteredTerms[i];}}
if(selectedTerm){const termDate=new Date(selectedTerm.datetime_KST.replace(/-/g,'/'));const baseDate=new Date('1864/01/01 00:00:00');const msPerDay=24*60*60*1000;let dayIdx=Math.floor((termDate-baseDate)/msPerDay);let yearStemIdx=(termDate.getFullYear()-1864)%10;const monthBranchIndexMap={1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,11:11,12:0,};let monthBranchIdx=monthBranchIndexMap[termDate.getMonth()+1];const inMonthStemIdx=[2,4,6,8,0][yearStemIdx%5];let diff=0;if(monthBranchIdx==0){diff=inMonthStemIdx+10;}else if(monthBranchIdx==1){diff=inMonthStemIdx+monthBranchIdx+8;}else{diff=inMonthStemIdx+monthBranchIdx-2;}
stemIdx=diff;if(diff>=10){stemIdx=diff%10;}
monthGanZhi=tenGan[stemIdx]+twelveZhi[monthBranchIdx];}}
const baseDate=new Date('1900-01-01T00:00:00+09:00');const msPerDay=24*60*60*1000;let baseIdx=10;let dayDiff=Math.floor((birthLocal-baseDate)/msPerDay);let dayIdx=(((baseIdx+dayDiff)%60)+60)%60;const dayGan=tenGan[dayIdx%10];const dayZhi=twelveZhi[dayIdx%12];const hour=birthLocal.getHours();const minute=birthLocal.getMinutes();let hourIdx=0;if((hour===23&&minute>=30)||hour===0||(hour===1&&minute<30)){hourIdx=0;}else if((hour===1&&minute>=30)||hour===2||(hour===3&&minute<30)){hourIdx=1;}else if((hour===3&&minute>=30)||hour===4||(hour===5&&minute<30)){hourIdx=2;}else if((hour===5&&minute>=30)||hour===6||(hour===7&&minute<30)){hourIdx=3;}else if((hour===7&&minute>=30)||hour===8||(hour===9&&minute<30)){hourIdx=4;}else if((hour===9&&minute>=30)||hour===10||(hour===11&&minute<30)){hourIdx=5;}else if((hour===11&&minute>=30)||hour===12||(hour===13&&minute<30)){hourIdx=6;}else if((hour===13&&minute>=30)||hour===14||(hour===15&&minute<30)){hourIdx=7;}else if((hour===15&&minute>=30)||hour===16||(hour===17&&minute<30)){hourIdx=8;}else if((hour===17&&minute>=30)||hour===18||(hour===19&&minute<30)){hourIdx=9;}else if((hour===19&&minute>=30)||hour===20||(hour===21&&minute<30)){hourIdx=10;}else if((hour===21&&minute>=30)||hour===22||(hour===23&&minute<30)){hourIdx=11;}else{hourIdx=Math.floor(((hour+1)%24)/2);}
const hourZhi=twelveZhi[hourIdx];const ziHourStemMap={0:0,5:0,1:2,6:2,2:4,7:4,3:6,8:6,4:8,9:8,};const dayStemIdx=dayIdx%10;const firstHourStemIdx=ziHourStemMap[dayStemIdx];const hourGan=tenGan[(firstHourStemIdx+hourIdx)%10];const sajuResult={year:yearGanZhi,month:monthGanZhi,day:dayGan+dayZhi,hour:hourGan+hourZhi,info:{yearP,monthTerm:lastMidTerm?lastMidTerm.term:'',monthTermStart:lastMidTerm?lastMidTerm.datetime_KST:'',birth:birthLocal.toLocaleString(),hour:`${hour.toString().padStart(2, '0')}:${minute
        .toString()
        .padStart(2, '0')}`,tz,},};const solarYear=birthLocal.getFullYear();const solarMonth=birthLocal.getMonth()+1;const solarDay=birthLocal.getDate();let lunarStr='';try{const lunarRes=await fetch(`/mans/convert_solar_to_lunar?year=${solarYear}&month=${solarMonth}&day=${solarDay}`);const lunarData=await lunarRes.json();if(!lunarData.error){const lunarType=lunarData.is_leap?'윤달':'평달';lunarStr=`${lunarData.year}.${lunarData.month}.${lunarData.day} ${lunarType}`;}}catch(e){console.error('음력 변환 오류:',e);}
let rhtml='<table><tbody>';rhtml+=`<tr><th>입력 시각 (로컬)</th><td>${sajuResult.info.birth} (${sajuResult.info.tz})</td></tr>`;if(lunarStr){rhtml+=`<tr><th>음력</th><td>${lunarStr}</td></tr>`;}
rhtml+=`<tr><th>년주</th><td><b>${sajuResult.year}</b></td></tr>`;rhtml+=`<tr><th>월주</th><td><b>${sajuResult.month}</b></td></tr>`;rhtml+=`<tr><th>일주</th><td><b>${sajuResult.day}</b></td></tr>`;rhtml+=`<tr><th>시주</th><td><b>${sajuResult.hour}</b> (시간: ${sajuResult.info.hour})</td></tr>`;rhtml+='</tbody></table>';rhtml+='<pre style="background:#f8f8f8;padding:8px;border-radius:4px">'+
JSON.stringify(sajuResult,null,2)+'</pre>';rhtml+='<p class="note">모든 절기 및 시간은 135°E 서울 기준으로 계산됩니다. 일주/시주는 근사값입니다.</p>';resDiv.innerHTML=rhtml;});(function(){const now=new Date();const localISO=new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,16);document.getElementById('birth').value=localISO;document.getElementById('year').value=now.getFullYear();})();