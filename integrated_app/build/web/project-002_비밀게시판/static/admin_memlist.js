(function initResizer(){const resizer=document.getElementById('resizer');const main=document.querySelector('main');let isResizing=false;let startX=0;let startWidth=0;const savedWidth=localStorage.getItem('a03_gridWidth');if(savedWidth){document.documentElement.style.setProperty('--grid-width',savedWidth);}
resizer.addEventListener('mousedown',(e)=>{isResizing=true;startX=e.clientX;const computed=getComputedStyle(document.documentElement);const currentWidth=computed.getPropertyValue('--grid-width').trim();startWidth=parseFloat(currentWidth)||48;document.body.style.cursor='col-resize';document.body.style.userSelect='none';});document.addEventListener('mousemove',(e)=>{if(!isResizing)return;const deltaX=e.clientX-startX;const mainWidth=main.offsetWidth;const deltaPercent=(deltaX/mainWidth)*100;let newWidth=startWidth+deltaPercent;newWidth=Math.max(25,Math.min(75,newWidth));document.documentElement.style.setProperty('--grid-width',newWidth+'%');});document.addEventListener('mouseup',()=>{if(isResizing){isResizing=false;document.body.style.cursor='';document.body.style.userSelect='';const currentWidth=getComputedStyle(document.documentElement).getPropertyValue('--grid-width').trim();localStorage.setItem('a03_gridWidth',currentWidth);}});})();const LS_KEY='talktalk_admin_tt';const state={tickets:[],messages:[],ui:{ticketSort:{key:'created_at',dir:'desc'},threadSort:{key:'created_at',dir:'desc'},selectedTicketId:null,selectedMsgId:null,theme:'soft-light',},};function uid(prefix='id'){return(prefix+
'_'+
(crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2,10)));}
function nowISO(){return new Date().toISOString();}
function save(){localStorage.setItem(LS_KEY,JSON.stringify({tickets:state.tickets,messages:state.messages,ui:state.ui,}));}
function load(){const raw=localStorage.getItem(LS_KEY);if(raw){try{const obj=JSON.parse(raw);state.tickets=obj.tickets||[];state.messages=obj.messages||[];state.ui={...state.ui,...(obj.ui||{})};}catch(e){}}else{seed();save();}}
function seed(){const names=['ê¹€ë¯¼ìˆ˜','ì´ì„œì—°','ë°•ì§€í˜¸','ìµœìœ¤ì•„','ì •í•˜ì¤€','í•œìœ ì§„','ì„œì§€ìš°','ì˜¤ì„¸í›ˆ','ë¬¸ë‹¤ì€','ê°•í•˜ë¦°','ìœ ê°€ì˜¨','ë°°ë‹¤ì¸',];for(let i=0;i<12;i++){const tid=uid('tkt');const mem='mem_'+String(1000+i);const status=i%3===0?'new':i%3===1?'pending':'closed';const title=['ë¹„ë°€ìƒë‹´ ìš”ì²­','ë¶ˆì•ˆ/ìš°ìš¸ ê´€ë ¨','ëŒ€ì¸ê´€ê³„ ê°ˆë“±','ì§ë¬´ ë²ˆì•„ì›ƒ','ìˆ˜ë©´ ë¬¸ì œ','ìë…€ ì–‘ìœ¡ ê³ ë¯¼',][i%6]+
'#'+
(i+1);const content='ìƒ˜í”Œ ë¬¸ì˜ ë‚´ìš©ì…ë‹ˆë‹¤. í•µì‹¬ í‚¤ì›Œë“œ '+
(i%2?'ìš°ìš¸':'ë¶ˆì•ˆ')+
' / ìƒì„¸ ì„œìˆ  ...';state.tickets.push({ticket_id:tid,sMember_id:mem,author_name:names[i%names.length],title_masked:title,content_enc:content,status,created_at:new Date(Date.now()-i*3600_000*8).toISOString(),post_pwd_hash:'',});const msgCount=i%3===0?0:i%3===1?1:2;for(let k=0;k<msgCount;k++){state.messages.push({message_id:uid('msg'),ticket_id:tid,admin_id:'admin0'+((k%3)+1),role:['admin','counselor','owner'][(i+k)%3],body:`ê´€ë¦¬ì ë‹µë³€#${k+1}â€” ì§„í–‰ ì•ˆë‚´/í”¼ë“œë°±`,visibility:'private',created_at:new Date(Date.now()-(i*4+k)*1800_000).toISOString(),});}}}
function text(t){return(t??'').toString();}
function contains(hay,needle){return text(hay).toLowerCase().includes(text(needle).toLowerCase());}
function sortBy(arr,key,dir='asc'){return[...arr].sort((a,b)=>{const va=a[key],vb=b[key];if(va===vb)return 0;return(va>vb?1:-1)*(dir==='asc'?1:-1);});}
function hasReply(ticket_id){return state.messages.some((m)=>m.ticket_id===ticket_id);}
const tblTickets=document.querySelector('#tblTickets tbody');const ticketsCount=document.getElementById('ticketsCount');const filterStatus=document.getElementById('filterStatus');const filterHasReply=document.getElementById('filterHasReply');const searchTickets=document.getElementById('searchTickets');function currentTicketFilter(t){if(filterStatus.value&&t.status!==filterStatus.value)return false;const has=hasReply(t.ticket_id);if(filterHasReply.value==='true'&&!has)return false;if(filterHasReply.value==='false'&&has)return false;const q=searchTickets.value.trim();if(q){const pool=[t.author_name,t.title_masked,t.content_enc,t.ticket_id,].join(' || ');if(!contains(pool,q))return false;}
return true;}
function renderTickets(){const{key,dir}=state.ui.ticketSort;const data=sortBy(state.tickets.filter(currentTicketFilter),key,dir);tblTickets.innerHTML='';for(const t of data){const tr=document.createElement('tr');if(t.ticket_id===state.ui.selectedTicketId)
tr.classList.add('selected');tr.dataset.id=t.ticket_id;tr.innerHTML=`<td><span class="cut"title="${escapeHtml(
  t.title_masked || ''
)}">${escapeHtml(t.title_masked||'')}</span></td><td><span class="status ${t.status} cut"title="${t.status}">${t.status}</span></td><td><span class="cut"title="${t.has_admin_reply ? 'ìˆìŒ' : 'ì—†ìŒ'}">${t.has_admin_reply?'ìˆìŒ':'ì—†ìŒ'}</span></td><td><span class="cut"title="${escapeHtml(
  t.author_name || ''
)}">${escapeHtml(t.author_name||'')}</span></td><td><span class="cut"title="${escapeHtml(
  t.author_contact || ''
)}">${escapeHtml(t.author_contact||'')}</span></td><td><span class="cut"title="${escapeHtml(t.snsgu || '')}">${escapeHtml(t.snsgu||'')}</span></td><td><span class="mono cut"title="${t.created_at}">${t.created_at.replace('T',' ').slice(0,19)}</span></td>`;tblTickets.appendChild(tr);}
ticketsCount.textContent=`${data.length}ê±´`;}
function selectTicket(id){console.log('ğŸ¯ selectTicket í˜¸ì¶œë¨ - id:',id,'type:',typeof id);state.ui.selectedTicketId=id;state.ui.selectedMsgId=null;save();renderTickets();renderThreads();document.getElementById('btnEditTicket').disabled=!id;document.getElementById('btnDelTicket').disabled=!id;document.getElementById('btnAddMsg').disabled=!id;document.getElementById('btnEditMsg').disabled=true;document.getElementById('btnDelMsg').disabled=true;const t=state.tickets.find((x)=>x.ticket_id===id);document.getElementById('threadsTitleHint').textContent=t?`${t.title_masked}`:'';console.log('ğŸ¯ selectTicket ì™„ë£Œ - ì„ íƒëœ í‹°ì¼“:',t);}
const tblThreads=document.querySelector('#tblThreads tbody');const threadsCount=document.getElementById('threadsCount');const threadsHint=document.getElementById('threadsHint');const searchThreads=document.getElementById('searchThreads');function currentThreads(){const id=state.ui.selectedTicketId;console.log('ğŸ” currentThreads - selectedTicketId:',id);console.log('ğŸ” currentThreads - ì „ì²´ messages ê°œìˆ˜:',state.messages.length);if(!id)return[];const all=state.messages.filter((m)=>{const match=String(m.ticket_id)===String(id);if(match){console.log('âœ… ë§¤ì¹­ëœ ë©”ì‹œì§€:',m);}
return match;});console.log('ğŸ” currentThreads - í•„í„°ë§ëœ messages ê°œìˆ˜:',all.length);const q=searchThreads.value.trim();let filtered=all;if(q){filtered=all.filter((m)=>contains([m.body,m.admin_id,m.role,m.message_id].join(' || '),q));}
const{key,dir}=state.ui.threadSort;return sortBy(filtered,key,dir);}
function renderThreads(){tblThreads.innerHTML='';const rows=currentThreads();threadsHint.textContent=!state.ui.selectedTicketId?'í‹°ì¼“ì„ ì„ íƒí•˜ë©´ ê´€ë ¨ ë‹µë³€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.':rows.length===0?'í•´ë‹¹ í‹°ì¼“ì˜ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.':'';for(const m of rows){const tr=document.createElement('tr');if(m.message_id===state.ui.selectedMsgId)
tr.classList.add('selected');tr.dataset.id=m.message_id;tr.innerHTML=`<td><span class="mono cut"title="${m.created_at}">${m.created_at.replace('T',' ').slice(0,19)}</span></td><td><span class="mono cut"title="${escapeHtml(m.admin_id)}">${escapeHtml(m.admin_id)}</span></td><td><span class="cut"title="${escapeHtml(m.role || '')}">${escapeHtml(m.role||'')}</span></td><td><span class="cut"title="${escapeHtml(m.body)}">${escapeHtml(m.body)}</span></td><td><span class="mono cut"title="${m.message_id}">${m.message_id}</span></td>`;tblThreads.appendChild(tr);}
threadsCount.textContent=`${rows.length}ê±´`;}
document.querySelectorAll('#tblTickets thead th').forEach((th)=>{th.addEventListener('click',()=>{const key=th.dataset.sort;if(!key)return;const sort=state.ui.ticketSort;sort.dir=sort.key===key&&sort.dir==='asc'?'desc':'asc';sort.key=key;save();renderTickets();});});document.querySelectorAll('#tblThreads thead th').forEach((th)=>{th.addEventListener('click',()=>{const key=th.dataset.sort;if(!key)return;const sort=state.ui.threadSort;sort.dir=sort.key===key&&sort.dir==='asc'?'desc':'asc';sort.key=key;save();renderThreads();});});filterStatus.addEventListener('input',()=>renderTickets());filterHasReply.addEventListener('input',()=>renderTickets());searchTickets.addEventListener('input',()=>renderTickets());searchThreads.addEventListener('input',()=>renderThreads());document.querySelector('#tblTickets tbody').addEventListener('click',(e)=>{const tr=e.target.closest('tr');if(!tr)return;selectTicket(tr.dataset.id);});document.querySelector('#tblThreads tbody').addEventListener('click',(e)=>{const tr=e.target.closest('tr');if(!tr)return;state.ui.selectedMsgId=tr.dataset.id;save();renderThreads();document.getElementById('btnEditMsg').disabled=false;document.getElementById('btnDelMsg').disabled=false;});const dlgTicket=document.getElementById('dlgTicket');const btnAddTicket=document.getElementById('btnAddTicket');const btnEditTicket=document.getElementById('btnEditTicket');const btnDelTicket=document.getElementById('btnDelTicket');const btnSaveTicket=document.getElementById('btnSaveTicket');let editingTicketId=null;btnAddTicket.addEventListener('click',()=>{editingTicketId=null;document.getElementById('dlgTicketTitle').textContent='í‹°ì¼“ ì¶”ê°€';setTicketForm(undefined,false);dlgTicket.showModal();});btnEditTicket.addEventListener('click',()=>{const id=state.ui.selectedTicketId;if(!id)return;editingTicketId=id;document.getElementById('dlgTicketTitle').textContent='í‹°ì¼“ ìˆ˜ì •';const t=state.tickets.find((x)=>x.ticket_id===id);console.log('ğŸ” í‹°ì¼“ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ - ticket_id:',id);console.log('ğŸ” ì°¾ì€ í‹°ì¼“ ë°ì´í„°:',t);console.log('ğŸ” í‹°ì¼“ content_enc:',t?.content_enc);setTicketForm(t,true);dlgTicket.showModal();});btnDelTicket.addEventListener('click',async()=>{const id=state.ui.selectedTicketId;if(!id)return;if(!confirm('ì„ íƒí•œ í‹°ì¼“ì„ ì‚­ì œí• ê¹Œìš”? (ê´€ë ¨ ë‹µë³€ë„ í•¨ê»˜ ì‚­ì œ)'))
return;try{console.log('ğŸ”„ í‹°ì¼“ ì‚­ì œ API í˜¸ì¶œ:',id);const response=await fetch(`/secret/api/v1/tickets/${id}`,{method:'DELETE',});if(!response.ok){const error=await response.json();throw new Error(error.error||'í‹°ì¼“ ì‚­ì œ ì‹¤íŒ¨');}
console.log('âœ… í‹°ì¼“ ì‚­ì œ ì™„ë£Œ');alert('í‹°ì¼“ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');state.ui.selectedTicketId=null;await loadFromServer();document.getElementById('btnEditTicket').disabled=true;document.getElementById('btnDelTicket').disabled=true;document.getElementById('btnAddMsg').disabled=true;}catch(error){console.error('âŒ í‹°ì¼“ ì‚­ì œ ì˜¤ë¥˜:',error);alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);}});function setTicketForm(t={sMember_id:'',author_name:'',status:'new',title_masked:'',content_enc:'',post_pwd_hash:'',},isEdit=false){console.log('ğŸ” setTicketForm í˜¸ì¶œë¨');console.log('ğŸ” ë°›ì€ í‹°ì¼“ ë°ì´í„°:',t);console.log('ğŸ” content_enc ê°’:',t.content_enc);document.getElementById('t_sMember_id').value=t.sMember_id||'';document.getElementById('t_author_name').value=t.author_name||'';document.getElementById('t_status').value=t.status||'new';document.getElementById('t_title_masked').value=t.title_masked||'';document.getElementById('t_content_enc').value=t.content_enc||'';document.getElementById('t_post_pwd_hash').value=t.post_pwd_hash||'';console.log('ğŸ” í¼ì— ì„¤ì •ëœ content_enc:',document.getElementById('t_content_enc').value);document.getElementById('t_post_pwd_hash_row').style.display=isEdit?'':'none';}
function getTicketForm(isEdit){const obj={sMember_id:document.getElementById('t_sMember_id').value.trim(),author_name:document.getElementById('t_author_name').value.trim(),status:document.getElementById('t_status').value,title_masked:document.getElementById('t_title_masked').value.trim(),content_enc:document.getElementById('t_content_enc').value.trim(),};if(isEdit){obj.post_pwd_hash=document.getElementById('t_post_pwd_hash').value.trim();}
return obj;}
btnSaveTicket.addEventListener('click',async()=>{const isEdit=!!editingTicketId;const v=getTicketForm(isEdit);if(!v.sMember_id||!v.title_masked){alert('íšŒì›IDì™€ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}
try{if(isEdit){console.log('ğŸ”„ í‹°ì¼“ ìˆ˜ì • API í˜¸ì¶œ:',editingTicketId);const updateData={title:v.title_masked,content:v.content_enc,author_name:v.author_name,author_contact:v.author_contact||'',status:v.status,post_pwd_hash:v.post_pwd_hash,};console.log('ğŸ“¤ ìˆ˜ì • ë°ì´í„°:',updateData);const response=await fetch(`/secret/api/v1/tickets/${editingTicketId}`,{method:'PUT',headers:{'Content-Type':'application/json',},body:JSON.stringify(updateData),});if(!response.ok){const error=await response.json();throw new Error(error.error||'í‹°ì¼“ ìˆ˜ì • ì‹¤íŒ¨');}
console.log('âœ… í‹°ì¼“ ìˆ˜ì • ì™„ë£Œ');alert('í‹°ì¼“ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');}else{console.log('ğŸ”„ í‹°ì¼“ ì¶”ê°€ API í˜¸ì¶œ');const createData={title:v.title_masked,content:v.content_enc,post_password:'admin123',author_name:v.author_name,author_contact:v.author_contact||'',snsgu:'A0001',agreement:1,};console.log('ğŸ“¤ ì¶”ê°€ ë°ì´í„°:',createData);const response=await fetch('/secret/api/v1/tickets/',{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify(createData),});if(!response.ok){const error=await response.json();throw new Error(error.error||'í‹°ì¼“ ì¶”ê°€ ì‹¤íŒ¨');}
const result=await response.json();console.log('âœ… í‹°ì¼“ ì¶”ê°€ ì™„ë£Œ:',result);alert('í‹°ì¼“ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');}
await loadFromServer();dlgTicket.close();}catch(error){console.error('âŒ í‹°ì¼“ ì €ì¥ ì˜¤ë¥˜:',error);alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);}});dlgTicket.addEventListener('click',(e)=>{if(e.target.matches('[data-close]'))dlgTicket.close();});const dlgMsg=document.getElementById('dlgMsg');const btnAddMsg=document.getElementById('btnAddMsg');const btnEditMsg=document.getElementById('btnEditMsg');const btnDelMsg=document.getElementById('btnDelMsg');const btnSaveMsg=document.getElementById('btnSaveMsg');let editingMsgId=null;btnAddMsg.addEventListener('click',()=>{const tid=state.ui.selectedTicketId;if(!tid)return;editingMsgId=null;document.getElementById('dlgMsgTitle').textContent='ë‹µë³€ ì¶”ê°€';setMsgForm();dlgMsg.showModal();});btnEditMsg.addEventListener('click',()=>{const id=state.ui.selectedMsgId;if(!id)return;editingMsgId=id;document.getElementById('dlgMsgTitle').textContent='ë‹µë³€ ìˆ˜ì •';const m=state.messages.find((x)=>x.message_id===id);setMsgForm(m);dlgMsg.showModal();});btnDelMsg.addEventListener('click',async()=>{const id=state.ui.selectedMsgId;if(!id)return;if(!confirm('ì„ íƒí•œ ë‹µë³€ì„ ì‚­ì œí• ê¹Œìš”?'))return;try{console.log('ğŸ”„ ë©”ì‹œì§€ ì‚­ì œ API í˜¸ì¶œ:',id);const response=await fetch(`/secret/api/v1/admin/messages/${id}`,{method:'DELETE',});if(!response.ok){const error=await response.json();throw new Error(error.error||'ë©”ì‹œì§€ ì‚­ì œ ì‹¤íŒ¨');}
console.log('âœ… ë©”ì‹œì§€ ì‚­ì œ ì™„ë£Œ');alert('ë‹µë³€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');state.ui.selectedMsgId=null;await loadFromServer();btnEditMsg.disabled=true;btnDelMsg.disabled=true;}catch(error){console.error('âŒ ë©”ì‹œì§€ ì‚­ì œ ì˜¤ë¥˜:',error);alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);}});function setMsgForm(m={admin_id:'',role:'ADMIN',visibility:'private',body:''}){document.getElementById('m_admin_id').value=m.admin_id||'';document.getElementById('m_role').value=m.role||'ADMIN';document.getElementById('m_visibility').value=m.visibility||'private';document.getElementById('m_body').value=m.body||'';}
function getMsgForm(){return{admin_id:document.getElementById('m_admin_id').value.trim(),role:document.getElementById('m_role').value,visibility:document.getElementById('m_visibility').value,body:document.getElementById('m_body').value.trim(),};}
btnSaveMsg.addEventListener('click',async()=>{const tid=state.ui.selectedTicketId;if(!tid){alert('í‹°ì¼“ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');return;}
const v=getMsgForm();if(!v.admin_id||!v.body){alert('ê´€ë¦¬ìIDì™€ ë³¸ë¬¸ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}
try{if(editingMsgId){console.log('ğŸ”„ ë©”ì‹œì§€ ìˆ˜ì • API í˜¸ì¶œ:',editingMsgId);console.log('ğŸ“¤ ì „ì†¡ ë°ì´í„°:',{content:v.body,role:v.role});const response=await fetch(`/secret/api/v1/admin/messages/${editingMsgId}`,{method:'PUT',headers:{'Content-Type':'application/json',},body:JSON.stringify({content:v.body,role:v.role,}),});if(!response.ok){const error=await response.json();throw new Error(error.error||'ë©”ì‹œì§€ ìˆ˜ì • ì‹¤íŒ¨');}
console.log('âœ… ë©”ì‹œì§€ ìˆ˜ì • ì™„ë£Œ');alert('ë‹µë³€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');}else{console.log('ğŸ”„ ê´€ë¦¬ì ë‹µë³€ ì¶”ê°€ API í˜¸ì¶œ');console.log('ğŸ“¤ ì „ì†¡ ë°ì´í„°:',{content:v.body,admin_id:v.admin_id,role:v.role,});const response=await fetch(`/secret/api/v1/admin/tickets/${tid}/reply`,{method:'POST',headers:{'Content-Type':'application/json',},body:JSON.stringify({content:v.body,admin_id:v.admin_id,role:v.role,}),});if(!response.ok){const error=await response.json();throw new Error(error.error||'ë‹µë³€ ì¶”ê°€ ì‹¤íŒ¨');}
console.log('âœ… ê´€ë¦¬ì ë‹µë³€ ì¶”ê°€ ì™„ë£Œ');alert('ë‹µë³€ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');}
await loadFromServer();dlgMsg.close();}catch(error){console.error('âŒ ë©”ì‹œì§€ ì €ì¥ ì˜¤ë¥˜:',error);alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);}});dlgMsg.addEventListener('click',(e)=>{if(e.target.matches('[data-close]'))dlgMsg.close();});window.addEventListener('keydown',(e)=>{if(document.querySelector('dialog[open]'))return;if(e.key==='/'){e.preventDefault();(document.activeElement?.closest('#threadsPanel')?searchThreads:searchTickets).focus();return;}
if(e.key==='Delete'){if(document.activeElement?.closest('#threadsPanel'))
btnDelMsg.click();else btnDelTicket.click();}
if(e.key==='Enter'){if(document.activeElement?.closest('#threadsPanel'))
btnEditMsg.click();else btnEditTicket.click();}
const inThreads=document.activeElement?.closest('#threadsPanel');if(e.key==='ArrowDown'||e.key==='ArrowUp'){e.preventDefault();const tbody=inThreads?tblThreads:tblTickets;const rows=[...tbody.querySelectorAll('tr')];if(rows.length===0)return;const selId=inThreads?state.ui.selectedMsgId:state.ui.selectedTicketId;let idx=rows.findIndex((r)=>r.dataset.id===selId);idx=idx<0?0:e.key==='ArrowDown'?Math.min(idx+1,rows.length-1):Math.max(idx-1,0);const id=rows[idx].dataset.id;if(inThreads){state.ui.selectedMsgId=id;save();renderThreads();btnEditMsg.disabled=false;btnDelMsg.disabled=false;}else{selectTicket(id);}
rows[idx].scrollIntoView({block:'nearest'});}});const btnTheme=document.getElementById('btnTheme');btnTheme.addEventListener('click',()=>{const next=document.body.getAttribute('data-theme')==='soft-light'?'soft-dark':'soft-light';document.body.setAttribute('data-theme',next);state.ui.theme=next;save();btnTheme.textContent='í…Œë§ˆ: '+
(next==='soft-light'?'ë¶€ë“œëŸ¬ìš´ ë¼ì´íŠ¸':'ë¶€ë“œëŸ¬ìš´ ë‹¤í¬');});const btnClose=document.getElementById('btnClose');btnClose.addEventListener('click',()=>{if(window.self!==window.top){window.parent.postMessage('closeIframe','*');}else{window.close();}});function escapeHtml(s){return text(s).replace(/[&<>"']/g,(c)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;',}[c]));}
load();document.body.setAttribute('data-theme',state.ui.theme||'soft-light');btnTheme.textContent='í…Œë§ˆ: '+
((state.ui.theme||'soft-light')==='soft-light'?'ë¶€ë“œëŸ¬ìš´ ë¼ì´íŠ¸':'ë¶€ë“œëŸ¬ìš´ ë‹¤í¬');async function loadFromServer(){try{console.log('ğŸ”„ ì„œë²„ DBì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œì‘...');const ticketsResponse=await fetch('/secret/api/v1/tickets/');if(!ticketsResponse.ok){throw new Error(`Tickets API ì˜¤ë¥˜:${ticketsResponse.status}`);}
const ticketsData=await ticketsResponse.json();console.log('ğŸ“¦ Tickets ì›ë³¸ ì‘ë‹µ:',ticketsData);if(Array.isArray(ticketsData)){state.tickets=ticketsData.map((ticket)=>({ticket_id:ticket.ticket_id||ticket.id,sMember_id:ticket.sMember_id||ticket.smember_id||'',author_name:ticket.author_name||'',author_nickname:ticket.author_nickname||'',author_contact:ticket.author_contact||'',title_masked:ticket.title_masked||ticket.title||'',content_enc:ticket.content_enc||'',status:ticket.status||'OPEN',has_admin_reply:ticket.has_admin_reply||false,created_at:ticket.created_at||new Date().toISOString(),updated_at:ticket.updated_at||null,post_pwd_hash:ticket.post_pwd_hash||'',author_phone:ticket.author_phone||'',author_mobile:ticket.author_mobile||'',author_email:ticket.author_email||'',author_gender:ticket.author_gender||'',birth_year:ticket.birth_year||null,snsgu:ticket.snsgu||'',agreement:ticket.agreement||0,}));console.log('âœ… Tickets ë¡œë“œ ì™„ë£Œ:',state.tickets.length,'ê±´');console.log('ğŸ“Š ì²« ë²ˆì§¸ í‹°ì¼“ ìƒ˜í”Œ:',state.tickets[0]);}else{console.warn('âš ï¸ Tickets ì‘ë‹µì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:',ticketsData);state.tickets=[];}
console.log('ğŸ”„ Messages API í˜¸ì¶œ ì‹œì‘...');const messagesResponse=await fetch('/secret/api/v1/messages/');console.log('ğŸ“¡ Messages API ì‘ë‹µ ìƒíƒœ:',messagesResponse.status);console.log('ğŸ“¡ Messages API ì‘ë‹µ OK:',messagesResponse.ok);if(!messagesResponse.ok){console.error('âŒ Messages API ì˜¤ë¥˜ - ìƒíƒœ ì½”ë“œ:',messagesResponse.status);const errorText=await messagesResponse.text();console.error('âŒ ì˜¤ë¥˜ ë‚´ìš©:',errorText);throw new Error(`Messages API ì˜¤ë¥˜:${messagesResponse.status}`);}
const messagesData=await messagesResponse.json();console.log('ğŸ“¦ Messages ì›ë³¸ ì‘ë‹µ:',messagesData);console.log('ğŸ“¦ Messages ì‘ë‹µ íƒ€ì…:',typeof messagesData);console.log('ğŸ“¦ Messages ë°°ì—´ ì—¬ë¶€:',Array.isArray(messagesData));if(Array.isArray(messagesData)){state.messages=messagesData.map((msg)=>({message_id:msg.message_id||msg.msg_id||msg.id,ticket_id:msg.ticket_id,role:msg.role||'admin',content_enc:msg.content_enc||msg.body||'',body:msg.body||msg.content_enc||'',admin_id:msg.admin_id||'',created_at:msg.created_at||new Date().toISOString(),}));console.log('âœ… Thread Messages ë¡œë“œ ì™„ë£Œ:',state.messages.length,'ê±´');if(state.messages.length>0){console.log('ğŸ“Š ì²« ë²ˆì§¸ ë©”ì‹œì§€ ìƒ˜í”Œ:',state.messages[0]);}}else{console.warn('âš ï¸ Messages ì‘ë‹µì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:',messagesData);state.messages=[];}
renderTickets();renderThreads();if(state.tickets.length>0){selectTicket(state.tickets[0].ticket_id);}
save();console.log('âœ… ì„œë²„ ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§ ì™„ë£Œ!');}catch(error){console.error('âŒ ì„œë²„ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:',error);console.error('ìƒì„¸ ì˜¤ë¥˜:',error.message);console.log('ğŸ“‚ localStorage ë°ì´í„° ì‚¬ìš©');renderTickets();renderThreads();if(state.tickets.length>0){selectTicket(state.tickets[0].ticket_id);}}}
loadFromServer();(function checkAdminLogin(){let attempts=0;const maxAttempts=30;function tryCheckAdminLogin(){attempts++;if(typeof window.getAdminSession==='function'){const adminSession=window.getAdminSession();if(!adminSession||!adminSession.isLoggedIn||!adminSession.admin_id){console.log('âŒ ê´€ë¦¬ì ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.');alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');window.location.href='/secret/admin_login';return;}
console.log('âœ… ê´€ë¦¬ì ì¸ì¦ ì™„ë£Œ:',adminSession.username);}else{if(attempts<maxAttempts){setTimeout(tryCheckAdminLogin,100);}else{console.error('âŒ admin_session.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ìµœëŒ€ ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼)');alert('ê´€ë¦¬ì ì„¸ì…˜ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');window.location.href='/secret/admin_login';}}}
tryCheckAdminLogin();})();