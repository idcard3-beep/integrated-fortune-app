<!doctype html><html lang=ko><meta charset=utf-8><meta content="width=device-width,initial-scale=1,viewport-fit=cover" name=viewport><title>회원가입-비밀게시판 회원가입 불필요/ 정회원 단계별 회원가입</title><meta content="light dark" name=color-scheme><style>:root {
        --bg: #f7f8fb;
        --card: #ffffff;
        --ink: #2a3140;
        --ink-sub: #6a7282;
        --line: #e8ebf3;
        --pri: #7da9ff;
        --pri-2: #a9c3ff;
        --ok: #63d3aa;
        --warn: #ffd089;
        --err: #ff8a8a;
        --muted: #f2f4f9;
        --radius: 16px;
        --shadow: 0 8px 24px rgba(116, 130, 170, 0.15);
        --focus: 0 0 0 4px rgba(125, 169, 255, 0.4);
        --tap: 44px;
      }
      html[data-theme='dark'] {
        --bg: #0e1116;
        --card: #12161d;
        --ink: #e9edf5;
        --ink-sub: #a8b2c3;
        --line: #232a35;
        --muted: #171b23;
        --shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
        --pri: #80b2ff;
        --pri-2: #9fc6ff;
        --ok: #6ee3ba;
        --warn: #ffd894;
        --err: #ff9b9b;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: radial-gradient(
            1400px 700px at 0% -10%,
            rgba(125, 169, 255, 0.25),
            transparent 65%
          ),
          radial-gradient(
            1400px 700px at 100% 10%,
            rgba(99, 211, 170, 0.2),
            transparent 60%
          ),
          radial-gradient(
            800px 400px at 50% 50%,
            rgba(255, 208, 137, 0.08),
            transparent 70%
          ),
          var(--bg);
        color: var(--ink);
        font: 13px/1.6 system-ui, -apple-system, Segoe UI, Roboto,
          'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;
      }
      .wrap {
        max-width: 980px;
        margin: auto;
        padding: 24px 20px;
        display: grid;
        gap: 18px;
      }
      .head {
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: space-between;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .brand-dot {
        width: 32px;
        height: 32px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--pri) 0%, var(--ok) 100%);
        box-shadow: 0 4px 12px rgba(125, 169, 255, 0.4),
          inset 0 1px 2px rgba(255, 255, 255, 0.5);
        animation: pulse 3s ease-in-out infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }
      h1 {
        font-size: 19px;
        margin: 0 0 3px;
        font-weight: 700;
        background: linear-gradient(135deg, var(--pri), var(--ok));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      .sub {
        color: var(--ink-sub);
        font-size: 12px;
      }
      .theme-toggle {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        border: 1px solid var(--line);
        background: var(--muted);
        padding: 8px 12px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 700;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px;
        transition: all 0.3s ease;
      }
      .card:hover {
        box-shadow: 0 12px 32px rgba(116, 130, 170, 0.2);
        transform: translateY(-2px);
      }
      .steps {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 8px;
      }
      .steps span {
        text-align: center;
        font-size: 12px;
        color: var(--ink-sub);
        padding: 10px 8px;
        border-radius: 14px;
        border: 2px solid transparent;
        background: linear-gradient(var(--card), var(--card)) padding-box,
          linear-gradient(135deg, var(--line), transparent) border-box;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: all 0.3s ease;
        position: relative;
      }
      .steps span::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          rgba(125, 169, 255, 0.1),
          rgba(99, 211, 170, 0.1)
        );
        border-radius: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .steps span:hover::before {
        opacity: 1;
      }
      .steps .active {
        background: linear-gradient(135deg, var(--pri) 0%, var(--pri-2) 100%);
        color: #fff;
        border-color: transparent;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(125, 169, 255, 0.4);
        transform: scale(1.05);
      }
      .progress {
        height: 8px;
        background: var(--muted);
        border-radius: 999px;
        overflow: hidden;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .bar {
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, var(--pri) 0%, var(--ok) 100%);
        transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 0 8px rgba(125, 169, 255, 0.5);
        position: relative;
      }
      .bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: shimmer 2s infinite;
      }
      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }
      .section {
        display: block;
      }
      .section[hidden] {
        display: none;
      }
      h3 {
        font-size: 17px;
        margin: 0 0 10px 0;
        font-weight: 700;
        color: var(--ink);
        position: relative;
        padding-left: 12px;
      }
      h3::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 18px;
        background: linear-gradient(135deg, var(--pri), var(--ok));
        border-radius: 2px;
      }
      .grid {
        display: grid;
        gap: 8px;
      }
      .g2 {
        grid-template-columns: 1fr;
      }
      .g3 {
        grid-template-columns: 1fr;
      }
      @media (min-width: 760px) {
        .g2 {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (min-width: 980px) {
        .g3 {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      label {
        display: block;
        font-weight: 600;
        margin: 0 0 4px 0;
        color: var(--ink);
        font-size: 13px;
        line-height: 1.3;
      }
      .row {
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: wrap;
      }
      input[type='text'],
      input[type='password'],
      input[type='email'],
      input[type='date'],
      input[type='number'],
      select,
      textarea {
        width: 100%;
        padding: 8px 10px;
        min-height: 38px;
        border-radius: 10px;
        border: 2px solid var(--line);
        background: var(--card);
        color: var(--ink);
        outline: none;
        font-size: 13px;
        transition: all 0.25s ease;
        line-height: 1.4;
      }
      input:hover,
      select:hover,
      textarea:hover {
        border-color: var(--pri-2);
      }
      textarea {
        min-height: 70px;
        resize: vertical;
        line-height: 1.4;
      }
      input:focus,
      select:focus,
      textarea:focus {
        box-shadow: var(--focus);
        border-color: var(--pri);
        background: var(--card);
      }
      .hint {
        font-size: 11px;
        color: var(--ink-sub);
        margin: 3px 2px 0;
        display: flex;
        align-items: center;
        gap: 3px;
        line-height: 1.3;
      }
      .hint::before {
        content: '💡';
        font-size: 12px;
      }
      .error {
        font-size: 11px;
        color: var(--err);
        display: none;
        margin: 3px 2px 0;
        font-weight: 600;
        line-height: 1.3;
      }
      .oktxt {
        font-size: 11px;
        color: var(--ok);
        display: none;
        margin: 3px 2px 0;
        font-weight: 600;
        line-height: 1.3;
      }

      .scroll {
        max-height: 120px;
        overflow: auto;
        border: 2px solid var(--line);
        border-radius: 10px;
        background: linear-gradient(var(--card), var(--muted));
        padding: 10px;
        line-height: 1.5;
        font-size: 12px;
      }
      .pill {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        padding: 6px 10px;
        border-radius: 999px;
        border: 2px solid var(--line);
        background: linear-gradient(135deg, var(--card), var(--muted));
        font-size: 12px;
        font-weight: 600;
        transition: all 0.25s ease;
      }
      .pill:hover {
        border-color: var(--pri);
        box-shadow: 0 2px 8px rgba(125, 169, 255, 0.2);
        transform: translateY(-1px);
      }
      .box {
        border: 2px solid var(--line);
        border-radius: 12px;
        padding: 10px;
        background: linear-gradient(
          135deg,
          rgba(169, 195, 255, 0.15),
          rgba(99, 211, 170, 0.1)
        );
        margin: 6px 0;
      }
      .divider {
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent,
          var(--line),
          transparent
        );
        margin: 8px 0;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .btn {
        appearance: none;
        border: 0;
        border-radius: 12px;
        padding: 9px 14px;
        min-height: 38px;
        cursor: pointer;
        font-weight: 700;
        font-size: 13px;
        transition: all 0.25s ease;
        position: relative;
        overflow: hidden;
      }
      .btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.4s, height 0.4s;
      }
      .btn:hover::before {
        width: 300px;
        height: 300px;
      }
      .btn.pri {
        background: linear-gradient(135deg, var(--pri) 0%, var(--pri-2) 100%);
        color: #fff;
        box-shadow: 0 4px 12px rgba(125, 169, 255, 0.3);
      }
      .btn.pri:hover {
        box-shadow: 0 6px 20px rgba(125, 169, 255, 0.4);
        transform: translateY(-2px);
      }
      .btn.ghost {
        background: var(--card);
        color: var(--ink);
        border: 2px solid var(--line);
      }
      .btn.ghost:hover {
        border-color: var(--pri);
        background: var(--muted);
      }
      .btn.ok {
        background: linear-gradient(135deg, var(--ok) 0%, #57caa0 100%);
        color: #fff;
        box-shadow: 0 4px 12px rgba(99, 211, 170, 0.3);
      }
      .btn.ok:hover {
        box-shadow: 0 6px 20px rgba(99, 211, 170, 0.4);
        transform: translateY(-2px);
      }
      .btn.warn {
        background: linear-gradient(135deg, var(--warn) 0%, #ffc76d 100%);
        color: #5c3c00;
        box-shadow: 0 4px 12px rgba(255, 208, 137, 0.3);
      }
      .btn.warn:hover {
        box-shadow: 0 6px 20px rgba(255, 208, 137, 0.4);
        transform: translateY(-2px);
      }
      .btn.full {
        width: 100%;
      }
      .btn:active {
        transform: translateY(0px) scale(0.98);
      }
      .btn.full {
        width: 100%;
      }
      .sumlist {
        display: grid;
        gap: 8px;
      }
      .sumlist .item {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 8px;
        padding: 9px;
        border-radius: 10px;
        background: linear-gradient(
          135deg,
          rgba(125, 169, 255, 0.05),
          rgba(99, 211, 170, 0.05)
        );
        border: 1px solid var(--line);
      }
      @media (max-width: 520px) {
        .sumlist .item {
          grid-template-columns: 1fr;
          gap: 4px;
        }
        .sumlist .item div:first-child {
          opacity: 0.8;
          font-weight: 600;
          font-size: 12px;
        }
      }
      .preview {
        width: 160px;
        height: 160px;
        border-radius: 14px;
        border: 3px dashed var(--line);
        background: linear-gradient(135deg, var(--muted), var(--card));
        display: grid;
        place-items: center;
        overflow: hidden;
        transition: all 0.3s ease;
      }
      .preview:hover {
        border-color: var(--pri);
        box-shadow: 0 4px 16px rgba(125, 169, 255, 0.2);
      }
      .preview img {
        max-width: 100%;
        max-height: 100%;
        display: block;
        border-radius: 10px;
      }
      .tools {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .meter {
        height: 8px;
        background: var(--muted);
        border-radius: 999px;
        overflow: hidden;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .meter > div {
        height: 100%;
        width: 0;
        background: linear-gradient(
          90deg,
          #ff9b9b 0%,
          #ffd089 33%,
          #a9c3ff 66%,
          #63d3aa 100%
        );
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 0 10px rgba(125, 169, 255, 0.4);
      }
      .small {
        font-size: 12px;
        color: var(--ink-sub);
        line-height: 1.4;
      }
      @media (max-width: 760px) {
        .sticky-nav {
          position: sticky;
          bottom: 0;
          padding: 10px;
          background: linear-gradient(180deg, transparent, var(--bg) 30%);
          backdrop-filter: saturate(1.4) blur(10px);
          border-radius: 14px 14px 0 0;
          box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
        }
      }

      /* (신규) 서명 패드 레이아웃 */
      .sign-wrap {
        display: grid;
        gap: 10px;
        padding: 10px;
        border-radius: 14px;
        background: linear-gradient(
          135deg,
          rgba(125, 169, 255, 0.05),
          rgba(99, 211, 170, 0.05)
        );
        border: 2px solid var(--line);
      }
      .sign-pad {
        width: 100%;
        max-width: 680px;
        height: 200px;
        border-radius: 12px;
        border: 3px solid var(--line);
        background: var(--card);
        touch-action: none;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }
      .sign-pad:hover {
        border-color: var(--pri);
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05),
          0 0 0 4px rgba(125, 169, 255, 0.1);
      }
      .sign-tools {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }</style><script defer src=https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js></script><body><main class=wrap role=main><header aria-label=제목 class=head><div class=brand><div aria-hidden=true class=brand-dot></div><div><h1>회원가입</h1></div></div><button title="다크/라이트 모드 전환" aria-pressed=false class=theme-toggle id=themeBtn type=button>라이트</button></header><section aria-label=진행도 class=card><div class=steps id=steps><span class=active id=s1>1. 약관</span><span id=s2>2. 기본</span><span id=s3>3. 연락/주소</span><span id=s4>4. 선택/상담</span><span id=s5>5. 서명하기</span><span id=s6>6. 확인</span></div><div aria-hidden=true class=progress><div class=bar id=bar></div></div></section><form autocomplete=on class=card id=form novalidate><section aria-label="약관 및 개인정보 동의" class=section data-step=1><h3>이용약관 & 개인정보 수집·이용 동의</h3><div class="grid g2"><div><label>이용약관</label><div class=scroll tabindex=0><p><strong>제 1 장 총칙</strong><br><br> <strong>제 1 조 (목적)</strong><br> 본 약관은 심리상담소 나라톡톡에서 운영하는 나라톡톡 운영시스템홈페이지(이하 "당 사이트")에서 제공하는 모든 서비스(이하 "서비스")의 이용조건 및 절차, 이용자와 당 사이트의 권리, 의무, 책임사항과 기타 필요한 사항을 규정함을 목적으로 합니다.<br><br> <strong>제 6 조 (약관의 효력과 변경)</strong><br> ① 당 사이트는 이용자가 본 약관 내용에 동의하는 것을 조건으로 이용자에게 서비스를 제공하며, 당 사이트의 서비스 제공 행위 및 이용자의 서비스 사용 행위에는 본 약관을 우선적으로 적용하겠습니다.<br> ② 당 사이트는 본 약관을 사전 고지 없이 변경할 수 있으며, 변경된 약관은 당 사이트 내에 공지함으로써 이용자가 직접 확인하도록 할 것입니다. 이용자가 변경된 약관에 동의하지 아니하는 경우 본인의 상담요청등록을 취소(회원탈퇴)할 수 있으며, 계속 사용할 경우에는 약관 변경에 대한 암묵적 동의로 간주됩니다. 변경된 약관은 공지와 동시에 그 효력을 발휘합니다.</div><label style="margin-top: 8px" class=pill><input aria-required=true id=agree_terms required type=checkbox> 이용약관에 동의합니다 (필수)</label></div><div><label>개인정보 수집·이용</label><div class=scroll tabindex=0><strong>1. 개인정보의 수집항목 및 수집방법</strong><br> 심리상담소 나라톡톡은 나라톡톡 운영시스템 홈페이지에서는 기본적인 회원 서비스 제공을 위한 필수정보로 실명인증정보와 가입정보, 개인가맹, 기업가맹등으로 구분하여 다음의 정보를 수집할수도 있습니다. 필수정보를 입력해주셔야 회원 서비스 이용이 가능합니다.<br><br><strong>[컴퓨터에 의해 자동으로 수집되는 정보]</strong><br> 인터넷 서비스 이용과정에서 아래 개인정보 항목이 자동으로 생성되어 수집될 수 있습니다.<br>   - IP주소, 서비스 이용기록, 상담기록 등</div><label style="margin-top: 8px" class=pill><input aria-required=true id=agree_privacy required type=checkbox> 개인정보 처리에 동의합니다 (필수)</label></div></div><p class=hint>* 필수 항목 동의 후 계속할 수 있어요.<div class="toolbar sticky-nav"><button class="btn pri full" data-next type=button>다음</button></div></section><section aria-label=기본정보 class=section data-step=2 hidden><h3>기본정보</h3><div class="grid g2"><div><label for=sMem_id>회원등록 멤버id</label><div class=row><input placeholder="예) user123 또는 abc@example.com" id=sMem_id inputmode=latin-prose maxlength=50 name=sMem_id required><button class="btn ghost" title="아이디 중복 확인" id=idCheckBtn type=button>중복확인</button></div><div class=oktxt id=idOk>사용 가능한 아이디입니다.</div><div class=error data-err=sMem_id>아이디를 입력하세요.</div></div><div class=grid><div><label for=sMem_pwdHash>비번</label><div class=row><input placeholder="6자 이상" id=sMem_pwdHash minlength=6 name=sMem_pwdHash required type=password><button class="btn ghost" title="비밀번호 보이기/숨기기" id=pwdToggle type=button>보기</button></div><div aria-label="비밀번호 강도" class=meter><div id=pwdStrengthBar></div></div><div class=small id=pwdStrengthTxt>비밀번호 강도: -</div><div class=error data-err=sMem_pwdHash>비밀번호(6자 이상)를 입력하세요.</div></div><div><label for=pwd2>비밀번호 확인</label><input placeholder="다시 입력" id=pwd2 minlength=6 required type=password><div class=error data-err=pwd2>비밀번호가 일치하지 않습니다.</div></div></div><div><label for=sMem_name>이름(본명)</label><input id=sMem_name maxlength=50 name=sMem_name required><div class=error data-err=sMem_name>이름(본명)을 입력하세요.</div></div><div><label for=sMem_nickname>닉네임</label><input id=sMem_nickname maxlength=50 name=sMem_nickname></div><div><label for=sMem_birthdt>생일</label><input id=sMem_birthdt name=sMem_birthdt type=date></div><div><label for=sMem_birth_year>태어난 연도 4자리</label><input id=sMem_birth_year inputmode=numeric max=2100 min=1900 name=sMem_birth_year type=number></div><div><label for=sMem_calendar_type>양력.음력 구분</label><select id=sMem_calendar_type name=sMem_calendar_type required><option selected value=양력>양력<option value=음력>음력</select></div><div style="display: none;" id=yundalContainer><label for=sMem_yundal><input id=sMem_yundal name=sMem_yundal type=checkbox> 윤달</label></div><div><label>남여구분</label><label class=pill><input name=sMem_gender required type=radio value=M> 남(M)</label><label class=pill><input name=sMem_gender required type=radio value=F> 여(F)</label><div class=error data-err=sMem_gender>성별을 선택하세요.</div></div></div><div class="toolbar sticky-nav"><button class="btn ghost" data-prev type=button>이전</button><button class="btn pri" data-next type=button>다음</button></div></section><section aria-label="연락처 및 주소" class=section data-step=3 hidden><h3>연락처 & 주소</h3><div class="grid g2"><div><label for=sMem_buss_name>자영업자상호</label><input id=sMem_buss_name maxlength=100 name=sMem_buss_name></div><div><label for=sMem_comp_name>회사명</label><input id=sMem_comp_name maxlength=100 name=sMem_comp_name></div><div><label for=sMem_phone>전화번호</label><input id=sMem_phone inputmode=tel maxlength=20 name=sMem_phone placeholder=02-1234-5678></div><div><label for=sMem_mobile>휴대폰</label><input id=sMem_mobile inputmode=tel maxlength=13 name=sMem_mobile placeholder=010-1234-5678 required><div class=hint>형식: 010-1234-5678</div><div class=error data-err=sMem_mobile>유효한 휴대폰 번호를 입력하세요.</div></div><div><label for=sMem_email>멤버email</label><input id=sMem_email inputmode=email maxlength=100 name=sMem_email placeholder=you@example.com required type=email><div class=error data-err=sMem_email>유효한 이메일을 입력하세요.</div></div><div></div><div class=box><strong>기본 주소</strong><div class="grid g3" style="margin-top: 6px"><div><label for=zipcode>우편번호</label><div class=row><input id=zipcode inputmode=numeric maxlength=10 name=zipcode><button class="btn ghost" onclick="openPostcode('zipcode','address1')" title="우편번호 검색" type=button>찾기</button></div></div><div style="grid-column: span 2" class=g3><label for=address1>기본주소</label><input id=address1 maxlength=200 name=address1><label style="margin-top: 6px" for=address2>상세주소</label><input id=address2 maxlength=200 name=address2></div></div></div><div class=box><div class=row><strong>별도 주소 (옵션) </strong><label class=pill><input id=copyAddr type=checkbox> 기본 주소와 동일</label></div><div class="grid g3" style="margin-top: 6px"><div><label for=zipcode_s>우편번호(별도)</label><div class=row><input id=zipcode_s inputmode=numeric maxlength=10 name=zipcode_s><button class="btn ghost" onclick="openPostcode('zipcode_s','address1_s')" title="우편번호 검색" type=button>찾기</button></div></div><div style="grid-column: span 2" class=g3><label for=address1_s>기본주소(별도)</label><input id=address1_s maxlength=200 name=address1_s><label style="margin-top: 6px" for=address2_s>상세주소(별도)</label><input id=address2_s maxlength=200 name=address2_s></div></div></div></div><div class="toolbar sticky-nav"><button class="btn ghost" data-prev type=button>이전</button><button class="btn pri" data-next type=button>다음</button></div></section><section aria-label="선택 항목 및 상담" class=section data-step=4 hidden><h3>선택항목 & 상담내용</h3><div class="grid g2"><div><label for=sMem_snsgu>고객구분</label><select id=sMem_snsgu name=sMem_snsgu><option value>선택<option>일반<option>학생<option>부모<option>커플<option>기업</select></div><div><label style="margin-top: 28px" class=pill><input id=sMem_agree name=sMem_agree type=checkbox> 동의여부 (상담내역/안내 수신 선택)</label></div><div class=box><strong>컬러/동물/인형 선택값 (0~100)</strong><div style="margin-top: 8px"><div style="color: var(--ink-sub);
                    font-size: 12px;
                    margin-bottom: 4px;
                    font-weight: 600;">🎨 Color 선택</div><div style="grid-template-columns: repeat(4, 1fr); gap: 6px" class=grid><div><label for=c1>color선택1</label><input id=c1 max=100 min=0 name=sMem_choice1 type=number value=0></div><div><label for=c2>color선택2</label><input id=c2 max=100 min=0 name=sMem_choice2 type=number value=0></div><div><label for=c3>color선택3</label><input id=c3 max=100 min=0 name=sMem_choice3 type=number value=0></div><div><label for=c4>color선택4</label><input id=c4 max=100 min=0 name=sMem_choice4 type=number value=0></div></div></div><div style="margin-top: 10px"><div style="color: var(--ink-sub);
                    font-size: 12px;
                    margin-bottom: 4px;
                    font-weight: 600;">🐾 동물 선택</div><div style="grid-template-columns: repeat(4, 1fr); gap: 6px" class=grid><div><label for=a1>동물선택1</label><input id=a1 max=100 min=0 name=sMem_choice5 type=number value=0></div><div><label for=a2>동물선택2</label><input id=a2 max=100 min=0 name=sMem_choice6 type=number value=0></div><div><label for=a3>동물선택3</label><input id=a3 max=100 min=0 name=sMem_choice7 type=number value=0></div><div><label for=a4>동물선택4</label><input id=a4 max=100 min=0 name=sMem_choice8 type=number value=0></div></div></div><div style="margin-top: 10px"><div style="color: var(--ink-sub);
                    font-size: 12px;
                    margin-bottom: 4px;
                    font-weight: 600;">🧸 인형 선택</div><div style="grid-template-columns: repeat(4, 1fr); gap: 6px" class=grid><div><label for=d1>인형선택1</label><input id=d1 max=100 min=0 name=sMem_choice9 type=number value=0></div><div><label for=d2>인형선택2</label><input id=d2 max=100 min=0 name=sMem_choice10 type=number value=0></div><div><label for=d3>인형선택3</label><input id=d3 max=100 min=0 name=sMem_choice11 type=number value=0></div><div><label for=d4>인형선택4</label><input id=d4 max=100 min=0 name=sMem_choice12 type=number value=0></div></div></div><p class=hint>타고난 본인의 컬러는 상담시에 필요합니다.</div><div><label for=sMem_quest>상담질문사항</label><textarea placeholder="상담받고 싶은 내용을 간단히 적어 주세요." id=sMem_quest name=sMem_quest></textarea></div><div><label for=sMem_content_enc>상담 문의내용 (암호화 또는 평문)</label><textarea placeholder="민감정보는 서버에서 암호화 저장 권장" id=sMem_content_enc name=sMem_content_enc></textarea></div><div class="grid g2"><div><label for=old_name>개명전이름</label><input id=old_name maxlength=50 name=old_name></div><div><label for=new_name>개명후이름</label><input id=new_name maxlength=50 name=new_name></div><div><label for=sMemfam_id>추천인id</label><input id=sMemfam_id maxlength=50 name=sMemfam_id></div><div><label for=recommender>추천인성명</label><input id=recommender maxlength=50 name=recommender></div><div><label for=applicant>신청인</label><input id=applicant maxlength=50 name=applicant></div><div style="grid-column: 1/-1"><label for=reference>상담답변내용 or 참고사항</label><textarea id=reference name=reference></textarea></div></div></div><div class="toolbar sticky-nav"><button class="btn ghost" data-prev type=button>이전</button><button class="btn pri" data-next type=button>다음</button></div></section><section aria-label=서명하기 class=section data-step=5 hidden><h3>서명하기</h3><div style="margin-bottom: 20px"><div><label for=signature_file>이미지파일 경로(단순 이미지 보기용-서명과는 무관 합니다.)</label><input accept=image/png,image/jpeg,image/webp id=signature_file name=signature_file type=file><div class=hint>허용: PNG/JPEG/WebP, 최대 2MB</div><div class=tools><button class="btn ghost" id=rotateBtn type=button>회전 90°</button><button class="btn ghost" id=cropBtn type=button>정사각 자르기</button><button class="btn warn" id=resetImgBtn type=button>원본 미리보기</button></div></div><div class=preview id=sigPreview><span style="color: var(--ink-sub)">미리보기</span></div></div><div class=sign-wrap><div class=small>마우스(또는 터치)로 패드 위에 서명해 주세요.</div><canvas aria-label="서명 패드" class=sign-pad id=signPad></canvas><div class=sign-tools><button class="btn ghost" title="서명 초기화" id=signClear type=button>서명 초기화</button><button class="btn pri" title="서명 저장" id=signSave type=button>서명 저장</button><label style="display: inline-flex; align-items: center; gap: 6px" class=small for=penColor>선 색상 <input style="width: 36px;
                    height: 28px;
                    padding: 0;
                    border: 0;
                    background: transparent;" id=penColor type=color value=#111111></label><label style="display: inline-flex; align-items: center; gap: 6px" class=small for=penWidth>선 굵기 <input id=penWidth max=6 min=1 step=0.5 type=range value=2.5></label><span aria-live=polite class=small id=signStatus></span></div><div class=preview id=signPreviewBox><span style="color: var(--ink-sub)">서명 미리보기</span></div><input id=signature_canvas_data name=signature_canvas_data required type=hidden></div><div class="toolbar sticky-nav"><button class="btn ghost" data-prev type=button>이전</button><button class="btn pri" data-next type=button>다음</button></div></section><section aria-label="최종 확인 및 제출" class=section data-step=6 hidden><h3>최종 확인 & 제출</h3><p class=hint id=submitHint>아래 정보를 확인하고 제출 버튼을 클릭하세요.<div class="sumlist box" id=summary></div><div class=divider></div><div class="toolbar sticky-nav"><button class="btn ghost" data-prev type=button>이전</button><button class="btn ok" id=submitBtn>제출</button><button class="btn warn" style="display: none" id=deleteBtn type=button>삭제</button></div></section></form><p class=sub>※ 회원가입시 회원등록 멤버id는 메일로도 가능합니다.</main><script>/* ====== 다크/라이트 토글 (원본 유지) ====== */
      (function themeInit() {
        const btn = document.getElementById('themeBtn');
        const saved = localStorage.getItem('theme');
        if (saved) document.documentElement.setAttribute('data-theme', saved);
        btn.textContent =
          document.documentElement.getAttribute('data-theme') === 'dark'
            ? '다크'
            : '라이트';
        btn.setAttribute(
          'aria-pressed',
          document.documentElement.getAttribute('data-theme') === 'dark'
        );
        btn.addEventListener('click', () => {
          const cur = document.documentElement.getAttribute('data-theme');
          const next = cur === 'dark' ? '' : 'dark';
          if (next) document.documentElement.setAttribute('data-theme', next);
          else document.documentElement.removeAttribute('data-theme');
          localStorage.setItem('theme', next);
          btn.textContent = next === 'dark' ? '다크' : '라이트';
          btn.setAttribute('aria-pressed', next === 'dark');
        });
      })();

      /* ====== 단계 제어/검증/요약 (필요 최소 변경: 총단계 6, 요약 단계 6) ====== */
      (() => {
        const form = document.getElementById('form');
        const stepsEls = [...document.querySelectorAll('#steps span')];
        const sections = [...document.querySelectorAll('[data-step]')];
        const progressBar = document.getElementById('bar');
        let cur = 1,
          total = sections.length;

        const reqByStep = {
          1: ['agree_terms', 'agree_privacy'],
          2: [
            'sMem_id',
            'sMem_pwdHash',
            'pwd2',
            'sMem_name',
            'sMem_calendar_type',
            'sMem_gender',
          ],
          3: ['sMem_mobile', 'sMem_email'],
          4: [],
          5: ['signature_canvas_data'] /* (추가) 5단계 서명 필수 */,
          6: [],
        };

        function setProgress() {
          progressBar.style.width = ((cur - 1) / (total - 1)) * 100 + '%';
          stepsEls.forEach((s, i) => s.classList.toggle('active', i < cur));
        }
        function show(n) {
          sections.forEach((sec) => (sec.hidden = +sec.dataset.step !== n));
          cur = n;
          setProgress();
          if (cur === 6) renderSummary();
        }
        function next() {
          if (!validate(cur)) return;
          if (cur < total) {
            show(cur + 1);
            saveDraft();
          }
        }
        function prev() {
          if (cur > 1) show(cur - 1);
        }

        document
          .querySelectorAll('[data-next]')
          .forEach((b) => b.addEventListener('click', next));
        document
          .querySelectorAll('[data-prev]')
          .forEach((b) => b.addEventListener('click', prev));

        /* 양력/음력 선택 시 윤달 체크박스 활성화/비활성화 */
        const calendarType = document.getElementById('sMem_calendar_type');
        const yundalContainer = document.getElementById('yundalContainer');
        const yundalCheckbox = document.getElementById('sMem_yundal');
        
        function toggleYundalCheckbox() {
          if (calendarType && yundalContainer && yundalCheckbox) {
            const isLunar = calendarType.value === '음력';
            if (isLunar) {
              yundalContainer.style.display = 'block';
              yundalCheckbox.disabled = false;
            } else {
              yundalContainer.style.display = 'none';
              yundalCheckbox.disabled = true;
              yundalCheckbox.checked = false; // 양력 선택 시 윤달 체크 해제
            }
          }
        }
        
        // 초기 상태 설정
        toggleYundalCheckbox();
        
        // 달력 타입 변경 시 이벤트 리스너
        calendarType?.addEventListener('change', toggleYundalCheckbox);

        /* 기본↔별도 주소 동기화 체크 (원본 유지) */
        const copyAddr = document.getElementById('copyAddr');
        copyAddr?.addEventListener('change', () => {
          ['zipcode', 'address1', 'address2'].forEach((k) => {
            const src = document.getElementById(k),
              dst = document.getElementById(k + '_s');
            if (!src || !dst) return;
            if (copyAddr.checked) {
              dst.value = src.value;
              dst.readOnly = true;
            } else {
              dst.readOnly = false;
            }
          });
        });

        /* 서명 파일 미리보기/간단도구 (원본 유지) */
        const sigInput = document.getElementById('signature_file');
        const sigPrev = document.getElementById('sigPreview');
        let originalUrl = null,
          displayUrl = null,
          rotation = 0;

        sigInput?.addEventListener('change', () => {
          const f = sigInput.files?.[0];
          sigPrev.innerHTML =
            '<span style="color:var(--ink-sub)">미리보기</span>';
          rotation = 0;
          URL.revokeObjectURL(originalUrl);
          URL.revokeObjectURL(displayUrl);
          if (f) {
            const okType = ['image/png', 'image/jpeg', 'image/webp'].includes(
              f.type
            );
            if (!okType) {
              alert('PNG/JPEG/WebP만 업로드 가능합니다.');
              sigInput.value = '';
              return;
            }
            if (f.size > 2 * 1024 * 1024) {
              alert('파일 용량은 최대 2MB까지 허용됩니다.');
              sigInput.value = '';
              return;
            }
            originalUrl = URL.createObjectURL(f);
            displayUrl = originalUrl;
            renderPreview();
          }
        });

        function renderPreview() {
          if (!displayUrl) {
            sigPrev.innerHTML =
              '<span style="color:var(--ink-sub)">미리보기</span>';
            return;
          }
          sigPrev.innerHTML = '';
          const img = new Image();
          img.onload = () => {
            sigPrev.innerHTML = '';
            sigPrev.appendChild(img);
          };
          img.src = displayUrl + '#' + Math.random();
          img.style.transform = `rotate(${rotation}deg)`;
          img.style.transition = 'transform .2s ease';
        }
        document.getElementById('rotateBtn')?.addEventListener('click', () => {
          if (!displayUrl) return;
          rotation = (rotation + 90) % 360;
          renderPreview();
        });
        document.getElementById('cropBtn')?.addEventListener('click', () => {
          if (!displayUrl) return;
          const img = new Image();
          img.onload = () => {
            const side = Math.min(img.width, img.height);
            const sx = Math.floor((img.width - side) / 2);
            const sy = Math.floor((img.height - side) / 2);
            const canvas = document.createElement('canvas');
            canvas.width = side;
            canvas.height = side;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, sx, sy, side, side, 0, 0, side, side);
            displayUrl = canvas.toDataURL('image/png');
            rotation = 0;
            renderPreview();
          };
          img.src = displayUrl;
        });
        document
          .getElementById('resetImgBtn')
          ?.addEventListener('click', () => {
            if (!originalUrl) return;
            displayUrl = originalUrl;
            rotation = 0;
            renderPreview();
          });

        /* 입력 검증 강화 (원본 유지) */
        const m = document.getElementById('sMem_mobile');
        m?.addEventListener('input', () => {
          let v = m.value.replace(/[^\d]/g, '');
          if (v.startsWith('010')) {
            if (v.length > 3 && v.length <= 7)
              v = v.replace(/^(\d{3})(\d+)/, '$1-$2');
            else if (v.length > 7)
              v = v.replace(/^(\d{3})(\d{4})(\d+)/, '$1-$2-$3');
          } else {
            if (v.length > 3) v = v.replace(/^(\d{3})(\d+)/, '$1-$2');
            if (v.length > 8) v = v.replace(/^(\d+)-(\d{4})(\d+)/, '$1-$2-$3');
          }
          m.value = v.slice(0, 13);
        });
        const email = document.getElementById('sMem_email');

        // 아이디 중복 확인 상태 추적 변수
        let isIdChecked = false;
        let lastCheckedId = '';

        const id = document.getElementById('sMem_id');
        const idOk = document.getElementById('idOk');
        const idBtn = document.getElementById('idCheckBtn');

        // 아이디 입력 필드 변경 시 중복확인 상태 초기화
        id?.addEventListener('input', () => {
          if (id.value.trim() !== lastCheckedId) {
            isIdChecked = false;
            idOk.style.display = 'none';
          }
        });

        // API 경로를 동적으로 생성하는 헬퍼 함수
        function getApiBase() {
          return window.location.pathname.startsWith('/secret/') 
            ? '/secret/api/v1' 
            : '/api/v1';
        }

        idBtn?.addEventListener('click', async () => {
          const v = (id.value || '').trim();
          idOk.style.display = 'none';
          isIdChecked = false;

          if (!v) {
            alert('아이디를 입력하세요.');
            id.focus();
            return;
          }

          // 입력한 아이디로 직접 중복 확인
          try {
            console.log('🔍 아이디 중복 확인 시작:', v);
            // 통합 앱과 standalone 앱 모두 지원
            const apiBase = getApiBase();
            const response = await fetch(
              `${apiBase}/smembers/check/${encodeURIComponent(v)}`
            );
            console.log('📡 API 응답 상태:', response.status);

            const result = await response.json();
            console.log('📋 API 응답 데이터:', result);

            if (result.exists) {
              alert('❌ 이미 사용 중인 아이디입니다.');
              id.focus();
              isIdChecked = false;
              lastCheckedId = '';
            } else {
              alert('✅ 사용 가능한 아이디입니다.');
              idOk.style.display = 'block';
              isIdChecked = true;
              lastCheckedId = v;
              setTimeout(() => (idOk.style.display = 'none'), 3000);
            }
          } catch (error) {
            console.error('❌ 아이디 중복 확인 오류:', error);
            alert('❌ 서버 연결 오류가 발생했습니다.');
            isIdChecked = false;
          }
        });

        /* 비밀번호 토글 + 강도 (원본 유지) */
        const pwd = document.getElementById('sMem_pwdHash');
        const pwd2 = document.getElementById('pwd2');
        const pwdToggle = document.getElementById('pwdToggle');
        const pwdBar = document.getElementById('pwdStrengthBar');
        const pwdLabel = document.getElementById('pwdStrengthTxt');

        pwdToggle?.addEventListener('click', () => {
          const t = pwd.type === 'password' ? 'text' : 'password';
          pwd.type = t;
          pwd2.type = t;
          pwdToggle.textContent = t === 'text' ? '숨기기' : '보기';
        });
        pwd?.addEventListener('input', () => {
          const s = scorePwd(pwd.value);
          pwdBar.style.width = Math.min(s * 25, 100) + '%';
          const txt = ['매우 약함', '약함', '보통', '좋음', '매우 강함'][
            Math.min(s, 4)
          ];
          pwdLabel.textContent = '강도: ' + txt;
        });
        function scorePwd(p) {
          let s = 0;
          if (!p) return s;
          if (p.length >= 6) s++;
          if (/[A-Z]/.test(p)) s++;
          if (/[a-z]/.test(p)) s++;
          if (/\d/.test(p)) s++;
          if (/[^A-Za-z0-9]/.test(p)) s++;
          if (p.length >= 12) s++;
          return Math.min(s, 4);
        }

        /* 검증 루틴 (원본 유지 + 5단계 서명 필수 추가) */
        function validate(step) {
          document
            .querySelectorAll('.error')
            .forEach((e) => (e.style.display = 'none'));
          let ok = true;

          (reqByStep[step] || []).forEach((id) => {
            if (id === 'sMem_gender') {
              if (!form.querySelector('input[name="sMem_gender"]:checked')) {
                showErr(id);
                ok = false;
              }
            } else {
              const el = document.getElementById(id);
              if (!el) return;
              if (el.type === 'checkbox' && !el.checked) {
                showErr(id);
                ok = false;
              } else if (!el.value) {
                if (id === 'signature_canvas_data') {
                  alert('서명을 완료해 주세요.');
                }
                showErr(id);
                ok = false;
              }
            }
          });

          if (step >= 5) {
            // 5단계: 서명 저장 필수 체크
            if (!isSignatureSaved) {
              alert('❌ 서명을 작성한 후 [서명 저장] 버튼을 클릭해 주세요.');
              document
                .getElementById('signSave')
                ?.scrollIntoView({ behavior: 'smooth', block: 'center' });
              ok = false;
              return ok;
            }
          }

          if (step >= 3) {
            const mv = document.getElementById('sMem_mobile').value.trim();
            const mre = /^010-\d{4}-\d{4}$/;
            if (!mre.test(mv)) {
              showErr('sMem_mobile');
              ok = false;
            }
            const ev = email.value.trim();
            const ere = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!ere.test(ev)) {
              showErr('sMem_email');
              ok = false;
            }
          }

          if (step >= 2) {
            // 아이디 중복 확인 필수 체크 (수정 모드가 아닌 경우만)
            const memberId = getMemberIdFromUrl();
            if (!memberId && !isIdChecked) {
              alert('❌ 아이디 중복 확인을 먼저 진행해 주세요.');
              document
                .getElementById('idCheckBtn')
                ?.scrollIntoView({ behavior: 'smooth', block: 'center' });
              ok = false;
              return ok;
            }

            const p1 = pwd.value;
            const p2 = pwd2.value;
            if (p1.length < 6) {
              showErr('sMem_pwdHash');
              ok = false;
            }
            if (p1 !== p2) {
              showErr('pwd2');
              ok = false;
            }
          }

          return ok;
        }
        function showErr(name) {
          const e = document.querySelector(`.error[data-err="${name}"]`);
          if (e) e.style.display = 'block';
        }

        /* 수집 & 요약 (요약에 서명 데이터/미리보기 포함) */
        function collect() {
          const names = [
            'sMem_id',
            'sMem_pwdHash',
            'sMem_name',
            'sMem_nickname',
            'sMem_birthdt',
            'sMem_birth_year',
            'sMem_calendar_type',
            'sMem_yundal',
            'sMem_buss_name',
            'sMem_comp_name',
            'sMem_phone',
            'sMem_mobile',
            'sMem_email',
            'zipcode',
            'address1',
            'address2',
            'zipcode_s',
            'address1_s',
            'address2_s',
            'sMem_snsgu',
            'sMem_choice1',
            'sMem_choice2',
            'sMem_choice3',
            'sMem_choice4',
            'sMem_choice5',
            'sMem_choice6',
            'sMem_choice7',
            'sMem_choice8',
            'sMem_choice9',
            'sMem_choice10',
            'sMem_choice11',
            'sMem_choice12',
            'sMem_quest',
            'sMem_content_enc',
            'old_name',
            'new_name',
            'sMemfam_id',
            'recommender',
            'applicant',
            'reference',
            'signature_canvas_data' /* (신규) 캔버스 서명 데이터 */,
          ];
          const data = {};
          names.forEach((n) => {
            const el = form.elements[n];
            if (!el) return;
            // 체크박스는 checked 속성 사용
            if (el.type === 'checkbox') {
              data[n] = el.checked;
            } else if (el.type === 'number') {
              data[n] = el.value === '' ? null : +el.value;
            } else {
              data[n] = el.value || null;
            }
          });
          data['sMem_gender'] =
            form.querySelector('input[name="sMem_gender"]:checked')?.value ??
            null;
          data['sMem_agreement'] =
            !!document.getElementById('agree_terms')?.checked &&
            !!document.getElementById('agree_privacy')?.checked
              ? 1
              : 0;
          data['sMem_agree'] = !!document.getElementById('sMem_agree')?.checked
            ? 1
            : 0;
          
          // 윤달 체크박스 처리: 음력일 때만 체크박스 값 사용, 양력일 때는 false
          const calendarType = document.getElementById('sMem_calendar_type')?.value;
          if (calendarType === '음력') {
            // 음력일 때는 체크박스 값 그대로 사용 (이미 collect()에서 처리됨)
            // 추가 확인: 체크박스가 활성화되어 있는지 확인
            const yundalCheckbox = document.getElementById('sMem_yundal');
            if (yundalCheckbox) {
              data['sMem_yundal'] = yundalCheckbox.checked;
            }
          } else {
            // 양력일 때는 항상 false
            data['sMem_yundal'] = false;
          }
          
          const f = document.getElementById('signature_file')?.files?.[0];
          data['signature_file'] = f ? f.name : null;
          data['sMem_status'] = 'OPEN';

          // (가독성) 캔버스 서명 존재 여부 플래그
          data['signature_drawn'] = !!(
            data['signature_canvas_data'] &&
            data['signature_canvas_data'].startsWith('data:image')
          );
          return data;
        }
        function renderSummary() {
          const data = collect();
          const box = document.getElementById('summary');
          box.innerHTML = '';

          // 필드명 한글 매핑
          const fieldLabels = {
            sMem_id: '멤버 ID',
            sMem_pwdHash: '비밀번호',
            sMem_name: '멤버 이름',
            sMem_nickname: '닉네임',
            sMem_birthdt: '생년월일',
            sMem_birth_year: '태어난 연도',
            sMem_calendar_type: '양력/음력 구분',
            sMem_gender: '성별',
            sMem_buss_name: '자영업자 상호',
            sMem_comp_name: '회사명',
            sMem_phone: '전화번호',
            sMem_mobile: '휴대폰',
            sMem_email: '이메일',
            zipcode: '우편번호',
            address1: '기본주소',
            address2: '상세주소',
            zipcode_s: '별도 우편번호',
            address1_s: '별도 기본주소',
            address2_s: '별도 상세주소',
            sMem_snsgu: '고객 구분',
            sMem_choice1: 'Color 선택1',
            sMem_choice2: 'Color 선택2',
            sMem_choice3: 'Color 선택3',
            sMem_choice4: 'Color 선택4',
            sMem_choice5: '동물 선택1',
            sMem_choice6: '동물 선택2',
            sMem_choice7: '동물 선택3',
            sMem_choice8: '동물 선택4',
            sMem_choice9: '인형 선택1',
            sMem_choice10: '인형 선택2',
            sMem_choice11: '인형 선택3',
            sMem_choice12: '인형 선택4',
            sMem_quest: '상담 질문사항',
            sMem_content_enc: '상담 문의내용',
            old_name: '개명 전 이름',
            new_name: '개명 후 이름',
            sMemfam_id: '추천인 ID',
            recommender: '추천인 성명',
            applicant: '신청인',
            signature_file: '서명 파일',
            reference: '상담답변/참고사항',
            sMem_agreement: '이용약관/개인정보 동의',
            sMem_agree: '마케팅 동의',
            sMem_admin_id: '담당 관리자 ID',
            sMem_grade: '멤버 평가등급',
            sMem_status: '상태',
            agree_terms: '이용약관 동의',
            agree_privacy: '개인정보 동의',
            pwd2: '비밀번호 확인',
            signature_canvas_data: '서명 이미지',
            sMem_yundal: '윤달',
          };

          // 기본 필드
          Object.entries(data).forEach(([k, v]) => {
            if (k === 'signature_canvas_data') return; // 미리보기 별도 처리
            const r = document.createElement('div');
            r.className = 'item';
            const safe =
              v === null || v === undefined || v === ''
                ? '<span style="opacity:.6">-</span>'
                : String(v).replace(/</g, '&lt;');
            const label = fieldLabels[k] || k; // 한글 레이블 또는 원본 키
            r.innerHTML = `<div style="color:var(--ink-sub)">${label}</div><div>${safe}</div>`;
            box.appendChild(r);
          });

          // 서명 이미지 미리보기
          const sig = form.elements['signature_canvas_data']?.value || null;
          const row = document.createElement('div');
          row.className = 'item';
          row.innerHTML = `<div style="color:var(--ink-sub)">서명 이미지</div><div>${
            sig
              ? `<img style="max-width:180px;max-height:160px;border:1px solid var(--line);border-radius:10px" src="${sig}">`
              : '<span style="opacity:.6">-</span>'
          }</div>`;
          box.appendChild(row);
        }

        function saveDraft() {
          localStorage.setItem('sMembersDraft', JSON.stringify(collect()));
        }
        (function restore() {
          const raw = localStorage.getItem('sMembersDraft');
          if (!raw) return;
          try {
            const d = JSON.parse(raw);
            for (const [k, v] of Object.entries(d)) {
              const el = form.elements[k];
              if (!el) continue;
              if (el.type === 'checkbox') {
                el.checked = !!v;
              } else if (el.type === 'radio') {
                const r = form.querySelector(
                  `input[name="${k}"][value="${v}"]`
                );
                if (r) r.checked = true;
              } else {
                el.value = v ?? '';
              }
            }
            // 서명 미리보기 복원
            if (d['signature_canvas_data']) {
              const box = document.getElementById('signPreviewBox');
              box.innerHTML = '';
              const img = new Image();
              img.src = d['signature_canvas_data'];
              img.style.maxWidth = '100%';
              img.style.maxHeight = '100%';
              box.appendChild(img);
            }
          } catch {}
        })();

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!validate(6)) return;

          const payload = collect();
          const memberId = getMemberIdFromUrl();

          // 기본값 설정: family_gu='01', adviser_role='A'
          if (!payload.family_gu) {
            payload.family_gu = '01';
          }
          if (!payload.adviser_role) {
            payload.adviser_role = 'A';
          }

          // 1. 필수 항목 검증: sMem_id, sMem_name
          if (!payload.sMem_id || !payload.sMem_id.trim()) {
            alert('❌ 회원 ID는 필수 항목입니다.');
            show(2); // 2단계로 이동
            document.getElementById('sMem_id')?.focus();
            return;
          }
          if (!payload.sMem_name || !payload.sMem_name.trim()) {
            alert('❌ 회원 이름은 필수 항목입니다.');
            show(2); // 2단계로 이동
            document.getElementById('sMem_name')?.focus();
            return;
          }

          // 2. 서명 이미지 업로드 처리
          let signatureFilePath = null;
          if (
            payload.signature_canvas_data &&
            payload.signature_canvas_data.startsWith('data:image')
          ) {
            try {
              // Base64 이미지를 Blob으로 변환
              const response = await fetch(payload.signature_canvas_data);
              const blob = await response.blob();

              // FormData 생성
              const formData = new FormData();
              const fileName = `${payload.sMem_id}_${payload.sMem_name}.png`;
              formData.append('file', blob, fileName);

              // 서명 이미지 업로드
              const apiBase = getApiBase();
              const uploadResponse = await fetch(
                `${apiBase}/files/upload-signature`,
                {
                  method: 'POST',
                  body: formData,
                }
              );

              const uploadResult = await uploadResponse.json();

              if (uploadResult.ok && uploadResult.path) {
                signatureFilePath = uploadResult.path;
                console.log('✅ 서명 이미지 업로드 성공:', signatureFilePath);
              } else {
                console.warn('⚠️ 서명 이미지 업로드 실패:', uploadResult.error);
              }
            } catch (error) {
              console.error('서명 이미지 업로드 오류:', error);
            }
          }

          // 3. 서명파일 경로를 payload에 추가
          if (signatureFilePath) {
            payload.signature_file = signatureFilePath;
          }

          // signature_canvas_data는 DB에 저장하지 않음 (제거)
          delete payload.signature_canvas_data;
          delete payload.signature_drawn;

          // 4. PostgreSQL DB에 회원 정보 저장 또는 수정
          try {
            const apiBase = getApiBase();
            console.log('📡 API 호출 시작');
            console.log('   - apiBase:', apiBase);
            console.log('   - memberId:', memberId);
            console.log('   - payload 키:', Object.keys(payload));
            console.log('   - payload.sMem_id:', payload.sMem_id);
            console.log('   - payload.sMem_name:', payload.sMem_name);
            console.log('   - payload.sMem_pwdHash 존재:', !!payload.sMem_pwdHash);
            
            let response;
            if (memberId) {
              // 수정 모드
              console.log(`   - 수정 모드: PUT ${apiBase}/smembers/${memberId}`);
              response = await fetch(`${apiBase}/smembers/${memberId}`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
              });
            } else {
              // 생성 모드
              console.log(`   - 생성 모드: POST ${apiBase}/smembers`);
              response = await fetch(`${apiBase}/smembers`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
              });
            }
            
            console.log('📡 fetch 완료, 응답 대기 중...');

            console.log('📡 API 응답 상태:', response.status);
            console.log('📡 API 응답 헤더:', response.headers);
            
            // 응답이 성공인지 확인
            if (!response.ok) {
              console.error('❌ API 응답 실패:', response.status, response.statusText);
              let errorText = '';
              try {
                const errorData = await response.json();
                console.error('❌ API 오류 데이터:', errorData);
                errorText = errorData.error || `HTTP ${response.status}: ${response.statusText}`;
              } catch (e) {
                errorText = `HTTP ${response.status}: ${response.statusText}`;
              }
              alert(`❌ ${memberId ? '회원정보 수정' : '회원가입'} 실패: ${errorText}`);
              return;
            }
            
            const result = await response.json();
            console.log('📋 API 응답 데이터:', result);

            if (result.ok) {
              console.log('✅ 회원 저장 성공');
              console.log('   - 저장된 회원 데이터:', result.data);
              alert(
                memberId
                  ? '✅ 회원정보가 수정되었습니다!'
                  : '✅ 회원가입이 완료되었습니다!'
              );
              // 성공 시 폼 초기화 및 첫 단계로 이동
              form.reset();
              localStorage.removeItem('sMembersDraft');
              localStorage.removeItem('signatureSaved');
              isSignatureSaved = false;

              // 서명 캔버스와 미리보기 초기화
              const signPad = document.getElementById('signPad');
              const signPreview = document.getElementById('signPreviewBox');
              const signHidden = document.getElementById(
                'signature_canvas_data'
              );
              const signStatus = document.getElementById('signStatus');

              if (signPad) {
                const ctx = signPad.getContext('2d');
                ctx.clearRect(0, 0, signPad.width, signPad.height);
              }
              if (signPreview) {
                signPreview.innerHTML =
                  '<span style="color:var(--ink-sub)">서명 미리보기</span>';
              }
              if (signHidden) {
                signHidden.value = '';
              }
              if (signStatus) {
                signStatus.textContent = '';
              }

              show(1);
            } else {
              console.error('❌ API 응답에서 ok=false:', result);
              alert(
                `❌ ${memberId ? '회원정보 수정' : '회원가입'} 실패: ${
                  result.error || '알 수 없는 오류'
                }`
              );
            }
          } catch (error) {
            console.error('❌ 서버 연결 오류:', error);
            console.error('   - 오류 상세:', error.message);
            console.error('   - 스택:', error.stack);
            alert(`❌ 서버 연결 오류가 발생했습니다: ${error.message}`);
          }
        });

        // URL 파라미터에서 회원 ID 가져오기
        function getMemberIdFromUrl() {
          const params = new URLSearchParams(window.location.search);
          return params.get('sm_id') || params.get('sM_id');
        }

        // 페이지 로드 시 회원 정보 불러오기 (수정 모드)
        async function loadMemberData() {
          const memberId = getMemberIdFromUrl();
          if (!memberId) return;

          try {
            const apiBase = getApiBase();
            const response = await fetch(`${apiBase}/smembers/${memberId}`);
            const result = await response.json();

            if (result.ok && result.data) {
              const data = result.data;

              // 폼 필드에 데이터 채우기
              for (const [key, value] of Object.entries(data)) {
                const el = form.elements[key];
                if (!el) continue;

                if (el.type === 'checkbox') {
                  el.checked = !!value;
                } else if (el.type === 'radio') {
                  const radio = form.querySelector(
                    `input[name="${key}"][value="${value}"]`
                  );
                  if (radio) radio.checked = true;
                } else {
                  el.value = value ?? '';
                }
              }

              // 수정 모드에서는 아이디 중복확인을 이미 완료된 것으로 처리
              if (data.smem_id) {
                isIdChecked = true;
                lastCheckedId = data.smem_id;
              }
              
              // 윤달 체크박스 상태 복원
              if (data.smem_yundal !== undefined) {
                const yundalCheckbox = document.getElementById('sMem_yundal');
                if (yundalCheckbox) {
                  yundalCheckbox.checked = !!data.smem_yundal;
                }
              }
              
              // 달력 타입에 따라 윤달 체크박스 표시/숨김
              toggleYundalCheckbox();

              // 수정 모드에서 서명 데이터가 있으면 서명 저장 완료로 처리
              if (
                data.signature_file ||
                form.elements['signature_canvas_data']?.value
              ) {
                isSignatureSaved = true;
              }

              // 제목 및 버튼 텍스트 변경
              document.querySelector('h1').textContent = '회원정보 수정';
              document.getElementById('submitBtn').textContent = '수정';
              document.getElementById('submitHint').innerHTML =
                '아래 정보를 확인하고 <strong>수정</strong> 버튼을 클릭하세요.';

              // 삭제 버튼 표시
              const deleteBtn = document.getElementById('deleteBtn');
              deleteBtn.style.display = 'inline-block';

              console.log('✅ 회원 데이터 로드 완료:', data);
            } else {
              alert('❌ 회원 정보를 불러올 수 없습니다.');
            }
          } catch (error) {
            console.error('회원 데이터 로드 오류:', error);
            alert('❌ 회원 정보 로드 중 오류가 발생했습니다.');
          }
        }

        // 회원 삭제 기능
        async function deleteMember() {
          const memberId = getMemberIdFromUrl();
          if (!memberId) {
            alert('❌ 삭제할 회원 ID가 없습니다.');
            return;
          }

          if (
            !confirm(
              '⚠️ 정말로 이 회원 정보를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.'
            )
          ) {
            return;
          }

          try {
            const apiBase = getApiBase();
            const response = await fetch(`${apiBase}/smembers/${memberId}`, {
              method: 'DELETE',
            });

            const result = await response.json();

            if (result.ok) {
              alert('✅ 회원 정보가 삭제되었습니다.');
              // 삭제 후 폼 초기화 및 URL 파라미터 제거
              window.location.href = window.location.pathname;
            } else {
              alert(`❌ 삭제 실패: ${result.error || '알 수 없는 오류'}`);
            }
          } catch (error) {
            console.error('삭제 오류:', error);
            alert('❌ 서버 연결 오류가 발생했습니다.');
          }
        }

        // 삭제 버튼 이벤트 리스너
        document
          .getElementById('deleteBtn')
          .addEventListener('click', deleteMember);

        // 페이지 로드 시 실행
        loadMemberData();

        setProgress();
        show(1);

        /* ====== UX 플러스: 엔터/단축키/해시/포커스 (원본 유지) ====== */
        (function () {
          const nextBtn = () =>
            document.querySelector('[data-step]:not([hidden]) [data-next]');
          const prevBtn = () =>
            document.querySelector('[data-step]:not([hidden]) [data-prev]');
          function getCurStep() {
            const curSec = [...document.querySelectorAll('[data-step]')].find(
              (s) => !s.hasAttribute('hidden')
            );
            return curSec ? +curSec.dataset.step : 1;
          }
          function getTotal() {
            return document.querySelectorAll('[data-step]').length;
          }
          function goNext() {
            nextBtn()?.click();
          }
          function goPrev() {
            prevBtn()?.click();
          }

          // 엔터 → 다음(마지막이면 제출)
          const form = document.getElementById('form');
          form.addEventListener('keydown', (e) => {
            const tag = (e.target.tagName || '').toLowerCase();
            if (
              e.key !== 'Enter' ||
              tag === 'textarea' ||
              tag === 'button' ||
              tag === 'a'
            )
              return;
            e.preventDefault();
            const cur = getCurStep();
            const total = getTotal();
            if (cur < total) goNext();
            else form.requestSubmit();
          });

          // Alt+→/←, Ctrl(or ⌘)+Enter
          window.addEventListener('keydown', (e) => {
            const cur = getCurStep();
            const total = getTotal();
            if (e.altKey && !e.shiftKey && !e.ctrlKey && !e.metaKey) {
              if (e.key === 'ArrowRight') {
                e.preventDefault();
                goNext();
              }
              if (e.key === 'ArrowLeft') {
                e.preventDefault();
                goPrev();
              }
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
              e.preventDefault();
              if (cur < total) goNext();
              else form.requestSubmit();
            }
          });

          // 포커스 첫 입력
          const focusFirstInput = () => {
            const curSec = document.querySelector('[data-step]:not([hidden])');
            const first = curSec?.querySelector(
              'input, select, textarea, button'
            );
            first && first.focus({ preventScroll: true });
          };
          const mo = new MutationObserver(() => focusFirstInput());
          document
            .querySelectorAll('[data-step]')
            .forEach((sec) =>
              mo.observe(sec, { attributes: true, attributeFilter: ['hidden'] })
            );
          window.addEventListener('load', focusFirstInput);

          // 해시 동기화
          function setHashForStep(step) {
            const want = `#step-${step}`;
            if (location.hash !== want) history.replaceState(null, '', want);
          }
          document.addEventListener('click', (e) => {
            if (!e.target.closest('[data-next],[data-prev]')) return;
            requestAnimationFrame(() => setHashForStep(getCurStep()));
          });
          function stepFromHash() {
            const m = (location.hash || '').match(/^#step-(\d+)$/);
            return m ? Math.max(1, Math.min(getTotal(), +m[1])) : null;
          }
          window.addEventListener('hashchange', () => {
            const goal = stepFromHash();
            if (!goal) return;
            const cur = getCurStep();
            if (goal === cur) return;
            const dir = goal > cur ? 1 : -1;
            const move = () => {
              const now = getCurStep();
              if (now === goal) {
                focusFirstInput();
                return;
              }
              if (dir > 0) goNext();
              else goPrev();
              requestAnimationFrame(move);
            };
            move();
          });
          window.addEventListener('load', () => {
            const goal = stepFromHash();
            if (goal && goal !== getCurStep()) {
              const dir = goal > getCurStep() ? 1 : -1;
              const move = () => {
                const now = getCurStep();
                if (now === goal) {
                  focusFirstInput();
                  return;
                }
                if (dir > 0) goNext();
                else goPrev();
                requestAnimationFrame(move);
              };
              move();
            } else {
              setHashForStep(getCurStep());
            }
          });
        })();

        /* ====== (신규) 캔버스 서명 패드 (색/굵기 옵션 포함) ====== */
        // 서명 저장 상태 추적 변수 (전역)
        let isSignatureSaved = false;

        (function setupSignPad() {
          const pad = document.getElementById('signPad');
          if (!pad) return;
          const status = document.getElementById('signStatus');
          const clearBtn = document.getElementById('signClear');
          const saveBtn = document.getElementById('signSave');
          const hidden = document.getElementById('signature_canvas_data');
          const preview = document.getElementById('signPreviewBox');
          const penColor = document.getElementById('penColor');
          const penWidth = document.getElementById('penWidth');

          // HiDPI 대응
          function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const cssW = pad.clientWidth || 640;
            const cssH = pad.clientHeight || 220;
            pad.width = Math.floor(cssW * ratio);
            pad.height = Math.floor(cssH * ratio);
            ctx.setTransform(1, 0, 0, 1, 0, 0); // reset transform before scaling
            ctx.scale(ratio, ratio);
            redraw();
          }
          const ctx = pad.getContext('2d');
          ctx.lineWidth = parseFloat(penWidth?.value || '2.5');
          ctx.lineCap = 'round';
          ctx.lineJoin = 'round';
          ctx.strokeStyle = penColor?.value || '#111';

          let drawing = false;
          let points = [];

          function posFromEvent(e) {
            const rect = pad.getBoundingClientRect();
            if (e.touches && e.touches[0]) {
              return {
                x: e.touches[0].clientX - rect.left,
                y: e.touches[0].clientY - rect.top,
              };
            }
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
          }
          function drawLine(p1, p2) {
            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.stroke();
          }
          function redraw() {
            // 현재는 실시간 스트로크만 사용 (전체 리렌더 필요 없음)
          }

          function start(e) {
            drawing = true;
            points = [];
            points.push(posFromEvent(e));
            // 서명을 새로 그리기 시작하면 저장 상태 초기화
            isSignatureSaved = false;
            localStorage.setItem('signatureSaved', 'false');
            e.preventDefault();
          }
          function move(e) {
            if (!drawing) return;
            const p = posFromEvent(e);
            const q = points[points.length - 1];
            drawLine(q, p);
            points.push(p);
            e.preventDefault();
          }
          function end(e) {
            drawing = false;
            e.preventDefault();
          }

          pad.addEventListener('mousedown', start);
          pad.addEventListener('mousemove', move);
          window.addEventListener('mouseup', end);

          pad.addEventListener('touchstart', start, { passive: false });
          pad.addEventListener('touchmove', move, { passive: false });
          pad.addEventListener('touchend', end, { passive: false });

          window.addEventListener('resize', resizeCanvas);
          // 초기 캔버스 크기 세팅
          resizeCanvas();

          function setStatus(msg) {
            if (status) {
              status.textContent = msg;
            }
          }
          function setPreview(dataUrl) {
            preview.innerHTML = '';
            if (dataUrl) {
              const img = new Image();
              img.src = dataUrl;
              img.style.maxWidth = '100%';
              img.style.maxHeight = '100%';
              preview.appendChild(img);
            } else {
              preview.innerHTML =
                '<span style="color:var(--ink-sub)">서명 미리보기</span>';
            }
          }

          clearBtn?.addEventListener('click', () => {
            const cssW = pad.clientWidth || 640;
            const cssH = pad.clientHeight || 220;
            ctx.clearRect(0, 0, pad.width, pad.height);
            resizeCanvas();
            hidden.value = '';
            setPreview('');
            setStatus('서명이 초기화되었습니다.');
            // 서명 초기화 시 저장 상태도 초기화
            isSignatureSaved = false;
            localStorage.setItem('signatureSaved', 'false');
          });

          saveBtn?.addEventListener('click', () => {
            try {
              const dataUrl = pad.toDataURL('image/png');
              // 간단한 비어있는 서명 방지: 데이터 URL 길이 체크
              if (!dataUrl || dataUrl.length < 5000) {
                alert('서명이 너무 짧거나 없습니다. 다시 서명해 주세요.');
                isSignatureSaved = false;
                localStorage.setItem('signatureSaved', 'false');
                return;
              }
              hidden.value = dataUrl;
              localStorage.setItem('sMembersDraft', JSON.stringify(collect())); // 드래프트 저장 업데이트
              setPreview(dataUrl);
              setStatus('서명이 저장되었습니다.');
              // 서명 저장 성공 시 상태 업데이트
              isSignatureSaved = true;
              localStorage.setItem('signatureSaved', 'true');
            } catch (err) {
              console.error(err);
              setStatus('서명 저장 중 오류가 발생했습니다.');
              isSignatureSaved = false;
              localStorage.setItem('signatureSaved', 'false');
            }
          });

          // 색/굵기 옵션 즉시 반영
          penColor?.addEventListener('input', (e) => {
            ctx.strokeStyle = e.target.value;
          });
          penWidth?.addEventListener('input', (e) => {
            ctx.lineWidth = parseFloat(e.target.value || '2.5');
          });

          // 복원: 기존 드래프트에 서명 데이터 있으면 미리보기 표시
          const raw = localStorage.getItem('sMembersDraft');
          if (raw) {
            try {
              const d = JSON.parse(raw);
              if (d['signature_canvas_data']) {
                hidden.value = d['signature_canvas_data'];
                setPreview(d['signature_canvas_data']);
                // 드래프트 복원 시에는 저장 상태를 체크 (명시적으로 저장한 경우만 true)
                const savedStatus = localStorage.getItem('signatureSaved');
                isSignatureSaved = savedStatus === 'true';
              }
            } catch {}
          }
        })();
      })();

      /* ====== 주소찾기: 우편번호/기본주소 자동채움 + 별도주소 동기화 (원본 유지) ====== */
      function openPostcode(zipId, addr1Id) {
        if (!window.daum || !daum.Postcode) {
          alert(
            '우편번호 서비스를 불러오는 중입니다. 잠시 후 다시 시도하세요.'
          );
          return;
        }
        new daum.Postcode({
          oncomplete: function (data) {
            const $zip = document.getElementById(zipId);
            const $addr1 = document.getElementById(addr1Id);
            const isBase = zipId === 'zipcode';

            // 1) 우편번호
            if ($zip) $zip.value = data.zonecode || '';

            // 2) 주소(도로명/지번) + (법정동/건물명)
            const baseAddr =
              data.userSelectedType === 'R'
                ? data.roadAddress
                : data.jibunAddress;
            let extra = '';
            if (data.bname && /[동|로|가]$/g.test(data.bname))
              extra += data.bname;
            if (data.buildingName && data.apartment === 'Y')
              extra += (extra ? ', ' : '') + data.buildingName;
            const fullAddr = baseAddr + (extra ? ` (${extra})` : '');
            if ($addr1) $addr1.value = fullAddr;

            // 3) "기본 주소와 동일" 체크 시 별도주소 동기화
            const copy = document.getElementById('copyAddr');
            if (copy && copy.checked && isBase) {
              const z2 = document.getElementById('zipcode_s');
              const a2 = document.getElementById('address1_s');
              if (z2) z2.value = $zip ? $zip.value : '';
              if (a2) a2.value = $addr1 ? $addr1.value : '';
            }

            // 4) 상세주소 포커스
            const $detail = isBase
              ? document.getElementById('address2')
              : document.getElementById('address2_s');
            $detail && $detail.focus();
          },
        }).open();
      }

      /* 기본주소 수정 시에도 "동일" 체크면 별도주소가 따라가도록 동기화 (원본 유지) */
      (function setupAddressSync() {
        const copy = document.getElementById('copyAddr');
        const baseIds = ['zipcode', 'address1', 'address2'];
        const sync = () => {
          if (!copy || !copy.checked) return;
          const z = document.getElementById('zipcode');
          const a1 = document.getElementById('address1');
          const a2 = document.getElementById('address2');
          const z2 = document.getElementById('zipcode_s');
          const a1s = document.getElementById('address1_s');
          const a2s = document.getElementById('address2_s');
          if (z && z2) z2.value = z.value;
          if (a1 && a1s) a1s.value = a1.value;
          if (a2 && a2s) a2s.value = a2.value;
        };
        copy?.addEventListener('change', () => {
          const checked = copy.checked;
          ['zipcode_s', 'address1_s', 'address2_s'].forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.readOnly = checked;
          });
          sync();
        });
        baseIds.forEach((id) => {
          const el = document.getElementById(id);
          el?.addEventListener('input', sync);
        });
      })();</script><script src=/secret/static/member_session.js></script><script src=/secret/static/admin_session.js></script><script src=/secret/static/security.js></script>