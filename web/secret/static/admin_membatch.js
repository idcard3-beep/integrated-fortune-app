const THEME_KEY='admin_theme_v1';const THEME_NAMES={'theme-dim':'Dim','theme-midnight':'Midnight','theme-light':'Light','theme-sepia':'Sepia',};function applyTheme(theme){const body=document.body;body.classList.remove('theme-light','theme-dim','theme-sepia','theme-midnight');body.classList.add(theme);localStorage.setItem(THEME_KEY,theme);const label=document.getElementById('themeLabel');label.textContent=THEME_NAMES[theme]||'Dim';document.getElementById('themeBtn').setAttribute('aria-expanded','false');document.getElementById('themeMenu').classList.remove('open');}
(function initTheme(){const prefersDark=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;const saved=localStorage.getItem(THEME_KEY);const initial=saved||(prefersDark?'theme-dim':'theme-light');applyTheme(initial);})();document.getElementById('themeBtn').addEventListener('click',()=>{const m=document.getElementById('themeMenu');const open=m.classList.toggle('open');document.getElementById('themeBtn').setAttribute('aria-expanded',String(open));});document.addEventListener('click',(e)=>{const menu=document.getElementById('themeMenu');const btn=document.getElementById('themeBtn');if(!menu.contains(e.target)&&e.target!==btn){menu.classList.remove('open');btn.setAttribute('aria-expanded','false');}});document.querySelectorAll('#themeMenu [data-theme]').forEach((btn)=>{btn.addEventListener('click',()=>applyTheme(btn.dataset.theme));});let members=[{sm_id:1,smem_id:'user001',smem_pwdHash:'***',smem_pwd_salt:null,smem_name:'í™ê¸¸ë™',smem_nickname:'ê¸¸ë™ì´',smem_birthdt:'1990-01-01',smem_birth_year:1990,smem_calendar_type:'solar',smem_gender:'M',smem_buss_name:'ê¸¸ë™ìƒíšŒ',smem_comp_name:'ê¸¸ë™ì£¼ì‹íšŒì‚¬',smem_phone:'02-111-2222',smem_mobile:'010-1111-2222',smem_email:'hong@example.com',zipcode:'12345',address1:'ì„œìš¸ ê°•ë‚¨êµ¬',address2:'í…Œí—¤ë€ë¡œ 1',zipcode_s:'',address1_s:'',address2_s:'',smem_snsgu:'A',smem_choice1:0,smem_choice2:0,smem_choice3:0,smem_choice4:0,smem_choice5:0,smem_choice6:0,smem_choice7:0,smem_choice8:0,smem_choice9:0,smem_choice10:0,smem_choice11:0,smem_choice12:0,smem_quest:'',smem_content_enc:'',old_name:'',new_name:'',recommender:'',applicant:'',signature_file:'',reference:'',smem_agreement:1,smem_agree:1,smem_admin_id:'admin01',smem_grade:'A',smem_status:'OPEN',createdAt:'2025-10-01 10:15:00',created_at:'2025-10-01 10:15:00',updated_at:'2025-10-01 10:15:00',},{sm_id:2,smem_id:'user002',smem_pwdHash:'***',smem_pwd_salt:null,smem_name:'ê¹€ë¯¼ì§€',smem_nickname:'ë¯¼ì§€',smem_birthdt:'1995-05-05',smem_birth_year:1995,smem_calendar_type:'lunar',smem_gender:'F',smem_buss_name:'',smem_comp_name:'',smem_phone:'',smem_mobile:'010-2222-3333',smem_email:'minji@example.com',zipcode:'',address1:'',address2:'',zipcode_s:'',address1_s:'',address2_s:'',smem_snsgu:'B',smem_choice1:0,smem_choice2:0,smem_choice3:0,smem_choice4:0,smem_choice5:0,smem_choice6:0,smem_choice7:0,smem_choice8:0,smem_choice9:0,smem_choice10:0,smem_choice11:0,smem_choice12:0,smem_quest:'',smem_content_enc:'',old_name:'',new_name:'',recommender:'',applicant:'',signature_file:'',reference:'',smem_agreement:1,smem_agree:0,smem_admin_id:'admin02',smem_grade:'B',smem_status:'OPEN',createdAt:'2025-10-05 09:02:10',created_at:'2025-10-05 09:02:10',updated_at:'2025-10-05 09:02:10',},];let tickets=[{ticket_id:'a111-111',title_masked:'[ë¹„ë°€] ì§„ë¡œ ê³ ë¯¼',content_enc:'...',author_name:'í™ê¸¸ë™',author_nickname:'ê¸¸ë™ì´',author_contact:'',author_phone:'',author_mobile:'',author_email:'',author_gender:'M',birth_year:1990,snsgu:'A',choice1:0,choice2:0,choice3:0,choice4:0,choice5:0,choice6:0,choice7:0,choice8:0,choice9:0,choice10:0,choice11:0,choice12:0,agreement:1,smember_id:'user001',post_pwd_hash:'h',post_pwd_salt:null,has_admin_reply:true,status:'ANSWERED',created_at:'2025-10-06 11:20:00',updated_at:'2025-10-06 11:50:00',},{ticket_id:'a222-222',title_masked:'[ë¹„ë°€] ëŒ€ì¸ê´€ê³„',content_enc:'...',author_name:'ê¹€ë¯¼ì§€',author_nickname:'ë¯¼ì§€',author_contact:'',author_phone:'',author_mobile:'',author_email:'',author_gender:'F',birth_year:1995,snsgu:'B',choice1:0,choice2:0,choice3:0,choice4:0,choice5:0,choice6:0,choice7:0,choice8:0,choice9:0,choice10:0,choice11:0,choice12:0,agreement:1,smember_id:'user002',post_pwd_hash:'h',post_pwd_salt:null,has_admin_reply:false,status:'OPEN',created_at:'2025-10-10 09:00:00',updated_at:'2025-10-10 09:00:00',},];let msgs=[{msg_id:'m1',ticket_id:'a111-111',role:'admin',content_enc:'ì•ˆë…•í•˜ì„¸ìš”. ì ‘ìˆ˜í–ˆìŠµë‹ˆë‹¤.',created_at:'2025-10-06 11:45:00',},{msg_id:'m2',ticket_id:'a111-111',role:'user',content_enc:'ê°ì‚¬í•©ë‹ˆë‹¤.',created_at:'2025-10-06 12:00:00',},{msg_id:'m4',ticket_id:'a222-222',role:'user',content_enc:'ì¶”ê°€ ì§ˆë¬¸ì´ ìˆì–´ìš”.',created_at:'2025-10-11 10:00:00',},];const qs=(s)=>document.querySelector(s);const qsa=(s)=>Array.from(document.querySelectorAll(s));const escapeHtml=(s)=>(s??'').toString().replace(/[&<>"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;',}[m]));const contains=(hay,kw)=>hay.toLowerCase().includes(kw.toLowerCase());function fmtTag(v,map){if(!map)return`<span class="tag">${escapeHtml(v ?? '')}</span>`;const t=map[v]||{text:String(v??''),cls:''};return`<span class="tag ${t.cls}">${t.text}</span>`;}
const statusColorMap={OPEN:{text:'OPEN',cls:'warn'},LOCKED:{text:'LOCKED',cls:'err'},DELETED:{text:'DELETED',cls:'err'},ANSWERED:{text:'ANSWERED',cls:'ok'},CLOSED:{text:'CLOSED',cls:'err'},};function makeSorter(){let sortKeys=[];return{toggle(k,multi){if(!multi)sortKeys=[];const f=sortKeys.find((x)=>x.k===k);if(!f)sortKeys.push({k,dir:1});else if(f.dir===1)f.dir=-1;else sortKeys=sortKeys.filter((x)=>x.k!==k);},sort(arr){if(sortKeys.length===0)return arr;return[...arr].sort((a,b)=>{for(const s of sortKeys){const av=(a[s.k]??'').toString(),bv=(b[s.k]??'').toString();if(av<bv)return-1*s.dir;if(av>bv)return 1*s.dir;}
return 0;});},keys:()=>sortKeys,};}
let state={selMember:null,selTicket:null,filters:{members:'',tickets:'',msgs:''},sort:{members:makeSorter(),tickets:makeSorter(),msgs:makeSorter(),},fmMembers:[{k:'sm_id',ro:true,label:'sm_id'},{k:'smem_id',req:true,label:'smem_id'},{k:'smem_pwdHash',type:'password',label:'smem_pwdHash'},{k:'smem_pwd_salt',label:'smem_pwd_salt'},{k:'smem_name',label:'smem_name'},{k:'smem_nickname',label:'smem_nickname'},{k:'smem_birthdt',type:'date',label:'smem_birthdt'},{k:'smem_birth_year',type:'number',label:'smem_birth_year'},{k:'smem_calendar_type',type:'select',options:['solar','lunar','leap'],label:'smem_calendar_type',},{k:'smem_gender',type:'select',options:['','M','F'],label:'smem_gender',},{k:'smem_buss_name',label:'smem_buss_name'},{k:'smem_comp_name',label:'smem_comp_name'},{k:'smem_phone',label:'smem_phone'},{k:'smem_mobile',label:'smem_mobile'},{k:'smem_email',type:'email',label:'smem_email'},{k:'zipcode',label:'zipcode'},{k:'address1',label:'address1'},{k:'address2',label:'address2'},{k:'zipcode_s',label:'zipcode_s'},{k:'address1_s',label:'address1_s'},{k:'address2_s',label:'address2_s'},{k:'smem_snsgu',label:'smem_snsgu'},...Array.from({length:12},(_,i)=>({k:`smem_choice${i + 1}`,type:'number',label:`smem_choice${i + 1}`,})),{k:'smem_quest',type:'textarea',label:'smem_quest'},{k:'smem_content_enc',type:'textarea',label:'smem_content_enc',},{k:'old_name',label:'old_name'},{k:'new_name',label:'new_name'},{k:'recommender',label:'recommender'},{k:'applicant',label:'applicant'},{k:'signature_file',label:'signature_file'},{k:'reference',type:'textarea',label:'reference'},{k:'smem_agreement',type:'number',label:'smem_agreement'},{k:'smem_agree',type:'number',label:'smem_agree'},{k:'smem_admin_id',label:'smem_admin_id'},{k:'smem_grade',label:'smem_grade'},{k:'smem_status',type:'select',options:['OPEN','LOCKED','DELETED'],label:'smem_status',},{k:'createdAt',ro:true,label:'createdAt'},{k:'created_at',ro:true,label:'created_at'},{k:'updated_at',ro:true,label:'updated_at'},],fmTickets:[{k:'ticket_id',ro:true,label:'ticket_id'},{k:'title_masked',label:'title_masked'},{k:'content_enc',type:'textarea',label:'content_enc'},{k:'author_name',label:'author_name'},{k:'author_nickname',label:'author_nickname'},{k:'author_contact',label:'author_contact'},{k:'author_phone',label:'author_phone'},{k:'author_mobile',label:'author_mobile'},{k:'author_email',type:'email',label:'author_email'},{k:'author_gender',type:'select',options:['','M','F'],label:'author_gender',},{k:'birth_year',type:'number',label:'birth_year'},{k:'snsgu',label:'snsgu'},...Array.from({length:12},(_,i)=>({k:`choice${i + 1}`,type:'number',label:`choice${i + 1}`,})),{k:'agreement',type:'number',label:'agreement'},{k:'smember_id',label:'smember_id'},{k:'post_pwd_hash',label:'post_pwd_hash'},{k:'post_pwd_salt',label:'post_pwd_salt'},{k:'has_admin_reply',type:'select',options:['false','true'],label:'has_admin_reply',},{k:'status',type:'select',options:['OPEN','ANSWERED','CLOSED'],label:'status',},{k:'created_at',ro:true,label:'created_at'},{k:'updated_at',ro:true,label:'updated_at'},],fmMsgs:[{k:'msg_id',ro:true,label:'msg_id'},{k:'ticket_id',label:'ticket_id'},{k:'role',label:'role'},{k:'content_enc',type:'textarea',label:'content_enc'},{k:'created_at',ro:true,label:'created_at'},],};const elMembersBody=()=>qs('#tbl-members tbody');const elTicketsBody=()=>qs('#tbl-tickets tbody');const elMsgsBody=()=>qs('#tbl-msgs tbody');function renderMembers(){const kw=state.filters.members.trim();let rows=members.filter((r)=>{if(!kw)return true;const hay=`${r.smem_id} ${r.smem_name} ${r.smem_nickname} ${r.smem_email} ${r.smem_status}`;return contains(hay,kw);});rows=state.sort.members.sort(rows);const tb=elMembersBody();tb.innerHTML='';rows.forEach((r)=>{const tr=document.createElement('tr');if(state.selMember===r.smem_id)tr.classList.add('selected');tr.innerHTML=`
<td><span class="tag">${escapeHtml(r.smem_id)}</span></td>
<td>${escapeHtml(r.smem_name ?? '')}</td>
<td class="muted">${escapeHtml(r.smem_nickname ?? '')}</td>
<td>${escapeHtml(r.smem_mobile ?? '')}</td>
<td>${fmtTag(r.smem_status, statusColorMap)}</td>
<td class="muted">${escapeHtml(r.created_at ?? '')}</td>
`;tr.onclick=()=>{state.selMember=state.selMember===r.smem_id?null:r.smem_id;state.selTicket=null;renderMembers();renderTickets();renderMsgs();updateFooters();renderMemberForm();};tb.appendChild(tr);});qs('#count-members').textContent=`${rows.length} rows`;}
function renderTickets(){const kw=state.filters.tickets.trim();let rows=tickets.filter((r)=>{if(state.selMember&&r.smember_id!==state.selMember)return false;if(!kw)return true;const hay=`${r.title_masked} ${r.author_nickname} ${r.status} ${r.smember_id}`;return contains(hay,kw);});rows=state.sort.tickets.sort(rows);const tb=elTicketsBody();tb.innerHTML='';rows.forEach((r)=>{const tr=document.createElement('tr');if(state.selTicket===r.ticket_id)tr.classList.add('selected');tr.innerHTML=`
<td><span class="tag">${escapeHtml(r.ticket_id ?? '').substring(
      0,
      8
    )}...</span></td>
<td class="ellipsis">${escapeHtml(r.title_masked)}</td>
<td class="muted">${escapeHtml(r.author_nickname ?? '')}</td>
<td>${fmtTag(r.status, statusColorMap)}</td>
<td>${
      r.has_admin_reply
        ? '<span class="tag ok">Y</span>'
        : '<span class="tag warn">N</span>'
    }</td>
<td class="muted">${escapeHtml(r.created_at ?? '')}</td>
`;tr.onclick=()=>{state.selTicket=state.selTicket===r.ticket_id?null:r.ticket_id;renderTickets();renderMsgs();updateFooters();renderTicketForm();};tb.appendChild(tr);});qs('#count-tickets').textContent=`${rows.length} rows`;}
function renderMsgs(){const kw=state.filters.msgs.trim();let rows=msgs.filter((r)=>{if(state.selTicket)
return r.ticket_id===state.selTicket&&filterKw(r,kw);if(state.selMember){const ids=tickets.filter((t)=>t.smember_id===state.selMember).map((t)=>t.ticket_id);return ids.includes(r.ticket_id)&&filterKw(r,kw);}
return filterKw(r,kw);});rows=state.sort.msgs.sort(rows);const tb=elMsgsBody();tb.innerHTML='';rows.forEach((r)=>{const tr=document.createElement('tr');tr.innerHTML=`
<td><span class="tag">${escapeHtml(r.msg_id ?? '').substring(
      0,
      8
    )}...</span></td>
<td>${escapeHtml(r.role ?? '')}</td>
<td><span class="tag">${escapeHtml(r.ticket_id ?? '').substring(
      0,
      8
    )}...</span></td>
<td class="ellipsis">${escapeHtml((r.content_enc ?? '').substring(0, 50))}${
      (r.content_enc ?? '').length > 50 ? '...' : ''
    }</td>
<td class="muted">${escapeHtml(r.created_at ?? '')}</td>
`;tr.onclick=()=>{qs('#form-msgs').hidden=false;buildForm('#msgs-fields',state.fmMsgs,r);bindMsgSaveDelete(r);};tb.appendChild(tr);});qs('#count-msgs').textContent=`${rows.length} rows`;qs('#filter-desc').textContent=state.selTicket?`ticket_id=${state.selTicket}`:state.selMember?`smember_id=${state.selMember}`:'ì „ì²´';function filterKw(r,kw){if(!kw)return true;const hay=`${r.role} ${r.content_enc} ${r.ticket_id}`;return contains(hay,kw);}}
function buildForm(containerSel,meta,row){const wrap=qs(containerSel);wrap.innerHTML='';meta.forEach((m)=>{const div=document.createElement('div');div.className='fi';const id=`${containerSel.slice(1)}_${m.k}`;const val=row[m.k]??'';const label=document.createElement('label');label.htmlFor=id;label.textContent=m.label||m.k;let input;if(m.type==='textarea'){input=document.createElement('textarea');input.value=val;}else if(m.type==='select'){input=document.createElement('select');(m.options||[]).forEach((opt)=>{const o=document.createElement('option');o.value=opt;o.textContent=opt;if(String(val)===String(opt))o.selected=true;input.appendChild(o);});}else{input=document.createElement('input');input.type=m.type||'text';input.value=val;}
input.id=id;input.name=m.k;if(m.ro){input.readOnly=true;input.tabIndex=-1;}
if(m.req)input.required=true;div.appendChild(label);div.appendChild(input);wrap.appendChild(div);});}
function readForm(containerSel,meta,base={}){const data={...base};meta.forEach((m)=>{const el=qs(`${containerSel} [name="${m.k}"]`);if(!el)return;let v=m.type==='number'?Number(el.value||0):el.value;if(m.type==='select'&&(m.options||[]).includes('true')&&(m.options||[]).includes('false')){v=el.value==='true';}
data[m.k]=m.type==='number'&&isNaN(v)?null:v;});return data;}
function renderMemberForm(){const r=members.find((x)=>x.smem_id===state.selMember);const form=qs('#form-members');if(!r){form.hidden=true;qs('#sel-member').textContent='ì—†ìŒ';return;}
form.hidden=false;buildForm('#members-fields',state.fmMembers,r);bindMemberSaveDelete(r);qs('#sel-member').textContent=state.selMember;}
function bindMemberSaveDelete(rowRef){qs('#save-member').onclick=async(e)=>{e.preventDefault();const updated=readForm('#members-fields',state.fmMembers,rowRef);if(!updated.smem_id){alert('smem_idëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}
try{console.log('ğŸ”„ íšŒì› ì •ë³´ ìˆ˜ì • API í˜¸ì¶œ:',rowRef.sm_id);const response=await fetch(`/secret/api/v1/smembers/${rowRef.sm_id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(updated),});if(!response.ok){const error=await response.json();throw new Error(error.error||'íšŒì› ìˆ˜ì • ì‹¤íŒ¨');}
const result=await response.json();console.log('âœ… íšŒì› ìˆ˜ì • ì™„ë£Œ:',result);Object.assign(rowRef,updated,{updated_at:nowStr()});renderMembers();renderTickets();renderMsgs();alert('íšŒì› ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');}catch(error){console.error('âŒ íšŒì› ìˆ˜ì • ì˜¤ë¥˜:',error);alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);}};qs('#delete-member').onclick=async(e)=>{e.preventDefault();if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ tickets/messagesëŠ” ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.'))
return;try{console.log('ğŸ”„ íšŒì› ì‚­ì œ API í˜¸ì¶œ:',rowRef.sm_id);const response=await fetch(`/secret/api/v1/smembers/${rowRef.sm_id}`,{method:'DELETE',});if(!response.ok){const error=await response.json();throw new Error(error.error||'íšŒì› ì‚­ì œ ì‹¤íŒ¨');}
console.log('âœ… íšŒì› ì‚­ì œ ì™„ë£Œ');members=members.filter((x)=>x!==rowRef);state.selMember=null;state.selTicket=null;renderMembers();renderTickets();renderMsgs();qs('#form-members').hidden=true;alert('íšŒì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');}catch(error){console.error('âŒ íšŒì› ì‚­ì œ ì˜¤ë¥˜:',error);alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);}};}
function renderTicketForm(){const r=tickets.find((x)=>x.ticket_id===state.selTicket);const form=qs('#form-tickets');if(!r){form.hidden=true;qs('#sel-ticket').textContent='ì—†ìŒ';return;}
form.hidden=false;buildForm('#tickets-fields',state.fmTickets,r);bindTicketSaveDelete(r);qs('#sel-ticket').textContent=state.selTicket;}
function bindTicketSaveDelete(rowRef){qs('#save-ticket').onclick=async(e)=>{e.preventDefault();const updated=readForm('#tickets-fields',state.fmTickets,rowRef);if(!updated.ticket_id){alert('ticket_idê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.');return;}
try{console.log('ğŸ”„ í‹°ì¼“ ìˆ˜ì • API í˜¸ì¶œ:',rowRef.ticket_id);const response=await fetch(`/secret/api/v1/tickets/${rowRef.ticket_id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:updated.title_masked,content:updated.content_enc,author_name:updated.author_name,author_contact:updated.author_contact||'',status:updated.status,author_nickname:updated.author_nickname,author_phone:updated.author_phone,author_mobile:updated.author_mobile,author_email:updated.author_email,author_gender:updated.author_gender,birth_year:updated.birth_year,snsgu:updated.snsgu,agreement:updated.agreement,post_pwd_hash:updated.post_pwd_hash,}),});if(!response.ok){const error=await response.json();throw new Error(error.error||'í‹°ì¼“ ìˆ˜ì • ì‹¤íŒ¨');}
console.log('âœ… í‹°ì¼“ ìˆ˜ì • ì™„ë£Œ');Object.assign(rowRef,updated,{updated_at:nowStr()});renderTickets();renderMsgs();alert('í‹°ì¼“ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');}catch(error){console.error('âŒ í‹°ì¼“ ìˆ˜ì • ì˜¤ë¥˜:',error);alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);}};qs('#delete-ticket').onclick=async(e)=>{e.preventDefault();if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ thread_messagesëŠ” ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.'))
return;try{console.log('ğŸ”„ í‹°ì¼“ ì‚­ì œ API í˜¸ì¶œ:',rowRef.ticket_id);const response=await fetch(`/secret/api/v1/tickets/${rowRef.ticket_id}`,{method:'DELETE',});if(!response.ok){const error=await response.json();throw new Error(error.error||'í‹°ì¼“ ì‚­ì œ ì‹¤íŒ¨');}
console.log('âœ… í‹°ì¼“ ì‚­ì œ ì™„ë£Œ');tickets=tickets.filter((x)=>x!==rowRef);state.selTicket=null;renderTickets();renderMsgs();qs('#form-tickets').hidden=true;alert('í‹°ì¼“ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');}catch(error){console.error('âŒ í‹°ì¼“ ì‚­ì œ ì˜¤ë¥˜:',error);alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);}};}
function bindMsgSaveDelete(rowRef){qs('#save-msg').onclick=async(e)=>{e.preventDefault();const updated=readForm('#msgs-fields',state.fmMsgs,rowRef);if(!updated.msg_id){alert('msg_idê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.');return;}
try{console.log('ğŸ”„ ë©”ì‹œì§€ ìˆ˜ì • API í˜¸ì¶œ:',rowRef.msg_id);const response=await fetch(`/secret/api/v1/admin/messages/${rowRef.msg_id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:updated.content_enc,role:updated.role,}),});if(!response.ok){const error=await response.json();throw new Error(error.error||'ë©”ì‹œì§€ ìˆ˜ì • ì‹¤íŒ¨');}
console.log('âœ… ë©”ì‹œì§€ ìˆ˜ì • ì™„ë£Œ');Object.assign(rowRef,updated);renderMsgs();alert('ë©”ì‹œì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');}catch(error){console.error('âŒ ë©”ì‹œì§€ ìˆ˜ì • ì˜¤ë¥˜:',error);alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);}};qs('#delete-msg').onclick=async(e)=>{e.preventDefault();if(!confirm('ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{console.log('ğŸ”„ ë©”ì‹œì§€ ì‚­ì œ API í˜¸ì¶œ:',rowRef.msg_id);const response=await fetch(`/secret/api/v1/admin/messages/${rowRef.msg_id}`,{method:'DELETE',});if(!response.ok){const error=await response.json();throw new Error(error.error||'ë©”ì‹œì§€ ì‚­ì œ ì‹¤íŒ¨');}
console.log('âœ… ë©”ì‹œì§€ ì‚­ì œ ì™„ë£Œ');msgs=msgs.filter((x)=>x!==rowRef);renderMsgs();qs('#form-msgs').hidden=true;alert('ë©”ì‹œì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');}catch(error){console.error('âŒ ë©”ì‹œì§€ ì‚­ì œ ì˜¤ë¥˜:',error);alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);}};}
function bindSortHead(tableSel,sorter,rerender){qsa(`${tableSel} thead th`).forEach((th)=>{th.addEventListener('click',(ev)=>{sorter.toggle(th.dataset.k,ev.shiftKey);qsa(`${tableSel} thead th`).forEach((x)=>(x.innerText=x.innerText.replace(/ â–²| â–¼/g,'')));const f=sorter.keys().find((x)=>x.k===th.dataset.k);if(f)th.innerText=th.innerText+(f.dir===1?' â–²':' â–¼');rerender();});});}
function updateFooters(){qs('#sel-member').textContent=state.selMember||'ì—†ìŒ';qs('#sel-ticket').textContent=state.selTicket||'ì—†ìŒ';}
function nowStr(){const d=new Date();const p=(n)=>String(n).padStart(2,'0');return`${d.getFullYear()}-${p(d.getMonth() + 1)}-${p(d.getDate())} ${p(
    d.getHours()
  )}:${p(d.getMinutes())}:${p(d.getSeconds())}`;}
async function loadDataFromServer(){try{console.log('ğŸ”„ ì„œë²„ì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œì‘...');const membersRes=await fetch('/secret/api/v1/smembers/');if(membersRes.ok){const membersData=await membersRes.json();if(membersData.ok&&Array.isArray(membersData.data)){members=membersData.data;console.log('âœ… ì •íšŒì›(smembers) ë°ì´í„° ë¡œë“œ ì™„ë£Œ:',members.length,'ê±´');}}
const ticketsRes=await fetch('/secret/api/v1/tickets/');if(ticketsRes.ok){const ticketsData=await ticketsRes.json();if(Array.isArray(ticketsData)){tickets=ticketsData.map((t)=>({ticket_id:t.ticket_id,title_masked:t.title_masked||t.title||'',content_enc:t.content_enc||'',author_name:t.author_name||'',author_nickname:t.author_nickname||'',author_contact:t.author_contact||'',author_phone:t.author_phone||'',author_mobile:t.author_mobile||'',author_email:t.author_email||'',author_gender:t.author_gender||'',birth_year:t.birth_year||null,snsgu:t.snsgu||'',choice1:0,choice2:0,choice3:0,choice4:0,choice5:0,choice6:0,choice7:0,choice8:0,choice9:0,choice10:0,choice11:0,choice12:0,agreement:t.agreement||0,smember_id:t.smember_id||'',post_pwd_hash:t.post_pwd_hash||'',post_pwd_salt:null,has_admin_reply:t.has_admin_reply||false,status:t.status||'OPEN',created_at:t.created_at||'',updated_at:t.updated_at||'',}));console.log('âœ… í‹°ì¼“(tickets) ë°ì´í„° ë¡œë“œ ì™„ë£Œ:',tickets.length,'ê±´');console.log('ğŸ“Š smembers.smem_id = tickets.smember_id ê´€ê³„ë¡œ ì—°ê²°ë¨');}}
const msgsRes=await fetch('/secret/api/v1/messages/');if(msgsRes.ok){const msgsData=await msgsRes.json();if(Array.isArray(msgsData)){msgs=msgsData.map((m)=>({msg_id:m.message_id||m.msg_id,ticket_id:m.ticket_id,role:m.role||'admin',content_enc:m.content_enc||m.body||'',created_at:m.created_at||'',}));console.log('âœ… ë©”ì‹œì§€(thread_messages) ë°ì´í„° ë¡œë“œ ì™„ë£Œ:',msgs.length,'ê±´');console.log('ğŸ“Š tickets.ticket_id = thread_messages.ticket_id ê´€ê³„ë¡œ ì—°ê²°ë¨');}}
renderMembers();renderTickets();renderMsgs();updateFooters();}catch(error){console.error('âŒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:',error);alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);}}
function init(){qs('#closeBtn').onclick=()=>{if(window.history.length>1){window.history.back();}else{window.location.href='/main_adminMenu.html';}};qs('#search-members').oninput=(e)=>{state.filters.members=e.target.value;renderMembers();};qs('#search-tickets').oninput=(e)=>{state.filters.tickets=e.target.value;renderTickets();};qs('#search-msgs').oninput=(e)=>{state.filters.msgs=e.target.value;renderMsgs();};qs('#reset-members').onclick=()=>{state.selMember=null;state.selTicket=null;renderMembers();renderTickets();renderMsgs();updateFooters();qs('#form-members').hidden=true;qs('#form-tickets').hidden=true;};qs('#reset-tickets').onclick=()=>{state.selTicket=null;renderTickets();renderMsgs();updateFooters();qs('#form-tickets').hidden=true;};loadDataFromServer();bindSortHead('#tbl-members',state.sort.members,renderMembers);bindSortHead('#tbl-tickets',state.sort.tickets,renderTickets);bindSortHead('#tbl-msgs',state.sort.msgs,renderMsgs);}
document.addEventListener('DOMContentLoaded',init);(function checkAdminLogin(){let attempts=0;const maxAttempts=10;function tryCheckAdmin(){attempts++;if(typeof window.getAdminSession==='function'){const adminSession=window.getAdminSession();if(!adminSession||!adminSession.isLoggedIn||!adminSession.admin_id){console.warn('âš ï¸ ê´€ë¦¬ì ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');window.location.href='/secret/admin_login';return;}
console.log('âœ… ê´€ë¦¬ì ì¸ì¦ ì™„ë£Œ:',adminSession.username);}else{if(attempts<maxAttempts){setTimeout(tryCheckAdmin,100);}else{console.error('âŒ admin_session.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');console.error('   ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ìˆœì„œë¥¼ í™•ì¸í•˜ì„¸ìš”.');alert('ê´€ë¦¬ì ì„¸ì…˜ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');window.location.href='/secret/admin_login';}}}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',tryCheckAdmin);}else{tryCheckAdmin();}})();