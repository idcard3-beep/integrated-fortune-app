function getApiBase(){const currentPath=window.location.pathname;if(currentPath.startsWith('/secret/')){return'/secret/api/v1/tickets';}
return'/api/v1/tickets';}
const API_BASE=getApiBase();function goBack(){console.log('‚¨ÖÔ∏è Ïù¥Ï†Ñ Î≤ÑÌäº ÌÅ¥Î¶≠ - saju_exec.htmlÎ°ú Ïù¥Îèô');const currentPath=window.location.pathname;let sajuUrl='/saju/';if(currentPath.startsWith('/secret/')){sajuUrl='/saju/';}
console.log('üîÑ Ïù¥ÎèôÌï† URL:',sajuUrl);const hasSajuData=sessionStorage.getItem('sajuFormData');if(hasSajuData){console.log('üíæ sajuFormData Ïú†ÏßÄ - ÌôîÎ©¥ Î≥µÏõêÎê®');}else{console.log('‚ÑπÔ∏è sajuFormData ÏóÜÏùå - Ï¥àÍ∏∞ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô');}
window.location.href=sajuUrl;}
function openInSaju(){if(!selected){alert('‚ö†Ô∏è ÏÇ¨Ï£ºÎ≥¥Í∏∞Î•º Ìï† Îç∞Ïù¥ÌÑ∞Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.\n\nÍ∑∏Î¶¨ÎìúÏóêÏÑú ÏõêÌïòÎäî ÌñâÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');return;}
console.log('üîÆ ÏÑ†ÌÉùÎêú Îç∞Ïù¥ÌÑ∞Î°ú ÏÇ¨Ï£ºÎ≥¥Í∏∞ Ïã§Ìñâ:',selected);const ticketId=selected.ticket_id||selected.id;if(!ticketId){alert('‚ùå ticket_idÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.\nÎç∞Ïù¥ÌÑ∞Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');console.error('‚ùå ticket_id ÏóÜÏùå:',selected);return;}
console.log('üìã ticket_id:',ticketId);console.log('üìã ÏÑ†ÌÉùÎêú Îç∞Ïù¥ÌÑ∞:',{ticket_id:ticketId,author_name:selected.author_name,birth_datetime:selected.birth_datetime});const sajuUrl=`/saju/?ticket_id=${ticketId}`;console.log('üîÑ Ïù¥ÎèôÌï† URL:',sajuUrl);window.location.href=sajuUrl;}
function getSnsgFilter(){const urlParams=new URLSearchParams(window.location.search);return urlParams.get('snsgu');}
const SNSGU_FILTER=getSnsgFilter();function getSmemberIdFilter(){const urlParams=new URLSearchParams(window.location.search);const urlMemberId=urlParams.get('smember_id');if(urlMemberId){console.log('üìå URLÏóêÏÑú smember_id:',urlMemberId);return urlMemberId;}
let memberId=null;if(window.MEMBER_SESSION&&window.MEMBER_SESSION.sMem_id){memberId=window.MEMBER_SESSION.sMem_id;console.log('üìå MEMBER_SESSIONÏóêÏÑú smember_id:',memberId);return memberId;}
if(typeof window.sMem_id!=='undefined'&&window.sMem_id){memberId=window.sMem_id;console.log('üìå window.sMem_idÏóêÏÑú smember_id:',memberId);return memberId;}
if(typeof sMem_id!=='undefined'&&sMem_id){memberId=sMem_id;console.log('üìå Ï†ÑÏó≠ sMem_idÏóêÏÑú smember_id:',memberId);return memberId;}
console.log('‚ö†Ô∏è smember_idÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');return null;}
const SMEMBER_ID_FILTER=getSmemberIdFilter();console.log('üîç ÏµúÏ¢Ö SMEMBER_ID_FILTER:',SMEMBER_ID_FILTER);let selected=null;let allData=[];let sortColumn=null;let sortDirection='asc';function showMessage(msg,isError=true){const msgEl=document.getElementById('message');msgEl.textContent=msg;msgEl.className=isError?'error':'success';setTimeout(()=>{msgEl.textContent='';},5000);}
function sortData(column){if(sortColumn===column){sortDirection=sortDirection==='asc'?'desc':'asc';}else{sortColumn=column;sortDirection='asc';}
allData.sort((a,b)=>{let aVal=a[column];let bVal=b[column];if(aVal===null||aVal===undefined)aVal='';if(bVal===null||bVal===undefined)bVal='';if(column==='created_at'||column==='birth_datetime'){aVal=aVal?new Date(aVal).getTime():0;bVal=bVal?new Date(bVal).getTime():0;}
else if(column==='birth_hour'||column==='birth_minute'){aVal=aVal===''||aVal===null?-1:parseInt(aVal);bVal=bVal===''||bVal===null?-1:parseInt(bVal);}
else{if(typeof aVal==='string'){aVal=aVal.toLowerCase();}
if(typeof bVal==='string'){bVal=bVal.toLowerCase();}}
if(sortDirection==='asc'){return aVal>bVal?1:aVal<bVal?-1:0;}else{return aVal<bVal?1:aVal>bVal?-1:0;}});document.querySelectorAll('th').forEach(th=>{th.classList.remove('sort-asc','sort-desc');if(th.dataset.sort===column){th.classList.add(sortDirection==='asc'?'sort-asc':'sort-desc');}});renderTable();}
function renderTable(){const tb=document.querySelector('#grid tbody');tb.innerHTML='';if(!allData||allData.length===0){tb.innerHTML='<tr><td colspan="10" style="text-align:center;">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>';return;}
allData.forEach(r=>{const tr=document.createElement('tr');const ticketId=r.ticket_id||r.id;const title=r.title_masked||r.title||'';const authorName=r.author_name||'';const birthDatetime=r.birth_datetime?new Date(r.birth_datetime).toLocaleDateString('ko-KR'):'';const birthHour=r.birth_hour!==null&&r.birth_hour!==undefined?r.birth_hour:'';const birthMinute=r.birth_minute!==null&&r.birth_minute!==undefined?r.birth_minute:'';const calendarType=r.calendar_type||'';const authorGender=r.author_gender||'';const hourJi=r.hour_ji||'';const createdAt=r.created_at?new Date(r.created_at).toLocaleString('ko-KR'):'';tr.innerHTML=`
            <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;" title="${title}">${title}</td>
            <td title="${authorName}">${authorName}</td>
            <td>${calendarType}</td>
            <td>${birthDatetime}</td>
            <td>${birthHour}</td>
            <td>${birthMinute}</td>
            <td>${authorGender}</td>
            <td>${hourJi}</td>
            <td>${createdAt}</td>
            <td>
                <button onclick="openInSaju()" style="padding:2px 8px;font-size:11px;background:#007bff;color:white;border:none;border-radius:3px;cursor:pointer;">ÏÇ¨Ï£ºÎ≥¥Í∏∞</button>
            </td>
        `;tr.onclick=()=>select(tr,r);tb.appendChild(tr);});}
async function load(){try{showMessage('Ï°∞Ìöå Ï§ë...',false);let url=API_BASE;const params=new URLSearchParams();if(SNSGU_FILTER){params.append('snsgu',SNSGU_FILTER);console.log(`üîç snsgu ÌïÑÌÑ∞ Ï†ÅÏö©: ${SNSGU_FILTER}`);}
if(SMEMBER_ID_FILTER){params.append('smember_id',SMEMBER_ID_FILTER);console.log(`üîç smember_id ÌïÑÌÑ∞ Ï†ÅÏö©: ${SMEMBER_ID_FILTER}`);}
if(params.toString()){url+=`?${params.toString()}`;}
const res=await fetch(url);if(!res.ok){throw new Error(`Ï°∞Ìöå Ïã§Ìå®: ${res.status}`);}
const data=await res.json();allData=data||[];sortColumn=null;sortDirection='asc';document.querySelectorAll('th').forEach(th=>{th.classList.remove('sort-asc','sort-desc');});renderTable();let filterMsg='';if(SNSGU_FILTER||SMEMBER_ID_FILTER){const filters=[];if(SNSGU_FILTER)filters.push(`snsgu=${SNSGU_FILTER}`);if(SMEMBER_ID_FILTER)filters.push(`smember_id=${SMEMBER_ID_FILTER}`);filterMsg=` (${filters.join(', ')})`;}
showMessage(`Ï°∞Ìöå ÏôÑÎ£å (${allData.length}Í±¥${filterMsg})`,false);}catch(err){console.error('Ï°∞Ìöå Ïò§Î•ò:',err);showMessage(`Ï°∞Ìöå Ïò§Î•ò: ${err.message}`,true);}}
function select(tr,row){document.querySelectorAll('#grid tr').forEach(r=>r.classList.remove('selected'));tr.classList.add('selected');selected=row;const ticketId=row.ticket_id||row.id;document.getElementById('ticket_id').value=ticketId||'';document.getElementById('title_masked').value=row.title_masked||row.title||'';document.getElementById('content_enc').value=row.content_enc||row.content||'';document.getElementById('author_name').value=row.author_name||'';document.getElementById('author_nickname').value=row.author_nickname||'';document.getElementById('author_contact').value=row.author_contact||'';document.getElementById('time_input_type').value=row.time_input_type||'time';document.getElementById('hour_ji').value=row.hour_ji||'';document.getElementById('calendar_type').value=row.calendar_type||'ÏñëÎ†•';document.getElementById('yundal').value=row.yundal?'true':'false';document.getElementById('gwdate_time').value=row.gwdate_time?new Date(row.gwdate_time).toISOString().slice(0,16):'';document.getElementById('upper_hand').value=row.upper_hand||'';document.getElementById('lower_hand').value=row.lower_hand||'';document.getElementById('author_email').value=row.author_email||'';document.getElementById('author_gender').value=row.author_gender||'';document.getElementById('birth_date').value=row.birth_date?row.birth_date.split('T')[0]:'';document.getElementById('birth_datetime').value=row.birth_datetime?new Date(row.birth_datetime).toISOString().slice(0,16):'';document.getElementById('birth_hour').value=row.birth_hour||'';document.getElementById('birth_minute').value=row.birth_minute||'';document.getElementById('snsgu').value=row.snsgu||'';document.getElementById('choice1').value=row.choice1||'';document.getElementById('choice2').value=row.choice2||'';document.getElementById('choice3').value=row.choice3||'';document.getElementById('choice4').value=row.choice4||'';document.getElementById('choice5').value=row.choice5||'';document.getElementById('choice6').value=row.choice6||'';document.getElementById('choice7').value=row.choice7||'';document.getElementById('choice8').value=row.choice8||'';document.getElementById('choice9').value=row.choice9||'';document.getElementById('choice10').value=row.choice10||'';document.getElementById('choice11').value=row.choice11||'';document.getElementById('choice12').value=row.choice12||'';document.getElementById('agreement').value=row.agreement||0;document.getElementById('smember_id').value=row.smember_id||row.sMember_id||'';document.getElementById('admin_id').value=row.admin_id||'';document.getElementById('ti_role').value=row.ti_role||'';document.getElementById('post_pwd_hash').value='';document.getElementById('has_admin_reply').value=row.has_admin_reply?'true':'false';document.getElementById('status').value=row.status||'OPEN';}
function resetForm(){document.querySelectorAll('.form input, .form textarea').forEach(e=>{if(e.type==='checkbox'){e.checked=false;}else if(e.type==='number'){e.value='';}else{e.value='';}});document.querySelectorAll('.form select').forEach(e=>e.selectedIndex=0);document.getElementById('ticket_id').value='';document.getElementById('agreement').value='0';document.getElementById('calendar_type').value='ÏñëÎ†•';document.getElementById('time_input_type').value='time';document.getElementById('status').value='OPEN';document.getElementById('yundal').value='false';document.getElementById('has_admin_reply').value='false';selected=null;document.querySelectorAll('#grid tr').forEach(r=>r.classList.remove('selected'));}
function collect(){const o={};document.querySelectorAll('.form input, .form textarea, .form select').forEach(e=>{if(e.id==='ticket_id')return;const val=e.value;if(e.type==='number'){o[e.id]=val?parseInt(val):(e.id==='agreement'?0:null);}else if(e.type==='checkbox'){o[e.id]=e.checked;}else if(e.type==='date'||e.type==='datetime-local'){o[e.id]=val||null;}else if(e.tagName==='SELECT'&&(e.id==='yundal'||e.id==='has_admin_reply')){o[e.id]=val==='true';}else{o[e.id]=val||'';}});return o;}
async function save(){const ticketId=document.getElementById('ticket_id').value;const payload=collect();if(!payload.title_masked||!payload.content_enc){showMessage('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÄ ÌïÑÏàòÏûÖÎãàÎã§.',true);return;}
try{if(ticketId){showMessage('ÏàòÏ†ï Ï§ë...',false);const updatePayload={title:payload.title_masked,content:payload.content_enc,author_name:payload.author_name,author_contact:payload.author_contact};const res=await fetch(`${API_BASE}/${ticketId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(updatePayload)});const result=await res.json();if(!res.ok){throw new Error(result.error||'ÏàòÏ†ï Ïã§Ìå®');}
showMessage('ÏàòÏ†ï ÏôÑÎ£å',false);}else{showMessage('Ï∂îÍ∞Ä Ï§ë...',false);if(!payload.post_pwd_hash){showMessage('Í≤åÏãúÍ∏Ä ÎπÑÎ∞ÄÎ≤àÌò∏Îäî ÌïÑÏàòÏûÖÎãàÎã§.',true);return;}
const createPayload={title:payload.title_masked,content:payload.content_enc,post_password:payload.post_pwd_hash,author_name:payload.author_name,author_nickname:payload.author_nickname,author_contact:payload.author_contact,author_email:payload.author_email,author_gender:payload.author_gender,snsgu:payload.snsgu||'A0001',smember_id:payload.smember_id||null,admin_id:payload.admin_id||null,ti_role:payload.ti_role||null,agreement:payload.agreement||0};const res=await fetch(API_BASE,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(createPayload)});const result=await res.json();if(!res.ok){throw new Error(result.error||'Ï∂îÍ∞Ä Ïã§Ìå®');}
showMessage('Ï∂îÍ∞Ä ÏôÑÎ£å',false);resetForm();}
await load();}catch(err){console.error('Ï†ÄÏû• Ïò§Î•ò:',err);showMessage(`Ï†ÄÏû• Ïò§Î•ò: ${err.message}`,true);}}
async function remove(){const ticketId=document.getElementById('ticket_id').value;if(!ticketId){showMessage('ÏÇ≠Ï†úÌï† Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.',true);return;}
if(!confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')){return;}
try{showMessage('ÏÇ≠Ï†ú Ï§ë...',false);const res=await fetch(`${API_BASE}/${ticketId}`,{method:'DELETE'});const result=await res.json();if(!res.ok){throw new Error(result.error||'ÏÇ≠Ï†ú Ïã§Ìå®');}
showMessage('ÏÇ≠Ï†ú ÏôÑÎ£å',false);resetForm();await load();}catch(err){console.error('ÏÇ≠Ï†ú Ïò§Î•ò:',err);showMessage(`ÏÇ≠Ï†ú Ïò§Î•ò: ${err.message}`,true);}}
document.addEventListener('DOMContentLoaded',function(){document.querySelectorAll('th[data-sort]').forEach(th=>{th.addEventListener('click',function(){sortData(this.dataset.sort);});});load();});