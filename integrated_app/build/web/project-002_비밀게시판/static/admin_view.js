console.log('=== ê´€ë¦¬ì ìƒì„¸ë³´ê¸° ì‹œì‘ (ìƒíƒœ ì–‘í˜¸) ===');const ticketId=new URLSearchParams(location.search).get('id');console.log('âœ… í‹°ì¼“ ID:',ticketId);console.log('ğŸ—„ï¸ ì—°ê²° ìƒíƒœ ì–‘í˜¸ ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘...');function load(){const url=`/secret/api/v1/admin/tickets/${ticketId}`;console.log('ğŸš€ ê´€ë¦¬ì í‹°ì¼“ ë°ì´í„° ë¡œë“œ:',url);fetch(url).then((r)=>{if(r.status===401){alert('ì„¸ì…˜ ë§Œë£Œ');location.href='/secret/admin_login';return;}
return r.json();}).then((d)=>{if(!d)return;document.getElementById('meta').innerText=`ì œëª©:${d.ticket.title}/ì‘ì„±ì:${d.ticket.author_name||'ë¯¸ë“±ë¡'}/ë©”ëª¨ë€:${d.ticket.author_contact||'ë¯¸ë“±ë¡'}/ìë£Œêµ¬ë¶„:${d.ticket.snsgu||'A0001'}/ìƒíƒœ:${d.ticket.status}/ìƒì„±:${d.ticket.created_at}`;document.getElementById('content').innerText=d.ticket.content;const box=document.getElementById('thread');box.innerHTML='';d.messages.forEach((m)=>{const container=document.createElement('div');const isAdminMessage=m.role&&m.role.toUpperCase()!=='xUSER';container.className=`message-container ${isAdminMessage?'admin':'user'}`;container.setAttribute('data-msg-id',m.msg_id);const contentDiv=document.createElement('div');contentDiv.className='message-content';contentDiv.innerHTML=`<strong>${m.role}:</strong><span class="msg-text">${m.content}</span>`;container.appendChild(contentDiv);if(isAdminMessage){const currentAdminId=window.ADMIN_SESSION?.admin_id;const currentRole=window.ADMIN_SESSION?.role;console.log(`ğŸ” ê¶Œí•œ ì²´í¬-ë©”ì‹œì§€:{admin_id:${m.admin_id},role:${m.role}},í˜„ì¬ ì„¸ì…˜:{admin_id:${currentAdminId},role:${currentRole}}`);let canEdit=false;let canDelete=false;if(currentRole&&currentRole.toUpperCase()==='ADMIN'){canEdit=true;canDelete=true;console.log('âœ… ADMIN ê¶Œí•œ - ëª¨ë“  ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥');}
else{if(m.admin_id&&currentAdminId&&m.admin_id===currentAdminId&&m.role&&currentRole&&m.role.toUpperCase()===currentRole.toUpperCase()){canEdit=true;console.log('âœ… ë³¸ì¸ ë©”ì‹œì§€ - ìˆ˜ì •ë§Œ ê°€ëŠ¥');}else{console.log('âŒ ê¶Œí•œ ì—†ìŒ - ìˆ˜ì •/ì‚­ì œ ë¶ˆê°€');}}
if(canEdit||canDelete){const actionsDiv=document.createElement('div');actionsDiv.className='message-actions';if(canEdit){const editBtn=document.createElement('button');editBtn.className='btn-edit';editBtn.textContent='ìˆ˜ì •';editBtn.onclick=()=>enableEditMode(m.msg_id,m.content);actionsDiv.appendChild(editBtn);}
if(canDelete){const deleteBtn=document.createElement('button');deleteBtn.className='btn-delete';deleteBtn.textContent='ì‚­ì œ';deleteBtn.onclick=()=>deleteMessage(m.msg_id);actionsDiv.appendChild(deleteBtn);}
container.appendChild(actionsDiv);}}
box.appendChild(container);});});}
function sendAdminReply(){console.log('ğŸ”„ sendAdminReply í•¨ìˆ˜ í˜¸ì¶œë¨');const content=document.getElementById('adminReply').value.trim();console.log('ğŸ“ ì…ë ¥ëœ ë‚´ìš©:',content);if(!content){console.log('âŒ ë‚´ìš©ì´ ë¹„ì–´ìˆìŒ');return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');}
const adminId=window.ADMIN_SESSION?.admin_id;console.log('ğŸ‘¤ í˜„ì¬ ë¡œê·¸ì¸í•œ admin_id:',adminId);if(!adminId){console.error('âŒ admin_idë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ - ì„¸ì…˜ í™•ì¸ í•„ìš”');alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');location.href='/secret/admin_login';return;}
const requestData={content:content,admin_id:adminId,};console.log('ğŸ“ PostgreSQLì— ê´€ë¦¬ì ë‹µë³€ ì €ì¥:',content);const url=`/secret/api/v1/admin/tickets/${ticketId}/reply`;console.log('ğŸš€ ë‹µë³€ ë“±ë¡ ìš”ì²­:',url);console.log('ğŸ“¤ ìš”ì²­ ë°ì´í„°:',requestData);fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(requestData),}).then((r)=>{console.log('âœ… ì‘ë‹µ ìƒíƒœ:',r.status);console.log('âœ… ì‘ë‹µ í—¤ë”:',r.headers.get('content-type'));if(r.status===401){console.log('âŒ ì„¸ì…˜ ë§Œë£Œ');alert('ì„¸ì…˜ ë§Œë£Œ');location.href='/secret/admin_login';return;}
if(!r.ok){console.error('âŒ HTTP ì—ëŸ¬:',r.status,r.statusText);throw new Error(`HTTP ${r.status}:${r.statusText}`);}
return r.json();}).then((result)=>{console.log('âœ… ë‹µë³€ ë“±ë¡ ì„±ê³µ:',result);document.getElementById('adminReply').value='';alert('ë‹µë³€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');load();}).catch((error)=>{console.error('âŒ ë‹µë³€ ë“±ë¡ ì—ëŸ¬:',error);console.error('âŒ ì—ëŸ¬ ìŠ¤íƒ:',error.stack);alert('ë‹µë³€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);});}
function enableEditMode(msgId,currentContent){console.log('âœï¸ ìˆ˜ì • ëª¨ë“œ í™œì„±í™”:',msgId);const container=document.querySelector(`[data-msg-id="${msgId}"]`);if(!container)return;const contentDiv=container.querySelector('.message-content');const actionsDiv=container.querySelector('.message-actions');const textarea=document.createElement('textarea');textarea.className='edit-textarea';textarea.value=currentContent;const saveBtn=document.createElement('button');saveBtn.className='btn-save';saveBtn.textContent='ì €ì¥';saveBtn.onclick=()=>saveMessage(msgId,textarea.value,currentContent);const cancelBtn=document.createElement('button');cancelBtn.className='btn-cancel';cancelBtn.textContent='ì·¨ì†Œ';cancelBtn.onclick=()=>load();contentDiv.innerHTML='';contentDiv.appendChild(textarea);actionsDiv.innerHTML='';actionsDiv.appendChild(saveBtn);actionsDiv.appendChild(cancelBtn);textarea.focus();}
function saveMessage(msgId,newContent,originalContent){console.log('ğŸ’¾ ë©”ì‹œì§€ ì €ì¥:',msgId);if(!newContent.trim()){return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');}
if(newContent===originalContent){console.log('âš ï¸ ë‚´ìš©ì´ ë³€ê²½ë˜ì§€ ì•ŠìŒ');return load();}
const url=`/secret/api/v1/admin/messages/${msgId}`;console.log('ğŸš€ ë©”ì‹œì§€ ìˆ˜ì • ìš”ì²­:',url);fetch(url,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:newContent}),}).then((r)=>{console.log('âœ… ì‘ë‹µ ìƒíƒœ:',r.status);if(r.status===401){console.log('âŒ ì„¸ì…˜ ë§Œë£Œ');alert('ì„¸ì…˜ ë§Œë£Œ');location.href='/secret/admin_login';return;}
if(!r.ok){console.error('âŒ HTTP ì—ëŸ¬:',r.status,r.statusText);throw new Error(`HTTP ${r.status}:${r.statusText}`);}
return r.json();}).then((result)=>{console.log('âœ… ë©”ì‹œì§€ ìˆ˜ì • ì„±ê³µ:',result);alert('ë©”ì‹œì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');load();}).catch((error)=>{console.error('âŒ ë©”ì‹œì§€ ìˆ˜ì • ì—ëŸ¬:',error);alert('ë©”ì‹œì§€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);});}
function deleteMessage(msgId){console.log('ğŸ—‘ï¸ ë©”ì‹œì§€ ì‚­ì œ ìš”ì²­:',msgId);if(!confirm('ì •ë§ë¡œ ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){console.log('âŒ ì‚­ì œ ì·¨ì†Œë¨');return;}
const url=`/secret/api/v1/admin/messages/${msgId}`;console.log('ğŸš€ ë©”ì‹œì§€ ì‚­ì œ ìš”ì²­:',url);fetch(url,{method:'DELETE',}).then((r)=>{console.log('âœ… ì‘ë‹µ ìƒíƒœ:',r.status);if(r.status===401){console.log('âŒ ì„¸ì…˜ ë§Œë£Œ');alert('ì„¸ì…˜ ë§Œë£Œ');location.href='/secret/admin_login';return;}
if(!r.ok){console.error('âŒ HTTP ì—ëŸ¬:',r.status,r.statusText);throw new Error(`HTTP ${r.status}:${r.statusText}`);}
return r.json();}).then((result)=>{console.log('âœ… ë©”ì‹œì§€ ì‚­ì œ ì„±ê³µ:',result);alert('ë©”ì‹œì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');load();}).catch((error)=>{console.error('âŒ ë©”ì‹œì§€ ì‚­ì œ ì—ëŸ¬:',error);alert('ë©”ì‹œì§€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);});}
document.addEventListener('DOMContentLoaded',load);