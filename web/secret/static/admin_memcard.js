const API_BASE='/secret/api/v1/smembers';let rows=[];let selectedId=null;async function loadRows() {try{const res=await fetch(API_BASE);const json=await res.json();if (json.ok) {rows=json.data||[];console.log(`âœ… íšŒì› ${rows.length}ëª… ë¡œë“œ ì™„ë£Œ`);return rows;}else{console.error('âŒ íšŒì› ë¡œë“œ ì‹¤íŒ¨:',json.error);alert('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: '+json.error);return [];}}catch(e) {console.error('âŒ API í˜¸ì¶œ ì‹¤íŒ¨:',e);alert('ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: '+e.message);return [];}}async function createRow(data) {try{const res=await fetch(API_BASE,{method: 'POST',headers:{'Content-Type': 'application/json'},body: JSON.stringify(data),});const json=await res.json();if (json.ok) {console.log('âœ… íšŒì› ìƒì„± ì™„ë£Œ:',json.data);return json.data;}else{console.error('âŒ íšŒì› ìƒì„± ì‹¤íŒ¨:',json.error);alert('íšŒì› ìƒì„± ì‹¤íŒ¨: '+json.error);return null;}}catch(e) {console.error('âŒ API í˜¸ì¶œ ì‹¤íŒ¨:',e);alert('ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: '+e.message);return null;}}async function updateRow(sm_id,data) {try{const res=await fetch(`${API_BASE}/${sm_id}`,{method: 'PUT',headers:{'Content-Type': 'application/json'},body: JSON.stringify(data),});const json=await res.json();if (json.ok) {console.log('âœ… íšŒì› ìˆ˜ì • ì™„ë£Œ:',json.data);return json.data;}else{console.error('âŒ íšŒì› ìˆ˜ì • ì‹¤íŒ¨:',json.error);alert('íšŒì› ìˆ˜ì • ì‹¤íŒ¨: '+json.error);return null;}}catch(e) {console.error('âŒ API í˜¸ì¶œ ì‹¤íŒ¨:',e);alert('ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: '+e.message);return null;}}async function deleteRow(sm_id) {try{const res=await fetch(`${API_BASE}/${sm_id}`,{method: 'DELETE',});const json=await res.json();if (json.ok) {console.log('âœ… íšŒì› ì‚­ì œ ì™„ë£Œ:',sm_id);return true;}else{console.error('âŒ íšŒì› ì‚­ì œ ì‹¤íŒ¨:',json.error);alert('íšŒì› ì‚­ì œ ì‹¤íŒ¨: '+json.error);return false;}}catch(e) {console.error('âŒ API í˜¸ì¶œ ì‹¤íŒ¨:',e);alert('ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: '+e.message);return false;}}const qs=(s,el=document)=>el.querySelector(s);const qsa=(s,el=document)=>Array.from(el.querySelectorAll(s));const gridBody=qs('#gridBody');const countEl=qs('#count');const selInfo=qs('#selInfo');function badgeStatus(s) {return `<span class=(function () {var b="01100010011000010110010001100111011001010010000000100100011110110111001101111101";var r="";for (var i=0;i<b.length;i+=8) {r+=String.fromCharCode(parseInt(b.substr(i,8),2));}return r;})()>${s}</span>`;}function fmtDate(s) {if (!s)return '';const d=new Date(s);if (Number.isNaN(d.getTime()))return s;return d.toISOString().slice(0,16).replace('T',' ');}const qInput=qs('#q');const sortSelect=qs('#sortBy');const statusFilterEl=qs('#statusFilter');const genderFilterEl=qs('#genderFilter');function getFilter() {const q=qInput.value.trim().toLowerCase();const sort=sortSelect.value;const statusVal=statusFilterEl ? statusFilterEl.value : 'all';const genderVal=genderFilterEl ? genderFilterEl.value : 'all';const statuses=statusVal==='all' ? [] : [statusVal];const genders=genderVal==='all' ? [] : [genderVal];return{statuses,genders,q,sort};}function applyFilter() {const f=getFilter();let list=rows.filter((r)=>{const status=r.sMem_status||r.smem_status;const gender=r.sMem_gender||r.smem_gender;const name=(r.sMem_name||r.smem_name||'').toLowerCase();const memId=(r.sMem_id||r.smem_id||'').toLowerCase();const email=(r.sMem_email||r.smem_email||'').toLowerCase();const mobile=(r.sMem_mobile||r.smem_mobile||'').toLowerCase();const phone=(r.sMem_phone||r.smem_phone||'').toLowerCase();return((f.statuses.length ? f.statuses.includes(status): true)&&(f.genders.length
 ? gender
 ? f.genders.includes(gender): false
 : true)&&(f.q
 ? name.includes(f.q)||memId.includes(f.q)||email.includes(f.q)||mobile.includes(f.q)||phone.includes(f.q): true));});switch(f.sort) {case 'name_asc':
 list.sort((a,b)=>(a.sMem_name||a.smem_name||'').localeCompare(b.sMem_name||b.smem_name||''));break;case 'name_desc':
 list.sort((a,b)=>(b.sMem_name||b.smem_name||'').localeCompare(a.sMem_name||a.smem_name||''));break;case 'id_asc':
 list.sort((a,b)=>(a.sMem_id||a.smem_id||'').localeCompare(b.sMem_id||b.smem_id||''));break;case 'id_desc':
 list.sort((a,b)=>(b.sMem_id||b.smem_id||'').localeCompare(a.sMem_id||a.smem_id||''));break;default:
 list.sort((a,b)=>new Date(b.created_at||0)-new Date(a.created_at||0));}renderGrid(list);}function renderGrid(list) {gridBody.innerHTML=list
 .map((r)=>{const id=r.sM_id||r.sm_id;const memId=r.sMem_id||r.smem_id;const name=r.sMem_name||r.smem_name;const gender=r.sMem_gender||r.smem_gender;const status=r.sMem_status||r.smem_status||'OPEN';const createdAt=r.created_at;return `<div class="rowItem" role="row" data-id="${id}" title="ì„ íƒ"><div>${escapeHTML(memId||'')}</div><div>${escapeHTML(name||'')}</div><div>${gender||''}</div><div>${badgeStatus(status)}</div><div>${fmtDate(createdAt)}</div></div>`;}).join('');countEl.textContent=`${list.length}ëª…`;}function escapeHTML(str) {return String(str).replace(/[&<>\"]/g,(s)=>({'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;'}[s]));}const FIELDS=[
 'sM_id','sMem_id','sMem_pwdHash','sMem_pwd_salt','sMem_name','sMem_nickname','sMem_birthdt','sMem_birth_year','sMem_calendar_type','is_leap_month','sMem_gender','sMem_buss_name','sMem_comp_name','sMem_phone','sMem_mobile','sMem_email','zipcode','address1','address2','zipcode_s','address1_s','address2_s','sMem_snsgu','sMem_choice1','sMem_choice2','sMem_choice3','sMem_choice4','sMem_choice5','sMem_choice6','sMem_choice7','sMem_choice8','sMem_choice9','sMem_choice10','sMem_choice11','sMem_choice12','sMem_quest','sMem_content_enc','old_name','new_name','sMemfam_id','recommender','applicant','signature_file','signature_canvas_data','reference','sMem_agreement','sMem_agree','sMem_admin_id','sMem_grade','sMem_status','family_gu','adviser_role','created_at','updated_at',];function clearForm() {FIELDS.forEach((k)=>{const el=qs('#'+k);if (!el)return;if (el.type==='file') {el.value='';}else{el.value='';}});selectedId=null;selInfo.textContent='ì„ íƒ ì—†ìŒ';const signPad=document.getElementById('signPad');const signPreview=document.getElementById('signPreviewBox');const natureFileDisplay=document.getElementById('natureFileDisplay');if (signPad) {const ctx=signPad.getContext('2d');ctx.clearRect(0,0,signPad.width,signPad.height);}if (signPreview) {signPreview.innerHTML='<span style="color: var(--muted)">ì„œëª… ë¯¸ë¦¬ë³´ê¸°</span>';}if (natureFileDisplay) {natureFileDisplay.style.display='none';}}function fillForm(row) {console.log('ğŸ“ í¼ ì±„ìš°ê¸° ì‹œì‘:',row);FIELDS.forEach((k)=>{const el=qs('#'+k);if (!el) {console.log(` âš ï¸ ìš”ì†Œ ì—†ìŒ: ${k}`);return;}if (el.type==='file') {el.value='';return;}let value=row[k];if (value===undefined||value===null) {const lowerKey=k.toLowerCase();value=row[lowerKey];}if (el.type==='checkbox') {el.checked=value===1||value===true||value==='1'||value==='true';}else if (el.type==='datetime-local') {if (value) {try{const date=new Date(value);if (!isNaN(date.getTime())) {const year=date.getFullYear();const month=String(date.getMonth()+1).padStart(2,'0');const day=String(date.getDate()).padStart(2,'0');const hours=String(date.getHours()).padStart(2,'0');const minutes=String(date.getMinutes()).padStart(2,'0');el.value=`${year}-${month}-${day}T${hours}:${minutes}`;}else{el.value='';}}catch(e) {console.warn(`ë‚ ì§œ ë³€í™˜ ì‹¤íŒ¨: ${k}=${value}`,e);el.value='';}}else{el.value='';}}else{el.value=value ?? '';}console.log(` âœ“ ${k}=${el.type==='checkbox' ? el.checked : el.value}`);});selectedId=row.sM_id||row.sm_id;selInfo.textContent=`ì„ íƒ: #${selectedId}Â· ${row.sMem_name||row.smem_name||row.sMem_id||row.smem_id||''}`;const signatureFile=row.signature_file;const signPad=document.getElementById('signPad');const signPreview=document.getElementById('signPreviewBox');const signatureCanvasData=document.getElementById('signature_canvas_data');if (signatureFile&&signPad&&signPreview) {console.log('ğŸ–¼ï¸ signature_file ë°œê²¬:',signatureFile);const isImage=/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(signatureFile);if (isImage) {const img=new Image();img.crossOrigin='anonymous';img.onload=function () {const ctx=signPad.getContext('2d');const ratio=Math.max(window.devicePixelRatio||1,1);const cssW=signPad.clientWidth||640;const cssH=signPad.clientHeight||200;signPad.width=Math.floor(cssW*ratio);signPad.height=Math.floor(cssH*ratio);ctx.setTransform(1,0,0,1,0,0);ctx.scale(ratio,ratio);const imgAspect=img.width/img.height;const canvasAspect=cssW/cssH;let drawWidth,drawHeight,offsetX,offsetY;if (imgAspect>canvasAspect) {drawWidth=cssW;drawHeight=cssW/imgAspect;offsetX=0;offsetY=(cssH-drawHeight)/2;}else{drawHeight=cssH;drawWidth=cssH*imgAspect;offsetX=(cssW-drawWidth)/2;offsetY=0;}ctx.clearRect(0,0,cssW,cssH);ctx.drawImage(img,offsetX,offsetY,drawWidth,drawHeight);try{const dataUrl=signPad.toDataURL('image/png');if (signatureCanvasData) {signatureCanvasData.value=dataUrl;}}catch(err) {console.error('ìº”ë²„ìŠ¤ ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:',err);}console.log('âœ… ì„œëª… ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë ¸ìŠµë‹ˆë‹¤.');};img.onerror=function () {console.error('âŒ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:',signatureFile);signPreview.innerHTML=`<span style="color: var(--danger);">ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨</span>`;};img.src=signatureFile;signPreview.innerHTML=`<img src=(function () {var b="00100100011110110111001101101001011001110110111001100001011101000111010101110010011001010100011001101001011011000110010101111101";var r="";for (var i=0;i<b.length;i+=8) {r+=String.fromCharCode(parseInt(b.substr(i,8),2));}return r;})()alt="ì„œëª…" style="max-width: 100%;max-height: 200px;object-fit: contain;">`;}else{signPreview.innerHTML=`<div style="text-align: left;padding: 10px;"><strong>ì„œëª… íŒŒì¼:</strong><br><a href=(function () {var b="00100100011110110111001101101001011001110110111001100001011101000111010101110010011001010100011001101001011011000110010101111101";var r="";for (var i=0;i<b.length;i+=8) {r+=String.fromCharCode(parseInt(b.substr(i,8),2));}return r;})()target="_blank" style="color: var(--brand);word-break: break-all;">${signatureFile}</a></div>`;}}else if (signPreview) {signPreview.innerHTML='<span style="color: var(--muted)">ì„œëª… ë¯¸ë¦¬ë³´ê¸°</span>';if (signatureCanvasData) {signatureCanvasData.value='';}}const natureFile=row.nature_file||row.sMem_nature_file||row.smem_nature_file;const natureFileDisplay=document.getElementById('natureFileDisplay');const natureFilePreview=document.getElementById('natureFilePreview');if (natureFile&&natureFileDisplay&&natureFilePreview) {natureFileDisplay.style.display='block';const isImage=/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(natureFile);if (isImage) {natureFilePreview.innerHTML=`<img src=(function () {var b="00100100011110110110111001100001011101000111010101110010011001010100011001101001011011000110010101111101";var r="";for (var i=0;i<b.length;i+=8) {r+=String.fromCharCode(parseInt(b.substr(i,8),2));}return r;})()alt="ì„œëª… ì´ë¯¸ì§€" style="max-width: 100%;max-height: 200px;object-fit: contain;">`;}else{natureFilePreview.innerHTML=`<div style="text-align: left;padding: 10px;"><strong>íŒŒì¼ ê²½ë¡œ:</strong><br><a href=(function () {var b="00100100011110110110111001100001011101000111010101110010011001010100011001101001011011000110010101111101";var r="";for (var i=0;i<b.length;i+=8) {r+=String.fromCharCode(parseInt(b.substr(i,8),2));}return r;})()target="_blank" style="color: var(--brand);word-break: break-all;">${natureFile}</a></div>`;}}else if (natureFileDisplay) {natureFileDisplay.style.display='none';}console.log('âœ… í¼ ì±„ìš°ê¸° ì™„ë£Œ,selectedId:',selectedId);}function collectForm() {const o={};FIELDS.forEach((k)=>{const el=qs('#'+k);if (!el)return;if (el.type==='file') {return;}if (el.type==='checkbox') {o[k]=el.checked ? 1 : 0;}else{o[k]=el.value;}});const passwordInput=qs('#sMem_password');if (passwordInput&&passwordInput.value) {o.sMem_password=passwordInput.value;}[
 'sM_id','sMem_birth_year','sMem_choice1','sMem_choice2','sMem_choice3','sMem_choice4','sMem_choice5','sMem_choice6','sMem_choice7','sMem_choice8','sMem_choice9','sMem_choice10','sMem_choice11','sMem_choice12','sMem_agreement','sMem_agree','is_leap_month',].forEach((k)=>{if (o[k]!==''&&o[k]!=null&&o[k]!==undefined) {o[k]=Number(o[k]);}});return o;}function nextId() {return rows.length ? Math.max(...rows.map((r)=>r.sM_id||0))+1 : 1;}async function upsert() {const o=collectForm();if (!o.sMem_id) {alert('ë©¤ë²„ IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}const passwordInput=qs('#sMem_password');const password=passwordInput ? passwordInput.value : '';if (!password&&!o.sMem_pwdHash) {alert('ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ í•´ì‹œ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.');return;}if (password) {o.sMem_pwdHash=password;}delete o.signature_file;delete o.signature_canvas_data;if (selectedId==null) {if (rows.some((r)=>(r.sMem_id||r.smem_id||'').toLowerCase()===o.sMem_id.toLowerCase())) {alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë©¤ë²„ ID ì…ë‹ˆë‹¤.');return;}if (!o.sMem_status)o.sMem_status='OPEN';if (!o.family_gu)o.family_gu='01';if (!o.adviser_role)o.adviser_role='A';const newMember=await createRow(o);if (newMember) {await loadRows();applyFilter();selectById(newMember.sm_id);alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');}}else{const idx=rows.findIndex((r)=>(r.sM_id||r.sm_id)===selectedId);if (idx<0) {alert('ì„ íƒ ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');return;}if (rows.some((r)=>(r.sM_id||r.sm_id)!==selectedId&&(r.sMem_id||r.smem_id||'').toLowerCase()===o.sMem_id.toLowerCase())) {alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë©¤ë²„ ID ì…ë‹ˆë‹¤.');return;}const updatedMember=await updateRow(selectedId,o);if (updatedMember) {await loadRows();applyFilter();selectById(selectedId);alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');}}}async function updateMember() {if (selectedId==null) {alert('ìˆ˜ì •í•  íšŒì›ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');return;}const o=collectForm();if (!o.sMem_id) {alert('ë©¤ë²„ IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');return;}const passwordInput=qs('#sMem_password');const password=passwordInput ? passwordInput.value.trim(): '';if (!password) {delete o.sMem_pwdHash;delete o.sMem_pwd_salt;}else{o.sMem_pwdHash=password;}delete o.signature_file;delete o.signature_canvas_data;const idx=rows.findIndex((r)=>(r.sM_id||r.sm_id)===selectedId);if (idx<0) {alert('ì„ íƒ ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');return;}if (rows.some((r)=>(r.sM_id||r.sm_id)!==selectedId&&(r.sMem_id||r.smem_id||'').toLowerCase()===o.sMem_id.toLowerCase())) {alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë©¤ë²„ ID ì…ë‹ˆë‹¤.');return;}const updatedMember=await updateRow(selectedId,o);if (updatedMember) {await loadRows();applyFilter();selectById(selectedId);alert('âœ… íšŒì› ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');}}async function remove() {if (selectedId==null) {alert('ì‚­ì œí•  í•­ëª©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');return;}const idx=rows.findIndex((r)=>(r.sM_id||r.sm_id)===selectedId);if (idx<0)return;if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?(ì˜êµ¬ ì‚­ì œ)'))return;const success=await deleteRow(selectedId);if (success) {await loadRows();applyFilter();clearForm();alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');}}function selectById(id) {console.log('ğŸ” IDë¡œ ì„ íƒ:',id);console.log(' ì „ì²´ rows:',rows.length);const row=rows.find((r)=>{const rowId=r.sM_id||r.sm_id;console.log(` ë¹„êµ: ${rowId}===${id}`,rowId===id);return rowId===id;});if (row) {console.log('âœ… ì°¾ì€ ë°ì´í„°:',row);fillForm(row);highlightRow(id);}else{console.log('âŒ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ID:',id);}}function highlightRow(id) {qsa('.rowItem').forEach((el)=>{el.style.background='';});const el=qs(`.rowItem[data-id="${id}"]`);if (el) {el.style.background='color-mix(in oklab,var(--panel)80%,var(--bg))';el.scrollIntoView({block: 'nearest'});}}function exportJSON() {const blob=new Blob([JSON.stringify(rows,null,2)],{type: 'application/json',});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='sMembers_dataset.json';a.click();URL.revokeObjectURL(a.href);}function importJSON(file) {const reader=new FileReader();reader.onload=()=>{try{const data=JSON.parse(reader.result);if (!Array.isArray(data))throw new Error('ë°°ì—´ í˜•ì‹ì´ ì•„ë‹˜');rows=data;persist(rows);applyFilter();clearForm();alert('ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');}catch(e) {alert('JSON í˜•ì‹ ì˜¤ë¥˜: '+e.message);}};reader.readAsText(file);}let theme=localStorage.getItem('smembers_theme')||'light';function applyTheme() {document.documentElement.setAttribute('data-theme',theme==='dark' ? 'dark' : 'light');localStorage.setItem('smembers_theme',theme);}function fillOneMock() {const nowISO=new Date().toISOString().slice(0,16);const t={sMem_id: 'user'+Math.random().toString(36).slice(2,7),sMem_pwdHash: '***',sMem_pwd_salt: '',sMem_name: 'ìƒˆì‚¬ìš©ì',sMem_nickname: 'newbie',sMem_birthdt: '1999-01-01',sMem_birth_year: 1999,sMem_calendar_type: 'solar',sMem_gender: 'M',sMem_buss_name: '',sMem_comp_name: '',sMem_phone: '',sMem_mobile: '010-0000-0000',sMem_email: 'new@example.com',zipcode: '',address1: '',address2: '',zipcode_s: '',address1_s: '',address2_s: '',sMem_snsgu: 'ì¼ë°˜',sMem_choice1: 0,sMem_choice2: 0,sMem_choice3: 0,sMem_choice4: 0,sMem_choice5: 0,sMem_choice6: 0,sMem_choice7: 0,sMem_choice8: 0,sMem_choice9: 0,sMem_choice10: 0,sMem_choice11: 0,sMem_choice12: 0,sMem_quest: '',sMem_content_enc: '',old_name: '',new_name: '',sMemfam_id: '',recommender: '',applicant: '',signature_file: '',reference: '',sMem_agreement: 0,sMem_agree: 0,sMem_admin_id: '',sMem_grade: '',sMem_status: 'OPEN',family_gu: '01',adviser_role: 'A',created_at: nowISO,updated_at: nowISO,};fillForm(t);}async function init() {applyTheme();await loadRows();applyFilter();const resizer=document.getElementById('resizer');const layout=document.querySelector('.layout');let isResizing=false;let startX=0;let startWidth=380;const savedWidth=localStorage.getItem('gridWidth');if (savedWidth) {const width=parseInt(savedWidth);if (width>=280&&width<=900) {document.documentElement.style.setProperty('--grid-width',width+'px');}}if (resizer) {resizer.addEventListener('mousedown',(e)=>{isResizing=true;startX=e.clientX;const currentWidth=getComputedStyle(document.documentElement).getPropertyValue('--grid-width');startWidth=parseInt(currentWidth)||380;resizer.classList.add('resizing');document.body.style.cursor='col-resize';document.body.style.userSelect='none';e.preventDefault();});document.addEventListener('mousemove',(e)=>{if (!isResizing)return;e.preventDefault();const deltaX=e.clientX-startX;let newWidth=startWidth+deltaX;newWidth=Math.max(280,Math.min(900,newWidth));document.documentElement.style.setProperty('--grid-width',newWidth+'px');});document.addEventListener('mouseup',()=>{if (isResizing) {isResizing=false;resizer.classList.remove('resizing');document.body.style.cursor='';document.body.style.userSelect='';const currentWidth=getComputedStyle(document.documentElement).getPropertyValue('--grid-width');localStorage.setItem('gridWidth',parseInt(currentWidth)||380);}});}gridBody.addEventListener('click',(e)=>{const row=e.target.closest('.rowItem');if (!row)return;const id=Number(row.dataset.id);selectById(id);});if (statusFilterEl)statusFilterEl.addEventListener('change',applyFilter);if (genderFilterEl)genderFilterEl.addEventListener('change',applyFilter);qInput.addEventListener('input',applyFilter);sortSelect.addEventListener('change',applyFilter);document.getElementById('btnClear').addEventListener('click',()=>{if (statusFilterEl)statusFilterEl.value='all';if (genderFilterEl)genderFilterEl.value='all';qInput.value='';sortSelect.value='created_at_desc';applyFilter();});document.getElementById('btnNew').addEventListener('click',()=>{clearForm();fillOneMock();});document.getElementById('btnSave').addEventListener('click',upsert);document.getElementById('btnUpdate').addEventListener('click',updateMember);document.getElementById('btnDelete').addEventListener('click',remove);document.getElementById('btnReset').addEventListener('click',()=>{if (selectedId!=null)selectById(selectedId);else clearForm();});document.getElementById('btnClose').addEventListener('click',()=>{if (window.self!==window.top) {window.parent.postMessage('closeIframe','*');}else{window.close();}});document.getElementById('btnTheme').addEventListener('click',()=>{theme=theme==='dark' ? 'light' : 'dark';applyTheme();});document
 .getElementById('btnExport').addEventListener('click',exportJSON);document
 .getElementById('btnImport').addEventListener('click',()=>document.getElementById('jsonFile').click());document.getElementById('jsonFile').addEventListener('change',(e)=>{const f=e.target.files?.[0];if (f)importJSON(f);e.target.value='';});document.addEventListener('keydown',(e)=>{if ((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s') {e.preventDefault();upsert();}});const calendarTypeSelect=qs('#sMem_calendar_type');const leapMonthCtrl=qs('#leapMonthCtrl');if (calendarTypeSelect&&leapMonthCtrl) {function toggleLeapMonthCtrl() {const calendarType=calendarTypeSelect.value;if (calendarType==='ìŒë ¥'||calendarType==='ìœ¤ë‹¬') {leapMonthCtrl.style.display='grid';}else{leapMonthCtrl.style.display='none';const leapCheckbox=qs('#is_leap_month');if (leapCheckbox)leapCheckbox.checked=false;}}calendarTypeSelect.addEventListener('change',toggleLeapMonthCtrl);toggleLeapMonthCtrl();}const passwordInput=qs('#sMem_password');if (passwordInput) {passwordInput.addEventListener('input',async function () {const password=this.value;if (password&&password.length>0) {}else{const hashInput=qs('#sMem_pwdHash');const saltInput=qs('#sMem_pwd_salt');if (hashInput)hashInput.value='';if (saltInput)saltInput.value='';}});}(function initSignaturePad() {const pad=document.getElementById('signPad');const clearBtn=document.getElementById('signClear');const saveBtn=document.getElementById('signSave');const preview=document.getElementById('signPreviewBox');const status=document.getElementById('signStatus');const hidden=document.getElementById('signature_canvas_data');const penColor=document.getElementById('penColor');const penWidth=document.getElementById('penWidth');if (!pad||!clearBtn||!saveBtn||!preview||!hidden)return;function resizeCanvas() {const ratio=Math.max(window.devicePixelRatio||1,1);const cssW=pad.clientWidth||640;const cssH=pad.clientHeight||200;pad.width=Math.floor(cssW*ratio);pad.height=Math.floor(cssH*ratio);ctx.setTransform(1,0,0,1,0,0);ctx.scale(ratio,ratio);}const ctx=pad.getContext('2d');ctx.lineWidth=parseFloat(penWidth?.value||'2.5');ctx.lineCap='round';ctx.lineJoin='round';ctx.strokeStyle=penColor?.value||'#111';let drawing=false;let points=[];function posFromEvent(e) {const rect=pad.getBoundingClientRect();if (e.touches&&e.touches[0]) {return{x: e.touches[0].clientX-rect.left,y: e.touches[0].clientY-rect.top,};}return{x: e.clientX-rect.left,y: e.clientY-rect.top};}function drawLine(p1,p2) {ctx.beginPath();ctx.moveTo(p1.x,p1.y);ctx.lineTo(p2.x,p2.y);ctx.stroke();}function start(e) {drawing=true;points=[];points.push(posFromEvent(e));e.preventDefault();}function move(e) {if (!drawing)return;const p=posFromEvent(e);const q=points[points.length-1];drawLine(q,p);points.push(p);e.preventDefault();}function end(e) {drawing=false;e.preventDefault();}pad.addEventListener('mousedown',start);pad.addEventListener('mousemove',move);window.addEventListener('mouseup',end);pad.addEventListener('touchstart',start,{passive: false});pad.addEventListener('touchmove',move,{passive: false});pad.addEventListener('touchend',end,{passive: false});window.addEventListener('resize',resizeCanvas);resizeCanvas();function setStatus(msg) {if (status) {status.textContent=msg;}}function setPreview(dataUrl) {preview.innerHTML='';if (dataUrl) {const img=new Image();img.src=dataUrl;img.style.maxWidth='100%';img.style.maxHeight='200px';img.style.objectFit='contain';preview.appendChild(img);}else{preview.innerHTML='<span style="color:var(--muted)">ì„œëª… ë¯¸ë¦¬ë³´ê¸°</span>';}}clearBtn.addEventListener('click',()=>{ctx.clearRect(0,0,pad.width,pad.height);resizeCanvas();hidden.value='';setPreview('');setStatus('ì„œëª…ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');});saveBtn.addEventListener('click',()=>{try{const dataUrl=pad.toDataURL('image/png');if (!dataUrl||dataUrl.length<5000) {alert('ì„œëª…ì´ ë„ˆë¬´ ì§§ê±°ë‚˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì„œëª…í•´ ì£¼ì„¸ìš”.');return;}hidden.value=dataUrl;setPreview(dataUrl);setStatus('ì„œëª…ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');}catch(err) {console.error(err);setStatus('ì„œëª… ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');}});penColor?.addEventListener('input',(e)=>{ctx.strokeStyle=e.target.value;});penWidth?.addEventListener('input',(e)=>{ctx.lineWidth=parseFloat(e.target.value||'2.5');});})();}init();(function checkAdminLogin() {let attempts=0;const maxAttempts=10;function tryCheckAdmin() {attempts++;if (typeof window.getAdminSession==='function') {const adminSession=window.getAdminSession();if (!adminSession||!adminSession.isLoggedIn||!adminSession.admin_id) {console.warn('âš ï¸ ê´€ë¦¬ì ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');window.location.href='/secret/admin_login';return;}console.log('âœ… ê´€ë¦¬ì ì¸ì¦ ì™„ë£Œ:',adminSession.username);}else{if (attempts<maxAttempts) {setTimeout(tryCheckAdmin,100);}else{console.error('âŒ admin_session.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');console.error(' ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ìˆœì„œë¥¼ í™•ì¸í•˜ì„¸ìš”.');alert('ê´€ë¦¬ì ì„¸ì…˜ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');window.location.href='/secret/admin_login';}}}if (document.readyState==='loading') {document.addEventListener('DOMContentLoaded',tryCheckAdmin);}else{tryCheckAdmin();}})();