const store=(()=>{const now=()=>new Date().toISOString();let rows=[];const list=()=>rows.slice();const upsert=(row)=>{const i=rows.findIndex((r)=>r.admin_id===row.admin_id);if(i>=0)rows[i]=row;else rows.unshift(row);};const remove=(id)=>{rows=rows.filter((r)=>r.admin_id!==id);};const existsId=(id)=>rows.some((r)=>r.admin_id===id);const existsUsername=(u,exceptId=null)=>rows.some((r)=>r.username===u&&r.admin_id!==exceptId);const importAll=(arr)=>{rows=Array.isArray(arr)?arr:rows;};return{list,upsert,remove,existsId,existsUsername,importAll,now,};})();const state={sortKey:'created_at',sortDir:'desc',page:1,pageSize:20,roleFilter:'',q:'',selectedId:null,};const el=(id)=>document.getElementById(id);function applyFilters(rows){let out=rows;if(state.roleFilter)
out=out.filter((r)=>r.role===state.roleFilter);if(state.q){const q=state.q.toLowerCase();out=out.filter((r)=>(r.admin_id||'').toLowerCase().includes(q)||(r.username||'').toLowerCase().includes(q)||(r.role||'').toLowerCase().includes(q));}
out.sort((a,b)=>{const k=state.sortKey;const av=a[k]??'';const bv=b[k]??'';if(av===bv)return 0;if(state.sortDir==='asc')return av>bv?1:-1;return av<bv?1:-1;});return out;}
function renderGrid(){const rows=applyFilters(store.list());const tbody=document.querySelector('#grid tbody');tbody.innerHTML='';const total=rows.length;const start=(state.page-1)*state.pageSize;const pageRows=rows.slice(start,start+state.pageSize);for(const r of pageRows){const tr=document.createElement('tr');if(state.selectedId===r.admin_id)tr.classList.add('selected');const statusClass=r.admin_status==='OPEN'?'badge':r.admin_status==='LOCKED'?'badge warn':'badge danger';tr.innerHTML=`<td><code>${r.admin_id}</code></td><td>${escapeHtml(r.username)}</td><td><span class="badge">${r.role}</span></td><td><span class="${statusClass}">${r.admin_status||'OPEN'}</span></td><td class="muted">${formatLocal(r.created_at)}</td>`;tr.addEventListener('click',()=>selectRow(r.admin_id));tbody.appendChild(tr);}
el('countBadge').textContent=`${total}건`;const pages=Math.max(1,Math.ceil(total/state.pageSize));el('pageInfo').textContent=`${state.page}/${pages}`;el('prev').disabled=state.page<=1;el('next').disabled=state.page>=pages;}
function selectRow(id){state.selectedId=id;const row=store.list().find((r)=>r.admin_id===id);if(!row)return;el('f_admin_id').value=row.admin_id||'';el('f_username').value=row.username||'';el('f_pwd_hash').value=row.pwd_hash||'';el('f_role').value=row.role||'ADMIN';el('f_admin_status').value=row.admin_status||'OPEN';el('f_created_at').value=toLocalInput(row.created_at);renderGrid();}
function clearForm(){state.selectedId=null;el('f_admin_id').value='';el('f_username').value='';el('f_pwd_hash').value='';el('f_role').value='ADMIN';el('f_admin_status').value='OPEN';el('f_created_at').value=toLocalInput(new Date().toISOString());el('plain_pw').value='';renderGrid();}
function save(){const admin_id=el('f_admin_id').value.trim();const username=el('f_username').value.trim();const pwd_hash=el('f_pwd_hash').value.trim();const role=el('f_role').value;const admin_status=el('f_admin_status').value;const created_at_local=el('f_created_at').value;if(!admin_id)return alert('admin_id는 필수입니다.');if(!username)return alert('username은 필수입니다.');if(!pwd_hash||(!pwd_hash.startsWith('$2a$')&&!pwd_hash.startsWith('$2b$')&&!pwd_hash.startsWith('$2y$'))){return alert('pwd_hash가 비어 있거나 bcrypt 형식이 아닙니다. "해시 생성(bcrypt)" 버튼으로 생성하세요.');}
const isNew=!store.list().some((r)=>r.admin_id===admin_id);if(isNew&&store.existsId(admin_id))
return alert('중복 admin_id 입니다.');const created_at=fromLocalInput(created_at_local)||new Date().toISOString();const data={admin_id,username,pwd_hash,role,admin_status,created_at,};const url=isNew?'/secret/api/v1/admin/users':`/secret/api/v1/admin/users/${encodeURIComponent(admin_id)}`;const method=isNew?'POST':'PUT';fetch(url,{method:method,headers:{'Content-Type':'application/json'},body:JSON.stringify(data),}).then((res)=>{if(!res.ok){return res.json().then((err)=>{throw new Error(err.error||'저장에 실패했습니다.');});}
return res.json();}).then((result)=>{state.selectedId=admin_id;alert('저장되었습니다.');loadDataFromAPI();}).catch((err)=>{console.error('저장 오류:',err);alert('저장 중 오류가 발생했습니다: '+err.message);});}
function del(){const id=el('f_admin_id').value.trim();if(!id)return alert('삭제할 admin_id가 없습니다.');if(!confirm(`정말 삭제하시겠습니까?(${id})`))return;fetch(`/secret/api/v1/admin/users/${encodeURIComponent(id)}`,{method:'DELETE',headers:{'Content-Type':'application/json'},}).then((res)=>{if(!res.ok){return res.json().then((err)=>{throw new Error(err.error||'삭제에 실패했습니다.');});}
return res.json();}).then((result)=>{clearForm();alert('삭제되었습니다.');loadDataFromAPI();}).catch((err)=>{console.error('삭제 오류:',err);alert('삭제 중 오류가 발생했습니다: '+err.message);});}
function loadDataFromAPI(){fetch('/secret/api/v1/admin/users',{method:'GET',headers:{'Content-Type':'application/json'},}).then((res)=>{if(!res.ok){throw new Error('데이터 로드에 실패했습니다.');}
return res.json();}).then((result)=>{if(result.ok&&result.users){store.importAll(result.users);renderGrid();console.log(`✅ DB에서 ${result.users.length}개 계정 로드 완료`);}}).catch((err)=>{console.error('데이터 로드 오류:',err);alert('데이터 로드 중 오류가 발생했습니다: '+err.message);});}
function bind(){el('roleFilter').addEventListener('change',(e)=>{state.roleFilter=e.target.value;state.page=1;renderGrid();});el('btnSearch').addEventListener('click',()=>{state.q=el('q').value.trim();state.page=1;renderGrid();});el('btnReset').addEventListener('click',()=>{el('q').value='';el('roleFilter').value='';state.q='';state.roleFilter='';state.page=1;renderGrid();});document.querySelectorAll('th.sortable').forEach((th)=>{th.addEventListener('click',()=>{const k=th.dataset.key;if(state.sortKey===k){state.sortDir=state.sortDir==='asc'?'desc':'asc';}else{state.sortKey=k;state.sortDir='asc';}
renderGrid();});});el('prev').addEventListener('click',()=>{if(state.page>1){state.page--;renderGrid();}});el('next').addEventListener('click',()=>{state.page++;renderGrid();});el('pageSize').addEventListener('change',(e)=>{state.pageSize=parseInt(e.target.value,10)||20;state.page=1;renderGrid();});el('btnNew').addEventListener('click',()=>{clearForm();el('f_admin_id').focus();});el('btnClear').addEventListener('click',clearForm);el('btnSave').addEventListener('click',save);el('btnDelete').addEventListener('click',del);el('themeLight').addEventListener('click',()=>setTheme('light'));el('themeDark').addEventListener('click',()=>setTheme('dark'));el('themeSepia').addEventListener('click',()=>setTheme('sepia'));el('btnHash').addEventListener('click',()=>{const pw=el('plain_pw').value;if(!pw)return alert('비밀번호를 입력하세요.');if(typeof dcodeIO==='undefined'||typeof dcodeIO.bcrypt==='undefined'){alert('bcrypt 라이브러리가 로드되지 않았습니다. 페이지를 새로고침해주세요.');return;}
try{const salt=dcodeIO.bcrypt.hashSync(pw,12);el('f_pwd_hash').value=salt;alert('bcrypt 해시가 생성되었습니다.');}catch(error){console.error('해시 생성 오류:',error);alert('해시 생성 중 오류가 발생했습니다: '+error.message);}});el('btnClose').addEventListener('click',()=>{if(window.history.length>1){window.history.back();}else{window.location.href='/secret/admin_list';}});el('importJson').addEventListener('change',async(e)=>{const file=e.target.files[0];if(!file)return;const text=await file.text();try{const arr=JSON.parse(text);if(!Array.isArray(arr))throw new Error('배열이 아님');store.importAll(arr);state.page=1;renderGrid();clearForm();alert('불러오기 완료');}catch(err){alert('JSON 형식이 올바르지 않습니다.');}finally{e.target.value='';}});}
function setTheme(name){document.body.setAttribute('data-theme',name);localStorage.setItem('admin_users_theme',name);}
function initTheme(){const t=localStorage.getItem('admin_users_theme')||'light';setTheme(t);}
const escapeHtml=(s)=>String(s??'').replace(/[&<>"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;',}[m]));function formatLocal(iso){try{const d=new Date(iso);return d.toLocaleString();}catch{return iso;}}
function toLocalInput(iso){try{const d=new Date(iso);const tzOffset=d.getTimezoneOffset();const local=new Date(d.getTime()-tzOffset*60000);return local.toISOString().slice(0,16);}catch{return'';}}
function fromLocalInput(localStr){if(!localStr)return null;try{const d=new Date(localStr);const tzOffset=d.getTimezoneOffset();const utc=new Date(d.getTime()+tzOffset*60000);return utc.toISOString();}catch{return null;}}
initTheme();bind();loadDataFromAPI();clearForm();(function checkAdminLogin(){let attempts=0;const maxAttempts=30;function tryCheckAdminLogin(){attempts++;if(typeof window.getAdminSession==='function'){const adminSession=window.getAdminSession();if(!adminSession||!adminSession.isLoggedIn||!adminSession.admin_id){console.log('❌ 관리자 세션이 없습니다.');alert('관리자 로그인이 필요합니다.');window.location.href='/secret/admin_login';return;}
console.log('✅ 관리자 인증 완료:',adminSession.username);}else{if(attempts<maxAttempts){setTimeout(tryCheckAdminLogin,100);}else{console.error('❌ admin_session.js가 로드되지 않았습니다. (최대 대기 시간 초과)');alert('관리자 세션 관리 스크립트를 로드할 수 없습니다.');window.location.href='/secret/admin_login';}}}
tryCheckAdminLogin();})();