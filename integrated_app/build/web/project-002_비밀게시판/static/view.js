document.addEventListener('DOMContentLoaded',function(){console.log('ğŸš€ View page loaded - DOMContentLoaded');const urlParams=new URLSearchParams(window.location.search);const ticketId=urlParams.get('id');console.log('ğŸ” í˜„ì¬ URL:',window.location.href);console.log('ğŸ” URL params:',window.location.search);console.log('ğŸ« Ticket ID from URL:',ticketId);console.log('ğŸ« Ticket ID type:',typeof ticketId);if(!ticketId||ticketId==='null'||ticketId==='undefined'){console.error('âŒ í‹°ì¼“ IDê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ:',ticketId);alert('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ì ‘ê·¼ì…ë‹ˆë‹¤. í‹°ì¼“ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.');window.location.href='/secret/';return;}
console.log('âœ… í‹°ì¼“ ID í™•ì¸ë¨:',ticketId);console.log('ğŸ“ loadContent í˜¸ì¶œ ì‹œì‘');loadContent(ticketId);});async function loadContent(ticketId){console.log('ğŸš€ loadContent í•¨ìˆ˜ ì‹œì‘. Ticket ID:',ticketId);const loadingElement=document.getElementById('loading');const contentElement=document.getElementById('ticket-content');const errorElement=document.getElementById('error');console.log('ğŸ“ DOM ìš”ì†Œ í™•ì¸:',{loading:loadingElement?'ì°¾ìŒ':'ì—†ìŒ',content:contentElement?'ì°¾ìŒ':'ì—†ìŒ',error:errorElement?'ì°¾ìŒ':'ì—†ìŒ',});try{console.log('ğŸ”„ try ë¸”ë¡ ì‹œì‘');if(loadingElement){loadingElement.style.display='block';console.log('âœ… ë¡œë”© í™”ë©´ í‘œì‹œë¨');}
if(contentElement){contentElement.style.display='none';console.log('âœ… ì»¨í…ì¸  ìˆ¨ê¹€');}
if(errorElement){errorElement.style.display='none';console.log('âœ… ì—ëŸ¬ ìˆ¨ê¹€');}
const apiUrl=`/secret/api/v1/tickets/${ticketId}`;console.log('ğŸ“¡ API URL ìƒì„±:',apiUrl);console.log('ğŸŒ fetch ì‹œì‘...');const response=await fetch(apiUrl,{method:'GET',headers:{'Content-Type':'application/json',},credentials:'same-origin',});console.log('ğŸ“¨ fetch ì™„ë£Œ! ì‘ë‹µ ìƒíƒœ:',response.status);console.log('ğŸ“¨ ì‘ë‹µ í—¤ë”ë“¤:',[...response.headers.entries()]);if(!response.ok){const errorText=await response.text();console.error('âŒ API ì—ëŸ¬ ì‘ë‹µ:',response.status,errorText);if(response.status===401){console.log('ğŸ” 401 ì˜¤ë¥˜ - ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ í•„ìš”');if(loadingElement){loadingElement.style.display='none';}
showPasswordModal(ticketId);return;}
throw new Error(`HTTP ${response.status}:${errorText}`);}
console.log('ğŸ“¦ JSON íŒŒì‹± ì‹œì‘...');const data=await response.json();console.log('ğŸ“¦ JSON íŒŒì‹± ì™„ë£Œ:',JSON.stringify(data,null,2));if(data.ticket){console.log('âœ… í‹°ì¼“ ë°ì´í„° ë°œê²¬, displayContent í˜¸ì¶œ');console.log('ğŸ“¨ ë©”ì‹œì§€ ë°ì´í„°:',data.messages?`${data.messages.length}ê°œ`:'ì—†ìŒ');displayContent(data.ticket,data.messages||[]);}else{console.error('âŒ data.ticketì´ ì—†ìŒ. ì‘ë‹µ êµ¬ì¡°:',Object.keys(data));throw new Error('í‹°ì¼“ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');}}catch(error){console.error('ğŸ’¥ Error in loadContent:',error);console.error('ğŸ’¥ Error stack:',error.stack);if(!error.message.includes('401')){showError('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: '+error.message);}}finally{console.log('ğŸ finally ë¸”ë¡ ì‹¤í–‰');if(loadingElement){loadingElement.style.display='none';console.log('âœ… ë¡œë”© í™”ë©´ ìˆ¨ê¹€ ì™„ë£Œ');}}}
function displayContent(ticket,messages=[]){console.log('ğŸ¨ displayContent í•¨ìˆ˜ ì‹œì‘',JSON.stringify(ticket,null,2));console.log('ğŸ“¨ ë©”ì‹œì§€ ê°œìˆ˜:',messages.length);const contentElement=document.getElementById('ticket-content');if(!contentElement){console.error('âŒ Content element not found');return;}
try{console.log('ğŸ« Received ticket data:',ticket);console.log('ğŸ“ author_contact value:',ticket.author_contact);const titleElement=document.getElementById('ticket-title');const authorElement=document.getElementById('ticket-author');const contactElement=document.getElementById('ticket-contact');const contentTextElement=document.getElementById('ticket-body');const createdAtElement=document.getElementById('ticket-date');console.log('ğŸ“ ê°œë³„ ìš”ì†Œ í™•ì¸:',{title:titleElement?'ì°¾ìŒ':'ì—†ìŒ',author:authorElement?'ì°¾ìŒ':'ì—†ìŒ',contact:contactElement?'ì°¾ìŒ':'ì—†ìŒ',content:contentTextElement?'ì°¾ìŒ':'ì—†ìŒ',createdAt:createdAtElement?'ì°¾ìŒ':'ì—†ìŒ',});if(titleElement){titleElement.textContent=ticket.title||'ì œëª© ì—†ìŒ';console.log('âœ… ì œëª© ì„¤ì •:',ticket.title);}
if(authorElement){authorElement.textContent=ticket.author_name||'ì‘ì„±ì ì—†ìŒ';console.log('âœ… ì‘ì„±ì ì„¤ì •:',ticket.author_name);}
if(contactElement){contactElement.textContent=ticket.author_contact||'ì—°ë½ì²˜ ì—†ìŒ';console.log('âœ… ì—°ë½ì²˜ ì„¤ì •:',ticket.author_contact);console.log('ğŸ“ Contact element:',contactElement);console.log('ğŸ“ Contact element content:',contactElement.textContent);}else{console.log('âŒ Contact element not found!');}
if(contentTextElement){contentTextElement.textContent=ticket.content||'ë‚´ìš© ì—†ìŒ';console.log('âœ… ë‚´ìš© ì„¤ì •:',ticket.content);}
if(createdAtElement){const formattedDate=formatDate(ticket.created_at);createdAtElement.textContent=formattedDate;console.log('âœ… ì‘ì„±ì¼ ì„¤ì •:',formattedDate);}
displayMessages(messages,ticket);contentElement.style.display='block';console.log('âœ… ì»¨í…ì¸  ì˜ì—­ í‘œì‹œ');console.log('ğŸ‰ ì»¨í…ì¸  í‘œì‹œ ì™„ë£Œ');}catch(error){console.error('ğŸ’¥ Error displaying content:',error);showError('ì»¨í…ì¸ ë¥¼ í‘œì‹œí•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: '+error.message);}}
function displayMessages(messages,ticket){console.log('ğŸ“¨ displayMessages í•¨ìˆ˜ ì‹œì‘',messages.length,'ê°œ ë©”ì‹œì§€');const messagesListElement=document.getElementById('messages-list');const editDisabledMessage=document.getElementById('edit-disabled-message');const editButton=document.getElementById('edit-button');if(!messagesListElement){console.error('âŒ messages-list ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');return;}
const adminMessages=messages.filter(msg=>{const role=(msg.role||'').toUpperCase();return role!=='USER'&&role!=='XUSER';});console.log('ğŸ‘¤ ê´€ë¦¬ì ë‹µë³€ ê°œìˆ˜:',adminMessages.length);if(adminMessages.length>0){if(editDisabledMessage){editDisabledMessage.style.display='block';}
if(editButton){editButton.style.display='none';}}else{if(editDisabledMessage){editDisabledMessage.style.display='none';}
if(editButton){editButton.style.display='inline-flex';}}
messagesListElement.innerHTML='';if(adminMessages.length===0){messagesListElement.innerHTML='<div class="no-messages">ì•„ì§ ê´€ë¦¬ì ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';console.log('ğŸ“­ ê´€ë¦¬ì ë‹µë³€ ì—†ìŒ');return;}
adminMessages.forEach((message,index)=>{const messageDiv=document.createElement('div');messageDiv.className='admin-message';const role=message.role||'ê´€ë¦¬ì';const content=message.content||message.body||message.content_enc||'';const adminId=message.admin_id||'';const createdAt=message.created_at||'';console.log(`ğŸ“¨ ë©”ì‹œì§€ ${index+1}ë°ì´í„°:`,{role,adminId,created_at:message.created_at,allKeys:Object.keys(message),rawMessage:message});const formattedDate=createdAt?formatDate(createdAt):'';messageDiv.innerHTML=`<div class="admin-message-header"><span>ğŸ‘¤ ${escapeHtml(role)}</span>${adminId?`<span style="opacity: 0.8; margin-left: 10px;">(${escapeHtml(adminId)})</span>`:''}</div><div class="admin-message-content">${escapeHtml(content).replace(/\n/g,'<br>')}</div>${formattedDate?`<div class="admin-message-date">ğŸ“… ${formattedDate}</div>`:''}`;messagesListElement.appendChild(messageDiv);console.log(`âœ… ê´€ë¦¬ì ë‹µë³€ ${index+1}í‘œì‹œë¨:`,{role,adminId,createdAt:createdAt,formattedDate:formattedDate,content:content.substring(0,50)});});console.log('âœ… ê´€ë¦¬ì ë‹µë³€ í‘œì‹œ ì™„ë£Œ');}
function escapeHtml(text){if(!text)return'';const div=document.createElement('div');div.textContent=text;return div.innerHTML;}
function showError(message){console.error('Error:',message);const errorElement=document.getElementById('error');const errorMessageElement=document.getElementById('error-message');const contentElement=document.getElementById('ticket-content');const loadingElement=document.getElementById('loading');if(errorElement){errorElement.style.display='block';}
if(errorMessageElement){errorMessageElement.textContent=message;}
if(contentElement){contentElement.style.display='none';}
if(loadingElement){loadingElement.style.display='none';}}
function formatDate(dateString){if(!dateString){console.warn('âš ï¸ ë‚ ì§œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');return'';}
try{const date=new Date(dateString);if(isNaN(date.getTime())){console.warn('âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ:',dateString);return dateString;}
const formatted=date.toLocaleString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true,timeZone:'Asia/Seoul',});console.log(`ğŸ“… ë‚ ì§œ í¬ë§·íŒ…:${dateString}â†’ ${formatted}`);console.log(`-ì›ë³¸ Date ê°ì²´:${date}`);console.log(`-UTC ì‹œê°„:${date.toUTCString()}`);console.log(`-ë¡œì»¬ ì‹œê°„:${date.toLocaleString()}`);return formatted;}catch(error){console.error('âŒ ë‚ ì§œ í¬ë§· ì˜¤ë¥˜:',error,'ì›ë³¸:',dateString);return dateString||'ë‚ ì§œ ì˜¤ë¥˜';}}
function goBack(){window.history.back();}
function goToList(){window.location.href='/secret/';}
function editTicket(){const urlParams=new URLSearchParams(window.location.search);const ticketId=urlParams.get('id');if(ticketId){window.location.href=`/secret/edit?id=${ticketId}`;}else{console.error('âŒ í‹°ì¼“ IDê°€ ì—†ìŠµë‹ˆë‹¤.');}}
let currentTicketIdForAuth=null;function showPasswordModal(ticketId){console.log('ğŸ” ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ í‘œì‹œ:',ticketId);currentTicketIdForAuth=ticketId;const modal=document.getElementById('passwordModal');const passwordInput=document.getElementById('modalPassword');const errorMessage=document.getElementById('modalErrorMessage');if(modal){modal.style.display='block';if(passwordInput){passwordInput.value='';passwordInput.focus();}
if(errorMessage){errorMessage.style.display='none';errorMessage.textContent='';}}}
function closePasswordModal(){console.log('ğŸ” ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ ë‹«ê¸°');const modal=document.getElementById('passwordModal');if(modal){modal.style.display='none';}
currentTicketIdForAuth=null;}
function confirmPassword(){const password=document.getElementById('modalPassword').value;const errorMessage=document.getElementById('modalErrorMessage');console.log('ğŸ” confirmPassword í˜¸ì¶œë¨');console.log('ğŸ« currentTicketIdForAuth:',currentTicketIdForAuth);console.log('ğŸ”‘ password length:',password.length);if(errorMessage){errorMessage.style.display='none';errorMessage.textContent='';}
if(!password.trim()){if(errorMessage){errorMessage.textContent='ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';errorMessage.style.display='block';}
return;}
if(!currentTicketIdForAuth){console.error('âŒ currentTicketIdForAuthê°€ ì—†ìŒ!');if(errorMessage){errorMessage.textContent='í‹°ì¼“ IDê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';errorMessage.style.display='block';}
return;}
const ticketIdToVerify=currentTicketIdForAuth;console.log('ğŸ”„ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ API í˜¸ì¶œ:',ticketIdToVerify);fetch(`/secret/api/v1/tickets/${ticketIdToVerify}/verify`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({post_password:password}),credentials:'same-origin',}).then((res)=>res.json()).then((result)=>{if(result.ok){console.log('âœ… ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ ì„±ê³µ!');closePasswordModal();loadContent(ticketIdToVerify);}else{if(errorMessage){errorMessage.textContent='ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.';errorMessage.style.display='block';}
const passwordInput=document.getElementById('modalPassword');if(passwordInput){passwordInput.value='';passwordInput.focus();}}}).catch((error)=>{console.error('âŒ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì˜¤ë¥˜:',error);if(errorMessage){errorMessage.textContent='ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';errorMessage.style.display='block';}});}
document.addEventListener('click',(event)=>{const modal=document.getElementById('passwordModal');if(modal&&event.target===modal){closePasswordModal();}});