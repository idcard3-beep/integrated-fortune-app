function getApiBase(){const currentPath=window.location.pathname;const protocol=window.location.protocol;const host=window.location.host;console.log(`üåê API_BASE ÏÑ§Ï†ï - protocol: ${protocol}, host: ${host}, path: ${currentPath}`,);const apiUrl=`${protocol}//${host}/tarot/api/v1/tarot_tickets`;console.log(`‚úÖ API_BASE: ${apiUrl}`);return apiUrl;}
const API_BASE=getApiBase();window['getApiBase']=getApiBase;function goBack(){console.log('‚¨ÖÔ∏è Ïù¥Ï†Ñ Î≤ÑÌäº ÌÅ¥Î¶≠ - tarot_exec.htmlÎ°ú Ïù¥Îèô');const tarotUrl='/tarot/';console.log('üîÑ Ïù¥ÎèôÌï† URL:',tarotUrl);const hasTarotData=sessionStorage.getItem('tarotFormData');if(hasTarotData){console.log('üíæ tarotFormData Ïú†ÏßÄ - ÌôîÎ©¥ Î≥µÏõêÎê®');}else{console.log('‚ÑπÔ∏è tarotFormData ÏóÜÏùå - Ï¥àÍ∏∞ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô');}
window.location.href=tarotUrl;}
window['goBack']=goBack;function openIntarot(){if(!selected){alert('‚ö†Ô∏è ÌÉÄÎ°úÎ≥¥Í∏∞Î•º Ìï† Îç∞Ïù¥ÌÑ∞Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.\n\nÍ∑∏Î¶¨ÎìúÏóêÏÑú ÏõêÌïòÎäî ÌñâÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.',);return;}
console.log('üîÆ ÏÑ†ÌÉùÎêú Îç∞Ïù¥ÌÑ∞Î°ú ÌÉÄÎ°úÎ≥¥Í∏∞ Ïã§Ìñâ:',selected);const ticketId=selected.ticket_id||selected.id;if(!ticketId){alert('‚ùå ticket_idÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.\nÎç∞Ïù¥ÌÑ∞Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');console.error('‚ùå ticket_id ÏóÜÏùå:',selected);return;}
console.log('üìã ticket_id:',ticketId);console.log('üìã ÏÑ†ÌÉùÎêú Îç∞Ïù¥ÌÑ∞:',selected);const tarotExecUrl=`/tarot/?ticket_id=${ticketId}`;console.log('üîÑ Ïù¥ÎèôÌï† URL:',tarotExecUrl);window.location.href=tarotExecUrl;}
window['openIntarot']=openIntarot;function openInSaju(){if(!selected){alert('‚ö†Ô∏è Ïú°Ìö®Î≥¥Í∏∞Î•º Ìï† Îç∞Ïù¥ÌÑ∞Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.\n\nÍ∑∏Î¶¨ÎìúÏóêÏÑú ÏõêÌïòÎäî ÌñâÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.',);return;}
console.log('üîÆ ÏÑ†ÌÉùÎêú Îç∞Ïù¥ÌÑ∞Î°ú Ïú°Ìö®Î≥¥Í∏∞ Ïã§Ìñâ:',selected);const ticketId=selected.ticket_id||selected.id;if(!ticketId){alert('‚ùå ticket_idÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.\nÎç∞Ïù¥ÌÑ∞Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');console.error('‚ùå ticket_id ÏóÜÏùå:',selected);return;}
console.log('üìã ticket_id:',ticketId);console.log('üìã ÏÑ†ÌÉùÎêú Îç∞Ïù¥ÌÑ∞:',{ticket_id:ticketId,author_name:selected.author_name,birth_datetime:selected.birth_datetime,});const sajuUrl=`/saju/?ticket_id=${ticketId}`;console.log('üîÑ Ïù¥ÎèôÌï† URL:',sajuUrl);window.location.href=sajuUrl;}
window['openInSaju']=openInSaju;function openIny6(){if(!selected){alert('‚ö†Ô∏è Ïú°Ìö®Î≥¥Í∏∞Î•º Ìï† Îç∞Ïù¥ÌÑ∞Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.\n\nÍ∑∏Î¶¨ÎìúÏóêÏÑú ÏõêÌïòÎäî ÌñâÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.',);return;}
console.log('üîÆ ÏÑ†ÌÉùÎêú Îç∞Ïù¥ÌÑ∞Î°ú Ïú°Ìö®Î≥¥Í∏∞ Ïã§Ìñâ:',selected);const ticketId=selected.ticket_id||selected.id;if(!ticketId){alert('‚ùå ticket_idÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.\nÎç∞Ïù¥ÌÑ∞Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');console.error('‚ùå ticket_id ÏóÜÏùå:',selected);return;}
console.log('üìã ticket_id:',ticketId);console.log('üìã ÏÑ†ÌÉùÎêú Îç∞Ïù¥ÌÑ∞:',selected);const y6ExecUrl=`/y6/?ticket_id=${ticketId}`;console.log('üîÑ Ïù¥ÎèôÌï† URL:',y6ExecUrl);window.location.href=y6ExecUrl;}
window['openIny6']=openIny6;window['openInY6']=openIny6;function getSnsgFilter(){const urlParams=new URLSearchParams(window.location.search);return urlParams.get('snsgu');}
const SNSGU_FILTER=getSnsgFilter();window['getSnsgFilter']=getSnsgFilter;function getSmemberIdFilter(){const urlParams=new URLSearchParams(window.location.search);const urlMemberId=urlParams.get('smember_id');if(urlMemberId){console.log('üìå URLÏóêÏÑú smember_id:',urlMemberId);return urlMemberId;}
let memberId=null;if(window.MEMBER_SESSION&&window.MEMBER_SESSION.smem_id){memberId=window.MEMBER_SESSION.smem_id;console.log('üìå MEMBER_SESSIONÏóêÏÑú smember_id:',memberId);return memberId;}
if(typeof window.smem_id!=='undefined'&&window.smem_id){memberId=window.smem_id;console.log('üìå window.smem_idÏóêÏÑú smember_id:',memberId);return memberId;}
if(typeof smem_id!=='undefined'&&smem_id){memberId=smem_id;console.log('üìå Ï†ÑÏó≠ smem_idÏóêÏÑú smember_id:',memberId);return memberId;}
console.log('‚ö†Ô∏è smember_idÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');return null;}
const smember_id_FILTER=getSmemberIdFilter();window['getSmemberIdFilter']=getSmemberIdFilter;console.log('üîç ÏµúÏ¢Ö smember_id_FILTER:',smember_id_FILTER);let selected=null;let allData=[];let sortColumn=null;let sortDirection='asc';function showMessage(msg,isError=true){const msgEl=document.getElementById('message');msgEl.textContent=msg;msgEl.className=isError?'error':'success';setTimeout(()=>{msgEl.textContent='';},5000);}
window['showMessage']=showMessage;function sortData(column){if(sortColumn===column){sortDirection=sortDirection==='asc'?'desc':'asc';}else{sortColumn=column;sortDirection='asc';}
allData.sort((a,b)=>{let aVal=a[column];let bVal=b[column];if(aVal===null||aVal===undefined)aVal='';if(bVal===null||bVal===undefined)bVal='';if(column==='created_at'||column==='birth_datetime'){aVal=aVal?new Date(aVal).getTime():0;bVal=bVal?new Date(bVal).getTime():0;}
else if(column==='birth_hour'||column==='birth_minute'){aVal=aVal===''||aVal===null?-1:parseInt(aVal);bVal=bVal===''||bVal===null?-1:parseInt(bVal);}
else{if(typeof aVal==='string'){aVal=aVal.toLowerCase();}
if(typeof bVal==='string'){bVal=bVal.toLowerCase();}}
if(sortDirection==='asc'){return aVal>bVal?1:aVal<bVal?-1:0;}else{return aVal<bVal?1:aVal>bVal?-1:0;}});document.querySelectorAll('th').forEach((th)=>{th.classList.remove('sort-asc','sort-desc');if(th.dataset.sort===column){th.classList.add(sortDirection==='asc'?'sort-asc':'sort-desc');}});window['renderTable']();}
window['sortData']=sortData;function renderTable(){const tb=document.querySelector('#grid tbody');tb.innerHTML='';if(!allData||allData.length===0){tb.innerHTML='<tr><td colspan="8" style="text-align:center;">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>';return;}
allData.forEach((r)=>{const tr=document.createElement('tr');const ticketId=r.ticket_id||r.id;const title=r.title_masked||r.title||'';const authorName=r.author_name||'';const authorContact=r.author_contact||'';const gwdateTime=r.gwdate_time||'';const upperHand=r.upper_hand||'';const lowerHand=r.lower_hand||'';const createdAt=r.created_at?new Date(r.created_at).toLocaleString('ko-KR'):'';tr.innerHTML=`
            <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;" title="${title}">${title}</td>
            <td title="${authorName}">${authorName}</td>
            <td>${authorContact}</td>
            <td>${gwdateTime}</td>
            <td>${upperHand}</td>
            <td>${lowerHand}</td>
            <td>${createdAt}</td>
            <td>
                <button onclick="window['openInY6']()" style="padding:2px 8px;font-size:11px;background:#007bff;color:white;border:none;border-radius:3px;cursor:pointer;">Ïú°Ìö®Î≥¥Í∏∞</button>
            </td>
        `;tr.onclick=()=>window['select'](tr,r);tb.appendChild(tr);});}
window['renderTable']=renderTable;async function load(){try{window['showMessage']('Ï°∞Ìöå Ï§ë...',false);let url=API_BASE;const params=new URLSearchParams();if(SNSGU_FILTER){params.append('snsgu',SNSGU_FILTER);console.log(`üîç snsgu ÌïÑÌÑ∞ Ï†ÅÏö©: ${SNSGU_FILTER}`);}
if(smember_id_FILTER){params.append('smember_id',smember_id_FILTER);console.log(`üîç smember_id ÌïÑÌÑ∞ Ï†ÅÏö©: ${smember_id_FILTER}`);}
if(params.toString()){url+=`/?${params.toString()}`;}
console.log(`üåê fetch Ìò∏Ï∂ú URL: ${url}`);console.log(`üåê ÌòÑÏû¨ ÌéòÏù¥ÏßÄ ÌîÑÎ°úÌÜ†ÏΩú: ${window.location.protocol}`);const res=await fetch(url);if(!res.ok){throw new Error(`Ï°∞Ìöå Ïã§Ìå®: ${res.status}`);}
const data=await res.json();allData=data||[];sortColumn=null;sortDirection='asc';document.querySelectorAll('th').forEach((th)=>{th.classList.remove('sort-asc','sort-desc');});window['renderTable']();let filterMsg='';if(SNSGU_FILTER||smember_id_FILTER){const filters=[];if(SNSGU_FILTER)filters.push(`snsgu=${SNSGU_FILTER}`);if(smember_id_FILTER)filters.push(`smember_id=${smember_id_FILTER}`);filterMsg=` (${filters.join(', ')})`;}
window['showMessage'](`Ï°∞Ìöå ÏôÑÎ£å (${allData.length}Í±¥${filterMsg})`,false);}catch(err){console.error('Ï°∞Ìöå Ïò§Î•ò:',err);window['showMessage'](`Ï°∞Ìöå Ïò§Î•ò: ${err.message}`,true);}}
window['load']=load;function select(tr,row){document.querySelectorAll('#grid tr').forEach((r)=>r.classList.remove('selected'));tr.classList.add('selected');selected=row;console.log('üìã ÏÑ†ÌÉùÎêú row Îç∞Ïù¥ÌÑ∞:',row);console.log('üîç gwdate_time:',row.gwdate_time);console.log('üîç upper_hand:',row.upper_hand);console.log('üîç lower_hand:',row.lower_hand);const setValue=(id,value)=>{const element=document.getElementById(id);if(element){console.log(`  ‚úèÔ∏è setValue('${id}', '${value}')`);if(value!==null&&value!==undefined){element.value=value;}else{element.value='';}}else{console.error(`  ‚ùå element not found: ${id}`);}};const setNumberValue=(id,value)=>{const element=document.getElementById(id);if(element){console.log(`  üî¢ setNumberValue('${id}', ${value})`);if(value!==null&&value!==undefined&&value!==''){element.value=value;}else{element.value='';}}else{console.error(`  ‚ùå element not found: ${id}`);}};const ticketId=row.ticket_id||row.id;setValue('ticket_id',ticketId||'');setValue('title_masked',row.title_masked||row.title||'');setValue('content_enc',row.content_enc||row.content||'');setValue('author_name',row.author_name||'');setValue('author_nickname',row.author_nickname||'');setValue('author_contact',row.author_contact||'');setValue('time_input_type',row.time_input_type||'time');setValue('hour_ji',row.hour_ji||'');setValue('calendar_type',row.calendar_type||'ÏñëÎ†•');setValue('yundal',row.yundal===true||row.yundal==='true'?'true':'false',);console.log('üïê ÌÉÄÎ°ú ÎÇ†Ïßú/ÏãúÍ∞Å Ï≤òÎ¶¨ ÏãúÏûë - gwdate_time:',row.gwdate_time);setValue('gwdate_time',row.gwdate_time||'');console.log('  ‚úÖ gwdate_time ÏÑ§Ï†ï ÏôÑÎ£å:',row.gwdate_time);console.log('üé≤ ÏÑ†ÌÉùÏπ¥ÎìúÏàò /ÏßÑÌñâ Ï≤òÎ¶¨ ÏãúÏûë');console.log('  upper_hand:',row.upper_hand,'type:',typeof row.upper_hand);console.log('  lower_hand:',row.lower_hand,'type:',typeof row.lower_hand);setValue('upper_hand',row.upper_hand||'');setValue('lower_hand',row.lower_hand||'');console.log('  ‚úÖ upper_hand/lower_hand ÏÑ§Ï†ï ÏôÑÎ£å');setValue('author_email',row.author_email||'');setValue('author_gender',row.author_gender||'');if(row.birth_date){try{if(typeof row.birth_date==='string'&&row.birth_date.length===10){setValue('birth_date',row.birth_date);}else{const birthDate=new Date(row.birth_date);setValue('birth_date',birthDate.toISOString().split('T')[0]);}}catch(e){console.error('birth_date Î≥ÄÌôò Ïò§Î•ò:',e);setValue('birth_date','');}}else{setValue('birth_date','');}
if(row.birth_datetime){try{const birthDatetime=new Date(row.birth_datetime);setValue('birth_datetime',birthDatetime.toISOString().slice(0,16));}catch(e){console.error('birth_datetime Î≥ÄÌôò Ïò§Î•ò:',e);setValue('birth_datetime','');}}else{setValue('birth_datetime','');}
setNumberValue('birth_hour',row.birth_hour);setNumberValue('birth_minute',row.birth_minute);setValue('snsgu',row.snsgu||'');setNumberValue('choice1',row.choice1);setNumberValue('choice2',row.choice2);setNumberValue('choice3',row.choice3);setNumberValue('choice4',row.choice4);setNumberValue('choice5',row.choice5);setNumberValue('choice6',row.choice6);setNumberValue('choice7',row.choice7);setNumberValue('choice8',row.choice8);setNumberValue('choice9',row.choice9);setNumberValue('choice10',row.choice10);setNumberValue('choice11',row.choice11);setNumberValue('choice12',row.choice12);setNumberValue('agreement',row.agreement!==undefined?row.agreement:0);setValue('smember_id',row.smember_id||'');setValue('admin_id',row.admin_id||'');setValue('ti_role',row.ti_role||'');setValue('post_pwd_hash','');setValue('has_admin_reply',row.has_admin_reply===true||row.has_admin_reply==='true'?'true':'false',);setValue('status',row.status||'OPEN');console.log('‚úÖ select Ìï®Ïàò ÏôÑÎ£å - Î™®Îì† ÌïÑÎìú Ï±ÑÏõåÏßê');}
window['select']=select;function resetForm(){document.querySelectorAll('.form input, .form textarea').forEach((e)=>{if(e.type==='checkbox'){e.checked=false;}else if(e.type==='number'){e.value='';}else{e.value='';}});document.querySelectorAll('.form select').forEach((e)=>(e.selectedIndex=0));document.getElementById('ticket_id').value='';document.getElementById('agreement').value='0';document.getElementById('calendar_type').value='ÏñëÎ†•';document.getElementById('time_input_type').value='time';document.getElementById('status').value='OPEN';document.getElementById('yundal').value='false';document.getElementById('has_admin_reply').value='false';selected=null;document.querySelectorAll('#grid tr').forEach((r)=>r.classList.remove('selected'));}
window['resetForm']=resetForm;function collect(){const o={};document.querySelectorAll('.form input, .form textarea, .form select').forEach((e)=>{if(e.id==='ticket_id')return;const val=e.value;if(e.type==='number'){o[e.id]=val?parseInt(val):e.id==='agreement'?0:null;}else if(e.type==='checkbox'){o[e.id]=e.checked;}else if(e.type==='date'||e.type==='datetime-local'){o[e.id]=val||null;}else if(e.tagName==='SELECT'&&(e.id==='yundal'||e.id==='has_admin_reply')){o[e.id]=val==='true';}else{o[e.id]=val||'';}});return o;}
window['collect']=collect;async function save(){const ticketId=document.getElementById('ticket_id').value;const payload=window['collect']();if(!payload.title_masked||!payload.content_enc){window['showMessage']('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÄ ÌïÑÏàòÏûÖÎãàÎã§.',true);return;}
try{if(ticketId){window['showMessage']('ÏàòÏ†ï Ï§ë...',false);const updatePayload={title:payload.title_masked,content:payload.content_enc,author_name:payload.author_name,author_contact:payload.author_contact,};const res=await fetch(`${API_BASE}/${ticketId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(updatePayload),});const result=await res.json();if(!res.ok){throw new Error(result.error||'ÏàòÏ†ï Ïã§Ìå®');}
window['showMessage']('ÏàòÏ†ï ÏôÑÎ£å',false);}else{window['showMessage']('Ï∂îÍ∞Ä Ï§ë...',false);if(!payload.post_pwd_hash){showMessage('Í≤åÏãúÍ∏Ä ÎπÑÎ∞ÄÎ≤àÌò∏Îäî ÌïÑÏàòÏûÖÎãàÎã§.',true);return;}
const createPayload={title:payload.title_masked,content:payload.content_enc,post_password:payload.post_pwd_hash,author_name:payload.author_name,author_nickname:payload.author_nickname,author_contact:payload.author_contact,author_email:payload.author_email,author_gender:payload.author_gender,snsgu:payload.snsgu||'A0001',smember_id:payload.smember_id||null,admin_id:payload.admin_id||null,ti_role:payload.ti_role||null,agreement:payload.agreement||0,};const res=await fetch(API_BASE,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(createPayload),});const result=await res.json();if(!res.ok){throw new Error(result.error||'Ï∂îÍ∞Ä Ïã§Ìå®');}
window['showMessage']('Ï∂îÍ∞Ä ÏôÑÎ£å',false);window['resetForm']();}
await window['load']();}catch(err){console.error('Ï†ÄÏû• Ïò§Î•ò:',err);window['showMessage'](`Ï†ÄÏû• Ïò§Î•ò: ${err.message}`,true);}}
window['save']=save;async function remove(){const ticketId=document.getElementById('ticket_id').value;if(!ticketId){window['showMessage']('ÏÇ≠Ï†úÌï† Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.',true);return;}
if(!confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')){return;}
try{window['showMessage']('ÏÇ≠Ï†ú Ï§ë...',false);const res=await fetch(`${API_BASE}/${ticketId}`,{method:'DELETE',});const result=await res.json();if(!res.ok){throw new Error(result.error||'ÏÇ≠Ï†ú Ïã§Ìå®');}
window['showMessage']('ÏÇ≠Ï†ú ÏôÑÎ£å',false);window['resetForm']();await window['load']();}catch(err){console.error('ÏÇ≠Ï†ú Ïò§Î•ò:',err);window['showMessage'](`ÏÇ≠Ï†ú Ïò§Î•ò: ${err.message}`,true);}}
window['remove']=remove;document.addEventListener('DOMContentLoaded',function(){document.querySelectorAll('th[data-sort]').forEach((th)=>{th.addEventListener('click',function(){window['sortData'](this.dataset.sort);});});window['load']();});