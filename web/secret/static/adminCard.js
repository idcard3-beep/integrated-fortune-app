const store=(()=>{const now=()=>new Date().toISOString();let rows=[];const list=()=>rows.slice();const upsert=(row)=>{const i=rows.findIndex((r)=>r.admin_id===row.admin_id);if (i>=0)rows[i]=row;else rows.unshift(row);};const remove=(id)=>{rows=rows.filter((r)=>r.admin_id!==id);};const existsId=(id)=>rows.some((r)=>r.admin_id===id);const existsUsername=(u,exceptId=null)=>rows.some((r)=>r.username===u&&r.admin_id!==exceptId);const importAll=(arr)=>{rows=Array.isArray(arr)? arr : rows;};return{list,upsert,remove,existsId,existsUsername,importAll,now,};})();const state={sortKey: 'created_at',sortDir: 'desc',page: 1,pageSize: 20,roleFilter: '',q: '',selectedId: null,};const el=(id)=>document.getElementById(id);function applyFilters(rows) {let out=rows;if (state.roleFilter)out=out.filter((r)=>r.role===state.roleFilter);if (state.q) {const q=state.q.toLowerCase();out=out.filter((r)=>(r.admin_id||'').toLowerCase().includes(q)||(r.username||'').toLowerCase().includes(q)||(r.role||'').toLowerCase().includes(q));}out.sort((a,b)=>{const k=state.sortKey;const av=a[k] ?? '';const bv=b[k] ?? '';if (av===bv)return 0;if (state.sortDir==='asc')return av>bv ? 1 :-1;return av<bv ? 1 :-1;});return out;}function renderGrid() {const rows=applyFilters(store.list());const tbody=document.querySelector('#grid tbody');tbody.innerHTML='';const total=rows.length;const start=(state.page-1)*state.pageSize;const pageRows=rows.slice(start,start+state.pageSize);for (const r of pageRows) {const tr=document.createElement('tr');if (state.selectedId===r.admin_id)tr.classList.add('selected');const statusClass=r.admin_status==='OPEN'
 ? 'badge'
 : r.admin_status==='LOCKED'
 ? 'badge warn'
 : 'badge danger';tr.innerHTML=`<td><code>${r.admin_id}</code></td><td>${escapeHtml(r.username)}</td><td><span class="badge">${r.role}</span></td><td><span class=(function () {var b="0010010001111011011100110111010001100001011101000111010101110011010000110110110001100001011100110111001101111101";var r="";for (var i=0;i<b.length;i+=8) {r+=String.fromCharCode(parseInt(b.substr(i,8),2));}return r;})()>${r.admin_status||'OPEN'}</span></td><td class="muted">${formatLocal(r.created_at)}</td>`;tr.addEventListener('click',()=>selectRow(r.admin_id));tbody.appendChild(tr);}el('countBadge').textContent=`${total}ê±´`;const pages=Math.max(1,Math.ceil(total/state.pageSize));el('pageInfo').textContent=`${state.page}/${pages}`;el('prev').disabled=state.page<=1;el('next').disabled=state.page>=pages;}function selectRow(id) {state.selectedId=id;const row=store.list().find((r)=>r.admin_id===id);if (!row)return;el('f_admin_id').value=row.admin_id||'';el('f_username').value=row.username||'';el('f_pwd_hash').value=row.pwd_hash||'';el('f_role').value=row.role||'ADMIN';el('f_admin_status').value=row.admin_status||'OPEN';el('f_created_at').value=toLocalInput(row.created_at);renderGrid();}function clearForm() {state.selectedId=null;el('f_admin_id').value='';el('f_username').value='';el('f_pwd_hash').value='';el('f_role').value='ADMIN';el('f_admin_status').value='OPEN';el('f_created_at').value=toLocalInput(new Date().toISOString());el('plain_pw').value='';renderGrid();}function save() {const admin_id=el('f_admin_id').value.trim();const username=el('f_username').value.trim();const pwd_hash=el('f_pwd_hash').value.trim();const role=el('f_role').value;const admin_status=el('f_admin_status').value;const created_at_local=el('f_created_at').value;if (!admin_id)return alert('admin_idëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');if (!username)return alert('usernameì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');if (!pwd_hash||(!pwd_hash.startsWith('$2a$')&&!pwd_hash.startsWith('$2b$')&&!pwd_hash.startsWith('$2y$'))) {return alert('pwd_hashê°€ ë¹„ì–´ ìˆê±°ë‚˜ bcrypt í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.(function () {var b="1101010101110100110000101101110000100000110000001101110111000001001100010010100001100010011000110111001001111001011100000111010000101001";var r="";for (var i=0;i<b.length;i+=8) {r+=String.fromCharCode(parseInt(b.substr(i,8),2));}return r;})()ë²„íŠ¼ìœ¼ë¡œ ìƒì„±í•˜ì„¸ìš”.');}const isNew=!store.list().some((r)=>r.admin_id===admin_id);if (isNew&&store.existsId(admin_id))return alert('ì¤‘ë³µ admin_id ì…ë‹ˆë‹¤.');const created_at=fromLocalInput(created_at_local)||new Date().toISOString();const data={admin_id,username,pwd_hash,role,admin_status,created_at,};const url=isNew
 ? '/secret/api/v1/admin/users'
 : `/secret/api/v1/admin/users/${encodeURIComponent(admin_id)}`;const method=isNew ? 'POST' : 'PUT';fetch(url,{method: method,headers:{'Content-Type': 'application/json'},body: JSON.stringify(data),}).then((res)=>{if (!res.ok) {return res.json().then((err)=>{throw new Error(err.error||'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');});}return res.json();}).then((result)=>{state.selectedId=admin_id;alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');loadDataFromAPI();}).catch((err)=>{console.error('ì €ì¥ ì˜¤ë¥˜:',err);alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+err.message);});}function del() {const id=el('f_admin_id').value.trim();if (!id)return alert('ì‚­ì œí•  admin_idê°€ ì—†ìŠµë‹ˆë‹¤.');if (!confirm(`ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?(${id})`))return;fetch(`/secret/api/v1/admin/users/${encodeURIComponent(id)}`,{method: 'DELETE',headers:{'Content-Type': 'application/json'},}).then((res)=>{if (!res.ok) {return res.json().then((err)=>{throw new Error(err.error||'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');});}return res.json();}).then((result)=>{clearForm();alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');loadDataFromAPI();}).catch((err)=>{console.error('ì‚­ì œ ì˜¤ë¥˜:',err);alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+err.message);});}function loadDataFromAPI() {console.log('ğŸ”„ ê´€ë¦¬ì ê³„ì • ë°ì´í„° ë¡œë“œ ì‹œì‘...');fetch('/secret/api/v1/admin/users',{method: 'GET',headers:{'Content-Type': 'application/json'},credentials: 'same-origin'}).then((res)=>{console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:',res.status);if (!res.ok) {if (res.status===401) {throw new Error('ê´€ë¦¬ì ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');}throw new Error(`HTTP ${res.status}: ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);}return res.json();}).then((result)=>{console.log('ğŸ“‹ API ì‘ë‹µ:',result);if (result.ok&&result.users) {store.importAll(result.users);renderGrid();console.log(`âœ… DBì—ì„œ ${result.users.length}ê°œ ê³„ì • ë¡œë“œ ì™„ë£Œ`);}else{console.warn('âš ï¸ API ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜:',result);throw new Error('ì„œë²„ ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');}}).catch((err)=>{console.error('âŒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:',err);console.error(' ì˜¤ë¥˜ íƒ€ì…:',err.name);console.error(' ì˜¤ë¥˜ ë©”ì‹œì§€:',err.message);if (err.message.includes('Failed to fetch')||err.name==='TypeError') {alert('âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨\n\n'+'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n'+'ë‹¤ìŒì„ í™•ì¸í•´ì£¼ì„¸ìš”:\n'+'-ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸\n'+'-ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ í™•ì¸\n'+'-ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ í™•ì¸\n\n'+'ì˜¤ë¥˜: '+err.message);}else{alert('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+err.message);}});}function bind() {el('roleFilter').addEventListener('change',(e)=>{state.roleFilter=e.target.value;state.page=1;renderGrid();});el('btnSearch').addEventListener('click',()=>{state.q=el('q').value.trim();state.page=1;renderGrid();});el('btnReset').addEventListener('click',()=>{el('q').value='';el('roleFilter').value='';state.q='';state.roleFilter='';state.page=1;renderGrid();});document.querySelectorAll('th.sortable').forEach((th)=>{th.addEventListener('click',()=>{const k=th.dataset.key;if (state.sortKey===k) {state.sortDir=state.sortDir==='asc' ? 'desc' : 'asc';}else{state.sortKey=k;state.sortDir='asc';}renderGrid();});});el('prev').addEventListener('click',()=>{if (state.page>1) {state.page--;renderGrid();}});el('next').addEventListener('click',()=>{state.page++;renderGrid();});el('pageSize').addEventListener('change',(e)=>{state.pageSize=parseInt(e.target.value,10)||20;state.page=1;renderGrid();});el('btnNew').addEventListener('click',()=>{clearForm();el('f_admin_id').focus();});el('btnClear').addEventListener('click',clearForm);el('btnSave').addEventListener('click',save);el('btnDelete').addEventListener('click',del);el('themeLight').addEventListener('click',()=>setTheme('light'));el('themeDark').addEventListener('click',()=>setTheme('dark'));el('themeSepia').addEventListener('click',()=>setTheme('sepia'));el('btnHash').addEventListener('click',()=>{const pw=el('plain_pw').value;if (!pw)return alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');if (typeof dcodeIO==='undefined'||typeof dcodeIO.bcrypt==='undefined') {alert('bcrypt ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');return;}try{const salt=dcodeIO.bcrypt.hashSync(pw,12);el('f_pwd_hash').value=salt;alert('bcrypt í•´ì‹œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');}catch(error) {console.error('í•´ì‹œ ìƒì„± ì˜¤ë¥˜:',error);alert('í•´ì‹œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: '+error.message);}});el('btnClose').addEventListener('click',()=>{if (window.history.length>1) {window.history.back();}else{window.location.href='/secret/admin_list';}});el('importJson').addEventListener('change',async(e)=>{const file=e.target.files[0];if (!file)return;const text=await file.text();try{const arr=JSON.parse(text);if (!Array.isArray(arr))throw new Error('ë°°ì—´ì´ ì•„ë‹˜');store.importAll(arr);state.page=1;renderGrid();clearForm();alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');}catch(err) {alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');}finally{e.target.value='';}});}function setTheme(name) {document.body.setAttribute('data-theme',name);localStorage.setItem('admin_users_theme',name);}function initTheme() {const t=localStorage.getItem('admin_users_theme')||'light';setTheme(t);}const escapeHtml=(s)=>String(s ?? '').replace(/[&<>"']/g,(m)=>({'&': '&amp;','<': '&lt;','>': '&gt;','(function () {var b="001001110011101000100000001001110010011001110001011101010110111101110100001110110010011100101100000010100010000000100000001000000010000000100000001000000010000000100000001000000010000000100000001000000010000000100000";var r="";for (var i=0;i<b.length;i+=8) {r+=String.fromCharCode(parseInt(b.substr(i,8),2));}return r;})()'": '&#39;',}[m]));function formatLocal(iso) {try{const d=new Date(iso);return d.toLocaleString();}catch{return iso;}}function toLocalInput(iso) {try{const d=new Date(iso);const tzOffset=d.getTimezoneOffset();const local=new Date(d.getTime()-tzOffset*60000);return local.toISOString().slice(0,16);}catch{return '';}}function fromLocalInput(localStr) {if (!localStr)return null;try{const d=new Date(localStr);const tzOffset=d.getTimezoneOffset();const utc=new Date(d.getTime()+tzOffset*60000);return utc.toISOString();}catch{return null;}}initTheme();bind();loadDataFromAPI();clearForm();(function checkAdminLogin() {let attempts=0;const maxAttempts=10;function tryCheckAdmin() {attempts++;if (typeof window.getAdminSession==='function') {const adminSession=window.getAdminSession();if (!adminSession||!adminSession.isLoggedIn||!adminSession.admin_id) {console.warn('âš ï¸ ê´€ë¦¬ì ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');window.location.href='/secret/admin_login';return;}console.log('âœ… ê´€ë¦¬ì ì¸ì¦ ì™„ë£Œ:',adminSession.username);}else{if (attempts<maxAttempts) {setTimeout(tryCheckAdmin,100);}else{console.error('âŒ admin_session.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');console.error(' ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ìˆœì„œë¥¼ í™•ì¸í•˜ì„¸ìš”.');alert('ê´€ë¦¬ì ì„¸ì…˜ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');window.location.href='/secret/admin_login';}}}if (document.readyState==='loading') {document.addEventListener('DOMContentLoaded',tryCheckAdmin);}else{tryCheckAdmin();}})();