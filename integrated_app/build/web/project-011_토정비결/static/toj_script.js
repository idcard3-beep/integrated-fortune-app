(()=>{const CHEONGAN=['갑(甲)','을(乙)','병(丙)','정(丁)','무(戊)','기(己)','경(庚)','신(辛)','임(壬)','계(癸)',];const JIJI=['자(子)','축(丑)','인(寅)','묘(卯)','진(辰)','사(巳)','오(午)','미(未)','신(申)','유(酉)','술(戌)','해(亥)',];const OHAENG={'갑(甲)':'목(木)','을(乙)':'목(木)','병(丙)':'화(火)','정(丁)':'화(火)','무(戊)':'토(土)','기(己)':'토(土)','경(庚)':'금(金)','신(辛)':'금(金)','임(壬)':'수(水)','계(癸)':'수(水)',};const JIJI_OHAENG={'자(子)':'수(水)','축(丑)':'토(土)','인(寅)':'목(木)','묘(卯)':'목(木)','진(辰)':'토(土)','사(巳)':'화(火)','오(午)':'화(火)','미(未)':'토(土)','신(申)':'금(金)','유(酉)':'금(金)','술(戌)':'토(土)','해(亥)':'수(水)',};const SIBIJISIN={子:'쥐',丑:'소',寅:'호랑이',卯:'토끼',辰:'용',巳:'뱀',午:'말',未:'양',申:'원숭이',酉:'닭',戌:'개',亥:'돼지',};const ALL_BIGYEOL={1:{name:'건위천(乾爲天)',hanja:'乾爲天',fortune:'대길(大吉)',score:95,summary:'하늘이 두 겹...',detailed:'천(天)이 겹친...',element:'금(金)',season:'가을',yearly:{spring:'새로운 시작이 매우 좋습니다.',summer:'왕성한 기운',autumn:'결실',winter:'휴식',},fortune_detail:{wealth:'재물운이 매우 왕성합니다.',career:'승진 기회',health:'과로 주의',relationship:'대인관계 원만',love:'적극적으로',},caution:'겸손을 잃지 마십시오.',advice:'자강불식하십시오.',},2:{name:'곤위지(坤爲地)',hanja:'坤爲地',fortune:'길(吉)',score:85,summary:'대지의 포용력',detailed:'지(地)가 겹친...',element:'토(土)',season:'사계절',yearly:{spring:'씨앗을 심음',summer:'성장',autumn:'수확',winter:'내실',},fortune_detail:{wealth:'꾸준히 모음',career:'협력 중요',health:'소화 주의',relationship:'포용력',love:'수용적',},caution:'소극성 경계',advice:'두터운 덕으로.',},};let lunarText;function getGapja(year){const baseYear=1924;const yearDiff=year-baseYear;const cheonganIdx=((yearDiff%10)+10)%10;const jijiIdx=((yearDiff%12)+12)%12;return{cheongan:CHEONGAN[cheonganIdx],jiji:JIJI[jijiIdx]};}
function getMonthGapja(year,month){const yearGapja=getGapja(year);const cheonganIdx=CHEONGAN.indexOf(yearGapja.cheongan);const monthJiji=['인(寅)','묘(卯)','진(辰)','사(巳)','오(午)','미(未)','신(申)','유(酉)','술(戌)','해(亥)','자(子)','축(丑)',];const monthCheonganBase={0:2,1:4,2:6,3:8,4:0,5:2,6:4,7:6,8:8,9:0,};const baseIdx=Math.floor(cheonganIdx/2)*2;const startIdx=monthCheonganBase[baseIdx]??0;const monthCheonganIdx=(startIdx+(month-1))%10;return{cheongan:CHEONGAN[monthCheonganIdx],jiji:monthJiji[month-1]};}
function getDayGapja(year,month,day){const baseDate=new Date(1924,0,1);const targetDate=new Date(year,month-1,day);const msPerDay=1000*60*60*24;const dayDiff=Math.floor((targetDate-baseDate)/msPerDay);const cheonganIdx=((dayDiff%10)+10)%10;const jijiIdx=((dayDiff%12)+12)%12;return{cheongan:CHEONGAN[cheonganIdx],jiji:JIJI[jijiIdx]};}
function getHourGapja(dayCheongan,hour){if(hour===''||hour===null||typeof hour==='undefined')
return null;const hourIdx=Math.floor(parseInt(hour)/2)%12;const hourJiji=JIJI[hourIdx];const dayIdx=CHEONGAN.indexOf(dayCheongan);const hourCheonganBase={0:0,1:2,2:4,3:6,4:8,5:0,6:2,7:4,8:6,9:8,};const baseIdx=Math.floor(dayIdx/2)*2;const startIdx=hourCheonganBase[baseIdx]??0;const hourCheonganIdx=(startIdx+hourIdx)%10;return{cheongan:CHEONGAN[hourCheonganIdx],jiji:hourJiji};}
function calculateTojeongGwae(year,month,day,hour,gender){const y=parseInt(year)%100;const m=parseInt(month);const d=parseInt(day);const h=hour!==''&&hour!==null?Math.floor(parseInt(hour)/2):6;const g=gender==='male'?1:2;const sum=(y*3+m*5+d*7+h*2+g)%64;return sum===0?64:sum;}
function getGanjiValue(year){const base=1924;const diff=year-base;const ganIdx=((diff%10)+10)%10;const jiIdx=((diff%12)+12)%12;const ganValue=ganIdx+1;const jiValue=jiIdx+1;return ganValue+jiValue;}
function calculateYearGwae(birthGwaeNum,yearToView){const gv=getGanjiValue(yearToView);const result=(birthGwaeNum+gv)%64;return result===0?64:result;}
const form=document.getElementById('sajuForm');const resultWrap=document.getElementById('resultWrap');const sajuDisplay=document.getElementById('sajuDisplay');const gwaeBlock=document.getElementById('gwaeBlock');const isLunarRadios=document.getElementsByName('isLunar');const leapMonthField=document.getElementById('leapMonthField');isLunarRadios.forEach((radio)=>{radio.addEventListener('change',()=>{if(radio.value==='lunar'&&radio.checked){leapMonthField.style.display='block';}else{leapMonthField.style.display='none';document.getElementById('isLeapMonth').checked=false;}});});form.addEventListener('submit',(ev)=>{ev.preventDefault();const year=document.getElementById('year').value.trim();const month=document.getElementById('month').value.trim();const day=document.getElementById('day').value.trim();const hour=document.getElementById('hour').value;const gender=form.gender.value==='male'?'male':'female';const isLunar=form.isLunar.value;const isLeapMonth=document.getElementById('isLeapMonth').checked;const yearToView=document.getElementById('yearToView').value.trim();if(!year||!month||!day){alert('생년월일을 모두 입력해주세요.');return;}
if(!yearToView){alert('조회년도를 입력해주세요.');return;}
const hourStr=hour?String(hour).padStart(2,'0'):'00';const birthStr=`${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}${hourStr}:00`;function handleSajuResult(sajuResult,actualYear,actualMonth,actualDay,inputYear,inputMonth,inputDay,inputIsLunar){console.log('===== 사주 API 응답 =====');console.log('원본 sajuResult:',sajuResult);console.log('실제 사용 날짜(양력):',actualYear,actualMonth,actualDay);console.log('입력 날짜:',inputYear,inputMonth,inputDay,inputIsLunar);if(sajuResult.error){alert('사주 계산 오류: '+sajuResult.error);return;}
if(!sajuResult.year||!sajuResult.month||!sajuResult.day){alert('사주 데이터가 올바르지 않습니다.');console.error('잘못된 사주 데이터:',sajuResult);return;}
lunarText=sajuResult.lunar;const yearGapja={cheongan:sajuResult.year[0],jiji:sajuResult.year[1],};const monthGapja={cheongan:sajuResult.month[0],jiji:sajuResult.month[1],};const dayGapja={cheongan:sajuResult.day[0],jiji:sajuResult.day[1]};const hourGapja=sajuResult.hour?{cheongan:sajuResult.hour[0],jiji:sajuResult.hour[1]}:null;console.log('파싱된 사주:');console.log('년주:',yearGapja);console.log('월주:',monthGapja);console.log('일주:',dayGapja);console.log('시주:',hourGapja);const gwaeNum=calculateTojeongGwae(parseInt(actualYear),parseInt(actualMonth),parseInt(actualDay),hour,gender);fetch('/toj/api/toj64.json').then((res)=>res.json()).then((json)=>{let gwaeData=null;let yearGwaeData=null;let yearGwaeNum=null;if(json.BIGYEOL_64GWE){gwaeData=json.BIGYEOL_64GWE[String(gwaeNum).trim()];yearGwaeNum=calculateYearGwae(gwaeNum,parseInt(yearToView));yearGwaeData=json.BIGYEOL_64GWE[String(yearGwaeNum).trim()];}
if(!gwaeData){gwaeData={name:`제 ${gwaeNum}괘`,fortune:'정보없음',score:'?',summary:'상세 데이터가 없습니다.',};}
if(!yearGwaeData){yearGwaeData={name:`제 ${yearGwaeNum}괘`,fortune:'정보없음',score:'?',summary:'상세 데이터가 없습니다.',};}
renderSaju({year:yearGapja,month:monthGapja,day:dayGapja,hour:hourGapja,yearAnimal:SIBIJISIN[yearGapja.jiji]||'',},{solarYear:actualYear,solarMonth:actualMonth,solarDay:actualDay,inputYear:inputYear,inputMonth:inputMonth,inputDay:inputDay,gender,isLunar:inputIsLunar,yearToView,},gwaeNum,gwaeData,yearGwaeNum,yearGwaeData);}).catch((err)=>{console.error('fetch 실패:',err);const gwaeData={name:`제 ${gwaeNum}괘`,fortune:'정보없음',score:'?',summary:'상세 데이터가 없습니다.',};const yearGwaeData={name:`제?괘`,fortune:'정보없음',score:'?',summary:'상세 데이터가 없습니다.',};renderSaju({year:yearGapja,month:monthGapja,day:dayGapja,hour:hourGapja,yearAnimal:SIBIJISIN[yearGapja.jiji]||'',},{solarYear:actualYear,solarMonth:actualMonth,solarDay:actualDay,inputYear:inputYear,inputMonth:inputMonth,inputDay:inputDay,gender,isLunar:inputIsLunar,yearToView,},gwaeNum,gwaeData,null,yearGwaeData);});}
if(isLunar==='lunar'){fetch(`/toj/convert_lunar_to_solar?year=${year}&month=${month}&day=${day}&is_leap=${isLeapMonth}`).then((res)=>res.json()).then((data)=>{if(data.error){alert('음력 변환 오류: '+data.error);return;}
const solarBirthStr=`${data.year}-${String(data.month).padStart(2,'0')}-${String(data.day).padStart(2,'0')}${hourStr}:00`;fetch(`/toj/calc_saju?birth_str=${encodeURIComponent(solarBirthStr)}`).then((res)=>res.json()).then((sajuResult)=>handleSajuResult(sajuResult,data.year,data.month,data.day,year,month,day,isLunar)).catch((err)=>{console.error('사주 API 호출 실패:',err);alert('사주 계산 중 오류가 발생했습니다.');});}).catch((err)=>{console.error('음력 변환 실패:',err);alert('음력 변환 중 오류가 발생했습니다.');});}else{fetch(`/toj/calc_saju?birth_str=${encodeURIComponent(birthStr)}`).then((res)=>res.json()).then((sajuResult)=>handleSajuResult(sajuResult,year,month,day,year,month,day,isLunar)).catch((err)=>{console.error('사주 API 호출 실패:',err);alert('사주 계산 중 오류가 발생했습니다.');});}});function renderSaju(sajuInfo,birthInfo,gwaeNum,gwaeData,yearGwaeNum,yearGwaeData){resultWrap.classList.remove('hidden');sajuDisplay.innerHTML='';const createSajuItem=(label,top,bot,extra)=>{const div=document.createElement('div');div.className='saju-item';div.innerHTML=`<div class="label">${label}</div><div class="big">${top||'?'}</div><div class="big">${bot||''}</div>${extra?`<div style="margin-top:6px;color:#cfc0f5;font-size:13px">${extra}</div>`:''}`;return div;};if(sajuInfo.hour){sajuDisplay.appendChild(createSajuItem('時柱 시주',sajuInfo.hour.cheongan,sajuInfo.hour.jiji));}else{sajuDisplay.appendChild(createSajuItem('時柱 시주','?','시간 미상'));}
sajuDisplay.appendChild(createSajuItem('日柱 일주',sajuInfo.day.cheongan,sajuInfo.day.jiji));sajuDisplay.appendChild(createSajuItem('月柱 월주',sajuInfo.month.cheongan,sajuInfo.month.jiji));sajuDisplay.appendChild(createSajuItem('年柱 연주',sajuInfo.year.cheongan,sajuInfo.year.jiji,sajuInfo.yearAnimal+'띠'));let solarInfo,lunarInfo;if(birthInfo.isLunar==='solar'){solarInfo={year:birthInfo.inputYear,month:birthInfo.inputMonth,day:birthInfo.inputDay,type:'양력정보',};if(lunarText){const lunarMatch=lunarText.match(/(\d+)\.(\d+)\.(\d+)/);if(lunarMatch){lunarInfo={year:`음력 ${lunarMatch[1]}`,month:lunarMatch[2],day:lunarMatch[3],type:'음력정보',};}else{lunarInfo={year:'음력',month:lunarText,day:'',type:'음력정보',};}}else{lunarInfo={year:'음력',month:'변환',day:'실패',type:'음력정보',};}}else{lunarInfo={year:birthInfo.inputYear,month:birthInfo.inputMonth,day:birthInfo.inputDay,type:'음력정보',};solarInfo={year:birthInfo.solarYear,month:birthInfo.solarMonth,day:birthInfo.solarDay,type:'양력정보',};}
const firstInfo=birthInfo.isLunar==='solar'?solarInfo:lunarInfo;const secondInfo=birthInfo.isLunar==='solar'?lunarInfo:solarInfo;const firstInfoDiv=document.createElement('div');firstInfoDiv.className='saju-item';firstInfoDiv.innerHTML=`<div class="label">${firstInfo.type}</div><div style="font-weight:700">${firstInfo.year}.${firstInfo.month}.${firstInfo.day}</div><div style="margin-top:6px">${birthInfo.gender==='male'?'乾命 남자':'坤命 여자'}</div><div style="margin-top:6px">입력정보</div>`;sajuDisplay.appendChild(firstInfoDiv);const secondInfoDiv=document.createElement('div');secondInfoDiv.className='saju-item';secondInfoDiv.innerHTML=`<div class="label">${secondInfo.type}</div><div style="font-weight:700">${secondInfo.year}.${secondInfo.month}.${secondInfo.day}</div><div style="margin-top:6px">${birthInfo.gender==='male'?'乾命 남자':'坤命 여자'}</div><div style="margin-top:6px">${birthInfo.isLunar==='lunar'?'음력→양력':birthInfo.isLunar==='leap'?'윤달→양력':'양력→음력'}</div>`;sajuDisplay.appendChild(secondInfoDiv);gwaeBlock.innerHTML='';const title=document.createElement('div');title.className='gwae-title';title.textContent=`본괘(출생)-第 ${gwaeNum}卦 ${gwaeData.name||gwaeData.hanja||gwaeData.name}`;gwaeBlock.appendChild(title);if(gwaeData.hanja){const hanja=document.createElement('div');hanja.className='gwae-sub';hanja.textContent=gwaeData.hanja;gwaeBlock.appendChild(hanja);}
const fortuneRow=document.createElement('div');fortuneRow.style.display='flex';fortuneRow.style.alignItems='center';fortuneRow.style.gap='12px';fortuneRow.style.marginBottom='8px';const fortuneBox=document.createElement('div');fortuneBox.style.padding='8px 12px';fortuneBox.style.fontWeight='800';fortuneBox.style.borderRadius='10px';fortuneBox.style.background='#f59e0b';fortuneBox.textContent=gwaeData.fortune||'정보없음';const score=document.createElement('div');score.className='gwae-score';score.textContent=gwaeData.score!==undefined?`${gwaeData.score}점`:'? 점';fortuneRow.appendChild(fortuneBox);fortuneRow.appendChild(score);gwaeBlock.appendChild(fortuneRow);const sum=document.createElement('p');sum.style.color='#e8dcff';sum.style.marginBottom='8px';sum.textContent=gwaeData.summary||'';gwaeBlock.appendChild(sum);if(gwaeData.detailed){const det=document.createElement('div');det.style.background='rgba(255,255,255,0.02)';det.style.padding='10px';det.style.borderRadius='8px';det.style.marginBottom='8px';det.textContent=gwaeData.detailed;gwaeBlock.appendChild(det);}
if(gwaeData.yearly){const ybox=document.createElement('div');ybox.style.display='grid';ybox.style.gridTemplateColumns='repeat(2,1fr)';ybox.style.gap='8px';ybox.style.marginTop='8px';['spring','summer','autumn','winter'].forEach((se)=>{const cell=document.createElement('div');cell.style.padding='8px';cell.style.borderLeft='4px solid rgba(255,255,255,0.06)';cell.style.borderRadius='6px';cell.innerHTML=`<strong style="display:block;margin-bottom:6px">${se}</strong><div style="font-size:13px">${gwaeData.yearly[se]}</div>`;ybox.appendChild(cell);});gwaeBlock.appendChild(ybox);}
function getMonthlyFortune(gwaeData){const seasonMap={1:'winter',2:'winter',3:'spring',4:'spring',5:'spring',6:'summer',7:'summer',8:'summer',9:'autumn',10:'autumn',11:'autumn',12:'winter',};const monthly=[];for(let m=1;m<=12;m++){const season=seasonMap[m];monthly.push({month:m,season,text:gwaeData.yearly&&gwaeData.yearly[season]?gwaeData.yearly[season]:'정보없음',});}
return monthly;}
if(gwaeData.yearly){const monthlyFortune=getMonthlyFortune(gwaeData);const table=document.createElement('table');table.className='monthly-fortune-table';table.style.marginTop='16px';table.style.width='100%';table.style.background='rgba(255,255,255,0.03)';table.style.borderRadius='8px';table.style.fontSize='14px';const thead=document.createElement('thead');thead.innerHTML='<tr><th>월</th><th>계절</th><th>운세</th></tr>';table.appendChild(thead);const tbody=document.createElement('tbody');monthlyFortune.forEach((row)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${row.month}월</td><td>${row.season}</td><td>${row.text}</td>`;tbody.appendChild(tr);});table.appendChild(tbody);gwaeBlock.appendChild(table);}
if(gwaeData.fortune_detail){const fd=document.createElement('div');fd.style.marginTop='10px';fd.innerHTML=`<strong>분야별 운세</strong><ul style="margin:8px 0 0 16px;line-height:1.5;font-size:13px"><li>재물:${gwaeData.fortune_detail.wealth||'-'}</li><li>직업:${gwaeData.fortune_detail.career||'-'}</li><li>건강:${gwaeData.fortune_detail.health||'-'}</li><li>관계:${gwaeData.fortune_detail.relationship||'-'}</li><li>사랑:${gwaeData.fortune_detail.love||'-'}</li></ul>`;gwaeBlock.appendChild(fd);}
if(yearGwaeNum&&yearGwaeData){const yearTitle=document.createElement('div');yearTitle.className='gwae-title';yearTitle.style.marginTop='18px';yearTitle.textContent=`세운(${birthInfo.yearToView})-第 ${yearGwaeNum}卦 ${yearGwaeData.name||yearGwaeData.hanja||yearGwaeData.name}`;gwaeBlock.appendChild(yearTitle);if(yearGwaeData.hanja){const hanja=document.createElement('div');hanja.className='gwae-sub';hanja.textContent=yearGwaeData.hanja;gwaeBlock.appendChild(hanja);}
const fortuneRow=document.createElement('div');fortuneRow.style.display='flex';fortuneRow.style.alignItems='center';fortuneRow.style.gap='12px';fortuneRow.style.marginBottom='8px';const fortuneBox=document.createElement('div');fortuneBox.style.padding='8px 12px';fortuneBox.style.fontWeight='800';fortuneBox.style.borderRadius='10px';fortuneBox.style.background='#f59e0b';fortuneBox.textContent=yearGwaeData.fortune||'정보없음';const score=document.createElement('div');score.className='gwae-score';score.textContent=yearGwaeData.score!==undefined?`${yearGwaeData.score}점`:'? 점';fortuneRow.appendChild(fortuneBox);fortuneRow.appendChild(score);gwaeBlock.appendChild(fortuneRow);const sum=document.createElement('p');sum.style.color='#e8dcff';sum.style.marginBottom='8px';sum.textContent=yearGwaeData.summary||'';gwaeBlock.appendChild(sum);if(yearGwaeData.detailed){const det=document.createElement('div');det.style.background='rgba(255,255,255,0.02)';det.style.padding='10px';det.style.borderRadius='8px';det.style.marginBottom='8px';det.textContent=yearGwaeData.detailed;gwaeBlock.appendChild(det);}
if(yearGwaeData.fortune_detail){const fd=document.createElement('div');fd.style.marginTop='10px';fd.innerHTML=`<strong>분야별 운세</strong><ul style="margin:8px 0 0 16px;line-height:1.5;font-size:13px"><li>재물:${yearGwaeData.fortune_detail.wealth||'-'}</li><li>직업:${yearGwaeData.fortune_detail.career||'-'}</li><li>건강:${yearGwaeData.fortune_detail.health||'-'}</li><li>관계:${yearGwaeData.fortune_detail.relationship||'-'}</li><li>사랑:${yearGwaeData.fortune_detail.love||'-'}</li></ul>`;gwaeBlock.appendChild(fd);}
if(yearGwaeData.yearly){const ybox=document.createElement('div');ybox.style.display='grid';ybox.style.gridTemplateColumns='repeat(2,1fr)';ybox.style.gap='8px';ybox.style.marginTop='8px';['spring','summer','autumn','winter'].forEach((se)=>{const cell=document.createElement('div');cell.style.padding='8px';cell.style.borderLeft='4px solid rgba(255,255,255,0.06)';cell.style.borderRadius='6px';cell.innerHTML=`<strong style="display:block;margin-bottom:6px">${se}</strong><div style="font-size:13px">${yearGwaeData.yearly[se]}</div>`;ybox.appendChild(cell);});gwaeBlock.appendChild(ybox);}
if(yearGwaeData.yearly){const monthlyFortune=getMonthlyFortune(yearGwaeData);const table=document.createElement('table');table.className='monthly-fortune-table';table.style.marginTop='16px';table.style.width='100%';table.style.background='rgba(255,255,255,0.03)';table.style.borderRadius='8px';table.style.fontSize='14px';const thead=document.createElement('thead');thead.innerHTML='<tr><th>월</th><th>계절</th><th>운세</th></tr>';table.appendChild(thead);const tbody=document.createElement('tbody');monthlyFortune.forEach((row)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${row.month}월</td><td>${row.season}</td><td>${row.text}</td>`;tbody.appendChild(tr);});table.appendChild(tbody);gwaeBlock.appendChild(table);}}}})();